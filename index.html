<script>
  const totalTracks = 315;
  const trackListEl = document.getElementById("trackList");
  const audioPlayer = document.getElementById("audioPlayer");

  let playlist = [];
  let currentIndex = 0;
  let repeatEach = 1;
  let repeatCounter = 0;

  // Generate groups
  function generateGroups() {
    const groupDiv = document.getElementById("groups");
    for (let i = 1; i <= totalTracks; i += 10) {
      const end = Math.min(i + 9, totalTracks);
      const btn = document.createElement("button");
      btn.textContent = `${i}–${end}`;
      btn.className = "px-3 py-1 m-1 bg-gray-200 rounded";
      btn.onclick = () => selectGroup(i, end);
      groupDiv.appendChild(btn);
    }
  }

  // Generate tracks
  function generateTracks() {
    for (let i = 1; i <= totalTracks; i++) {
      const li = document.createElement("li");
      li.innerHTML = `
        <label class="block p-2 bg-white rounded shadow-sm">
          <input type="checkbox" value="${i}" class="trackBox mr-2"> Shlok ${i}
        </label>`;
      trackListEl.appendChild(li);
    }
  }

  // Reset search filter on load
  function resetSearch() {
    document.getElementById("search").value = "";
    document.querySelectorAll(".trackBox").forEach(cb => {
      cb.parentElement.parentElement.classList.remove("hidden");
    });
  }

  // Search filter
  document.getElementById("search").addEventListener("input", function () {
    const term = this.value.trim();
    document.querySelectorAll(".trackBox").forEach(cb => {
      const label = cb.parentElement.parentElement;
      if (!term || cb.value === term) {
        label.classList.remove("hidden");
      } else {
        label.classList.add("hidden");
      }
    });
  });

  // Select group
  function selectGroup(start, end) {
    document.querySelectorAll(".trackBox").forEach(cb => {
      if (cb.value >= start && cb.value <= end) cb.checked = true;
    });
  }

  // Select range
  function selectRange() {
    const start = parseInt(document.getElementById("rangeStart").value);
    const end = parseInt(document.getElementById("rangeEnd").value);
    if (!isNaN(start) && !isNaN(end) && start <= end) {
      document.querySelectorAll(".trackBox").forEach(cb => {
        if (cb.value >= start && cb.value <= end) cb.checked = true;
      });
    }
  }

  // Playback speed
  function changeSpeed(delta) {
    let speed = parseFloat(audioPlayer.playbackRate) + delta;
    if (speed < 0.5) speed = 0.5;
    if (speed > 1.5) speed = 1.5;
    audioPlayer.playbackRate = speed;
    document.getElementById("speedDisplay").textContent = speed.toFixed(1);
  }

  // Play selected
  function playSelected() {
    const selected = Array.from(document.querySelectorAll(".trackBox:checked")).map(cb => parseInt(cb.value));
    if (selected.length === 0) return;

    repeatEach = parseInt(document.getElementById("repeatCount").value) || 1;
    playlist = [...selected];
    if (document.getElementById("shuffle").checked) {
      playlist = playlist.sort(() => Math.random() - 0.5);
    }
    currentIndex = 0;
    repeatCounter = 0;
    saveSelection(selected);
    playCurrent();
  }

  function playCurrent() {
    if (currentIndex >= playlist.length) {
      if (document.getElementById("repeatPlaylist").checked) {
        currentIndex = 0;
      } else return;
    }
    const trackNum = playlist[currentIndex];
    audioPlayer.src = `https://ia601703.us.archive.org/35/items/satsang_diksha/sanskrit_${String(trackNum).padStart(3, '0')}.mp3`;
    audioPlayer.play();
  }

  audioPlayer.addEventListener("ended", () => {
    repeatCounter++;
    if (repeatCounter < repeatEach) {
      playCurrent();
    } else {
      repeatCounter = 0;
      currentIndex++;
      playCurrent();
    }
  });

  // Save & render history
  function saveSelection(selection) {
    let history = JSON.parse(localStorage.getItem("recentSelections")) || [];
    const selString = selection.join(",");
    history = [selString, ...history.filter(h => h !== selString)].slice(0, 5);
    localStorage.setItem("recentSelections", JSON.stringify(history));
    renderRecentSelections();
  }

  function renderRecentSelections() {
    const history = JSON.parse(localStorage.getItem("recentSelections")) || [];
    const recentDiv = document.getElementById("recentlyPlayed");
    const recentList = document.getElementById("recentList");
    recentList.innerHTML = "";

    if (history.length === 0) {
      recentDiv.classList.add("hidden");
      return;
    }

    recentDiv.classList.remove("hidden");
    history.forEach(sel => {
      const numbers = sel.split(",").map(n => parseInt(n.trim()));
      const count = numbers.length;
      let label = "";

      if (count <= 6) {
        label = "Shlok " + numbers.join(", ");
      } else {
        label = `Shlok ${numbers[0]}–${numbers[numbers.length - 1]} (${count} total)`;
      }

      const li = document.createElement("li");
      const btn = document.createElement("button");
      btn.textContent = label;
      btn.className = "px-2 py-1 bg-blue-500 text-white rounded text-xs";
      btn.onclick = () => replaySelection(sel);
      li.appendChild(btn);
      recentList.appendChild(li);
    });
  }

  function replaySelection(sel) {
    const selected = sel.split(",").map(n => parseInt(n.trim()));
    document.querySelectorAll(".trackBox").forEach(cb => {
      cb.checked = selected.includes(parseInt(cb.value));
    });
    playSelected();
  }

  // Restore last selection on load
  function restoreLastSelection() {
    const history = JSON.parse(localStorage.getItem("recentSelections")) || [];
    if (history.length > 0) {
      const lastSel = history[0].split(",").map(n => parseInt(n.trim()));
      document.querySelectorAll(".trackBox").forEach(cb => {
        cb.checked = lastSel.includes(parseInt(cb.value));
      });
    }
  }

  // Init
  generateGroups();
  generateTracks();
  resetSearch();
  renderRecentSelections();
  restoreLastSelection();
</script>
