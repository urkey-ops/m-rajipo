<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shloka Audio Player & Quiz Utility</title>
    <style>
        /* Base styles using a simple, modern look */
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #607D8B; /* Blue Grey */
            --red-color: #F44336; /* Red */
            --bg-color: #2c2c2c; /* Dark background */
            --card-color: #3b3b3b; /* Slightly lighter card color */
            --text-color: #ffffff;
            --border-radius: 8px;
            --focus-glow: 0 0 0 3px rgba(76, 175, 80, 0.5);
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--card-color);
            margin-bottom: 20px;
        }

        /* Utility classes (simulating Tailwind for consistency with previous context) */
        .mb-4 { margin-bottom: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .flex { display: flex; }
        .gap-4 { gap: 1rem; }
        .justify-center { justify-content: center; }
        .justify-end { justify-content: flex-end; }
        .items-center { align-items: center; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .block { display: block; }
        .w-full { width: 100%; }
        .hidden { display: none !important; }
        .text-white { color: var(--text-color); }
        .text-red-400 { color: #f87171; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-xl { font-size: 1.25rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .rounded-full { border-radius: 9999px; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .mr-2 { margin-right: 0.5rem; }
        .ml-6 { margin-left: 1.5rem; }
        .p-3 { padding: 0.75rem; }
        .cursor-pointer { cursor: pointer; }

        /* Custom Components */
        .container-card {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            padding: 15px;
            border: 1px solid #444;
        }

        .input-group input, .input-group button {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            border: none;
        }

        .input-group {
            display: flex;
            margin-bottom: 1rem;
        }

        .input-group input {
            flex-grow: 1;
            padding: 10px;
            background-color: #555;
            color: var(--text-color);
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            outline: none;
        }

        .input-group input:focus {
            box-shadow: var(--focus-glow);
        }
        
        button, .btn-rounded {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: background-color 0.2s;
            font-weight: bold;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--text-color);
        }

        .btn-primary:hover {
            background-color: #43A047;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #546E7A;
        }

        .btn-red {
            background-color: var(--red-color);
            color: var(--text-color);
        }

        .btn-red:hover {
            background-color: #E53935;
        }

        .btn-green {
            background-color: var(--primary-color);
            color: var(--text-color);
        }
        
        /* Groups */
        #groups {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .group-btn {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid #444;
            padding: 6px 10px;
            border-radius: 50px;
            font-size: 0.85rem;
            position: relative;
        }

        .group-btn:hover {
            background-color: #546E7A;
        }

        .group-btn.selected {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .group-btn .checkmark {
            display: none;
            position: absolute;
            top: -4px;
            right: -4px;
            font-size: 0.7rem;
            line-height: 1;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            text-align: center;
            border: 1px solid var(--bg-color);
        }

        .group-btn.selected .checkmark {
            display: block;
        }
        
        /* Track List */
        #trackList {
            list-style: none;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .track-item {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            transition: background-color 0.15s;
        }

        .trackBox, .recent-box, .playlist-box {
            position: absolute; /* Hide the native checkbox */
            opacity: 0;
        }

        .track-item.selected, .recent-item.selected, .playlist-item.selected {
            background-color: #5b5b5b; /* A darker shade to indicate selection */
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }

        .track-item input[type="checkbox"] + span::before,
        .recent-item input[type="checkbox"] + span::before,
        .playlist-item input[type="checkbox"] + span::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 1px solid #999;
            background-color: #fff;
            border-radius: 3px;
        }

        .track-item input[type="checkbox"]:checked + span::before,
        .recent-item input[type="checkbox"]:checked + span::before,
        .playlist-item input[type="checkbox"]:checked + span::before {
            content: '‚úì';
            background-color: var(--primary-color);
            color: var(--text-color);
            text-align: center;
            line-height: 15px;
            font-size: 12px;
            border-color: var(--primary-color);
        }
        
        .track-item, .recent-item, .playlist-item {
            position: relative;
            padding-left: 35px !important; /* Make room for the custom checkbox */
        }

        .track-item span, .recent-item span, .playlist-item span {
            display: inline-block;
        }

        /* Audio Player */
        #audioControls {
            position: sticky;
            bottom: 0;
            background-color: var(--card-color);
            padding: 10px 20px;
            border-top: 2px solid var(--primary-color);
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.3);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #audioPlayer {
            width: 100%;
            max-width: 400px;
            margin-right: 1rem;
        }

        /* Quiz Mode */
        .mode-toggle {
            background-color: var(--secondary-color);
            display: flex;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex-grow: 1;
            padding: 10px 20px;
            background: transparent;
            color: var(--text-color);
            border: none;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .mode-btn.active {
            background-color: var(--primary-color);
        }

        #quizControls {
            text-align: center;
            margin-top: 15px;
        }
        
        #currentShlok, #currentShlokQuiz {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Countdown Bar */
        #countdownBarContainer {
            width: 100%;
            background-color: #555;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        #countdownBar {
            height: 10px;
            width: 100%;
            background-color: var(--red-color);
            transition: width 1s linear;
        }
        
        /* Modal Styles */
        #modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .modal-content {
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 0px;
            right: 0px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        /* Toast Styles */
        #toast-container {
            position: fixed;
            bottom: 60px; /* Above audio bar */
            right: 20px;
            z-index: 900;
        }

        .toast {
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            opacity: 1;
            transition: opacity 0.3s;
        }

        /* Settings Section */
        #settings label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        #settings input[type="range"] {
            width: 100%;
            margin-top: 5px;
        }
        
        .slider-value {
            font-weight: normal;
            margin-left: 10px;
            color: var(--primary-color);
        }
        
        /* Media Query for smaller screens */
        @media (max-width: 600px) {
            #audioControls {
                flex-direction: column;
                align-items: stretch;
            }
            #audioPlayer {
                margin: 0 0 10px 0;
                max-width: none;
            }
            #trackList {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            #groups {
                justify-content: space-around;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Shloka Study Tool</h1>
            <p>Select tracks below to start listening or quizzing.</p>
        </div>

        <div class="mode-toggle">
            <button id="mode-play" class="mode-btn active" onclick="setMode('play')">üéß Listen Mode</button>
            <button id="mode-quiz" class="mode-btn" onclick="setMode('quiz')">üß† Quiz Mode</button>
        </div>
        
        <div id="settings" class="container-card mb-4">
            <h2 class="text-xl font-bold mb-2">Settings</h2>
            
            <label for="speedSlider">Playback Speed: <span id="speedValue" class="slider-value">1.0x</span></label>
            <input type="range" id="speedSlider" min="0.5" max="2" value="1" step="0.25">

            <div id="quizSettings">
                <label for="quizDelaySlider">Audio Play Delay (before pause): <span id="quizDelayValue" class="slider-value">3s</span></label>
                <input type="range" id="quizDelaySlider" min="1" max="10" value="3" step="1">
                
                <label for="quizTimeSlider">Recite Time (Quiz Pause): <span id="quizTimeValue" class="slider-value">10s</span></label>
                <input type="range" id="quizTimeSlider" min="5" max="30" value="10" step="5">
                
                <label for="repeatEach">Repeat Each Shlok: <span id="repeatEachValue" class="slider-value">1 time</span></label>
                <input type="range" id="repeatEach" min="1" max="5" value="1" step="1">

                <div class="mt-4 flex items-center">
                    <input type="checkbox" id="autoPlayToggle" checked>
                    <label for="autoPlayToggle" class="ml-2 font-semibold cursor-pointer">Auto-play next track after quiz time ends</label>
                </div>
            </div>
        </div>

        <div id="personalPlaylists" class="container-card mb-4 hidden">
            <h2 class="text-xl font-bold mb-2">Your Playlists</h2>
            <p id="playlist-empty" class="text-sm hidden">No playlists saved yet. Select tracks and click "Save Selection as Playlist".</p>
            <ul id="playlistList" class="space-y-2">
                </ul>
        </div>
        
        <div id="recentlyPlayed" class="container-card mb-4 hidden">
            <h2 class="text-xl font-bold mb-2 flex items-center justify-between">
                <span>Recently Played (Quick Select)</span>
                <button class="text-xs px-2 py-1 btn-red rounded-full" onclick="clearHistory()">Clear History</button>
            </h2>
            <ul id="recentList" class="space-y-2">
                </ul>
            <p id="recent-empty" class="text-sm mt-2 hidden">No recent selections saved.</p>
        </div>


        <div class="container-card mb-4">
            <h2 id="allShlokasTitle" class="text-xl font-bold mb-2">Select Individual Shlokas</h2>
            
            <button id="clearAllBtn" class="px-4 py-3 btn-secondary text-white btn-rounded mb-4" onclick="clearSelection()">Clear All Selections</button>
            <button id="savePlaylistBtn" class="px-4 py-3 btn-green text-white btn-rounded mb-4 hidden" onclick="showSavePlaylistModal()">Save Selection as Playlist</button>
            
            <div id="groups" class="mt-2">
                </div>

            <div class="input-group">
                <input type="number" id="search" placeholder="Filter by Shlok number (e.g., 55)">
                <button id="clearSearch" class="btn-secondary hidden" style="border-radius: 0 8px 8px 0;">Clear</button>
            </div>
            <p id="search-feedback" class="text-red-400 font-semibold hidden mb-4 text-center">No shlokas found matching the filter.</p>
            
            <ul id="trackList">
                </ul>
        </div>
        
    </div>

    <div id="audioControls">
        <div id="regularControls">
            <div id="currentShlok">Nothing selected.</div>
            <button class="px-4 py-3 btn-primary text-white btn-rounded" onclick="playSelected()">‚ñ∂Ô∏è Start/Restart Playback</button>
        </div>
        
        <div id="quizControls" class="hidden flex items-center gap-4 w-full">
            <div class="flex-grow">
                <div id="currentShlokQuiz" class="text-left">Start the Quiz to begin.</div>
                <div id="quizStatus" class="text-sm text-red-400 font-semibold"></div>
                <div id="countdownBarContainer">
                    <div id="countdownBar"></div>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <span id="countdown"></span>
                <button class="px-4 py-3 btn-primary text-white btn-rounded" onclick="playNextQuizTrack()">‚û°Ô∏è Next</button>
                <button id="playFullBtn" class="px-4 py-3 btn-secondary text-white btn-rounded hidden" onclick="playFullAudio()">üëÇ Hint</button>
            </div>
        </div>

        <audio id="audioPlayer" controls></audio>
    </div>

    <div id="modal-container">
        </div>

    <div id="toast-container">
        </div>

    <script>
        // --- GLOBAL STATE ---
        let audioPlayer;
        let isQuizMode = false;
        let playlist = [];
        let currentIndex = 0;
        let currentSpeed = 1.0;
        let repeatEach = 1;
        let repeatCounter = 0;
        let currentQuizTime = 10;
        let currentQuizDelay = 3;
        let hasQuizPaused = false;
        let countdownInterval = null;
        let autoPlayTimeout = null;
        let autoPlay = true;
        let totalTracks = 315;
        let localStorageEnabled = typeof localStorage !== 'undefined';
        
        // DOM element references (to be assigned in DOMContentLoaded)
        let trackListEl;
        let allShlokasTitleEl;
        let quizControlsEl;
        let regularControlsEl;
        let savePlaylistBtnEl;


        // --- CORE LOGIC ---

        function changeSpeed(speed) {
            currentSpeed = speed;
            audioPlayer.playbackRate = currentSpeed;
            document.getElementById("speedValue").textContent = `${speed}x`;
            if (localStorageEnabled) localStorage.setItem("playbackSpeed", speed);
        }

        function changeQuizTime(time) {
            currentQuizTime = time;
            document.getElementById("quizTimeValue").textContent = `${time}s`;
            if (localStorageEnabled) localStorage.setItem("quizTime", time);
        }
        
        function changeQuizDelay(delay) {
            currentQuizDelay = delay;
            document.getElementById("quizDelayValue").textContent = `${delay}s`;
            if (localStorageEnabled) localStorage.setItem("quizDelay", delay);
        }

        function changeRepeatEach(times) {
            repeatEach = times;
            document.getElementById("repeatEachValue").textContent = `${times} time${times > 1 ? 's' : ''}`;
            if (localStorageEnabled) localStorage.setItem("repeatEach", times);
        }
        
        document.getElementById('autoPlayToggle').addEventListener('change', (e) => {
            autoPlay = e.target.checked;
            if (localStorageEnabled) localStorage.setItem("autoPlay", autoPlay);
        });
        
        document.getElementById('repeatEach').addEventListener('input', function() {
            changeRepeatEach(parseInt(this.value));
        });
        
        function setMode(mode) {
            const isQuiz = mode === 'quiz';
            isQuizMode = isQuiz;
            document.getElementById('mode-play').classList.toggle('active', !isQuiz);
            document.getElementById('mode-quiz').classList.toggle('active', isQuiz);
            
            allShlokasTitleEl.textContent = isQuiz ? "Select Shlokas for Quiz Source" : "Select Individual Shlokas";
            quizControlsEl.classList.toggle('hidden', !isQuiz);
            regularControlsEl.classList.toggle('hidden', isQuiz);
            document.getElementById('quizSettings').classList.toggle('hidden', !isQuiz);
            document.getElementById('clearAllBtn').textContent = isQuiz ? "Clear Quiz Selection" : "Clear All Selections";
            
            // Re-evaluate save button visibility
            const selectedTracks = Array.from(document.querySelectorAll(".trackBox:checked"));
            savePlaylistBtnEl.classList.toggle('hidden', selectedTracks.length === 0 || isQuiz);
            
            // Clear any active playback/quiz state
            if (countdownInterval) clearInterval(countdownInterval);
            if (autoPlayTimeout) clearTimeout(autoPlayTimeout);
            audioPlayer.pause();
            audioPlayer.src = "";
            document.getElementById('currentShlok').textContent = "Nothing selected.";
            document.getElementById('currentShlokQuiz').textContent = "Start the Quiz to begin.";
            document.getElementById('quizStatus').textContent = "";
            document.getElementById('countdown').textContent = "";
            document.getElementById('playFullBtn').classList.add('hidden');
            document.getElementById('countdownBar').style.width = '100%';

            // Reset playlist state
            playlist = [];
            currentIndex = 0;
            repeatCounter = 0;
        }

        function playFullAudio() {
            if (countdownInterval) clearInterval(countdownInterval);
            document.getElementById('countdown').textContent = '';
            document.getElementById('quizStatus').textContent = 'Playing full shlok...';
            document.getElementById('playFullBtn').classList.add('hidden');
            
            const trackNum = playlist[currentIndex - 1]; // Current track index is already incremented
            
            // Play the track from the start
            audioPlayer.currentTime = 0;
            audioPlayer.play();

            // Set a flag to prevent the short-play logic from running on the full playback
            hasQuizPaused = false;
            
            // Listen for 'ended' event to automatically proceed
            function onEnded() {
                audioPlayer.removeEventListener('ended', onEnded);
                document.getElementById('quizStatus').textContent = '';
                if (autoPlay) {
                    playNextQuizTrack();
                }
            }
            audioPlayer.addEventListener('ended', onEnded);
        }

        // ----------------------------------------------------------------------------------------------------
        // NEW UTILITY FUNCTION: Consolidate Track Selection Logic (Robustness Update #2)
        // ----------------------------------------------------------------------------------------------------
        function getSelectedTracks(includeRecents = false) {
            // 1. Check for selected Playlists (highest priority)
            const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked"))
                .flatMap(cb => JSON.parse(cb.dataset.selection));

            if (selectedPlaylists.length > 0) {
                return Array.from(new Set(selectedPlaylists));
            }
            
            // 2. Check for selected Recent Selections (if flag is true)
            if (includeRecents) {
                const selectedRecents = Array.from(document.querySelectorAll(".recent-box:checked"))
                    .flatMap(cb => cb.dataset.selection.split(",").map(n => parseInt(n.trim())));
                    
                if (selectedRecents.length > 0) {
                    return Array.from(new Set(selectedRecents));
                }
            }
            
            // 3. Fall back to individual track selections
            return Array.from(document.querySelectorAll(".trackBox:checked"))
                .map(cb => parseInt(cb.value, 10));
        }
        // ----------------------------------------------------------------------------------------------------

        // ----------------------------------------------------------------------------------------------------
        // UPDATED playNextQuizTrack: Using getSelectedTracks(true) (Robustness Update #2)
        // ----------------------------------------------------------------------------------------------------
        function playNextQuizTrack() {
            const selected = getSelectedTracks(true); // Refactored to use new utility function
            
            if (selected.length === 0) {
                showModal("Please select a group of shlokas or a playlist to quiz yourself on first!");
                return;
            }

            // Shuffle/Reload playlist if exhausted or uninitialized
            if (playlist.length === 0 || currentIndex >= playlist.length) {
                // Save this selection to history for quick recall (only save when starting a new full cycle)
                saveSelection(selected); 
                playlist = [...selected].sort(() => Math.random() - 0.5);
                currentIndex = 0;
                showToast(`Starting new quiz session with ${playlist.length} unique shlokas!`);
            }

            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            clearTimeout(autoPlayTimeout);
            document.getElementById('quizStatus').textContent = '';
            document.getElementById('playFullBtn').classList.add('hidden');
            document.getElementById('countdown').textContent = '';

            const trackNum = playlist[currentIndex];
            document.getElementById('currentShlokQuiz').textContent = `Now playing hint for: Shlok ${trackNum}`;
            
            // Prepare audio
            audioPlayer.src = `https://ia601703.us.archive.org/35/items/satsang_diksha/sanskrit_${String(trackNum).padStart(3, '0')}.mp3`;
            audioPlayer.playbackRate = currentSpeed;
            
            hasQuizPaused = false;
            document.getElementById('countdownBar').style.width = '100%';
            audioPlayer.play().catch(err => {
                showToast("Failed to play track. Please check your connection or try again.");
                console.log("Play error:", err);
            });

            currentIndex++;
        }
        // ----------------------------------------------------------------------------------------------------

        // Regular Playback Mode
        // ----------------------------------------------------------------------------------------------------
        function playSelected() {
            if (isQuizMode) {
                playNextQuizTrack(); // Delegate to quiz function if mode is mistakenly left on
                return;
            }

            // Use getSelectedTracks(false) for regular play, prioritizing playlists > individual tracks
            const finalSelection = getSelectedTracks(false); 

            if (finalSelection.length === 0) {
                showModal("Please select at least one shloka, a group, or a playlist to start playback.");
                return;
            }
            
            // Save the selection to history
            saveSelection(finalSelection);

            // Re-initialize playlist for linear playback
            playlist = [...finalSelection].sort((a, b) => a - b);
            currentIndex = 0;
            repeatCounter = 0;
            
            playCurrent();
        }

        function playCurrent() {
            if (playlist.length === 0) {
                audioPlayer.pause();
                document.getElementById('currentShlok').textContent = "Playlist finished or empty.";
                showToast("Playlist finished.");
                return;
            }

            if (currentIndex >= playlist.length) {
                showToast("Playlist ended! Restarting from the beginning.");
                currentIndex = 0;
            }
            
            const trackNum = playlist[currentIndex];
            const currentRepeat = repeatCounter + 1;

            document.getElementById('currentShlok').textContent = `Shlok ${trackNum} (Repeat ${currentRepeat}/${repeatEach})`;
            
            audioPlayer.src = `https://ia601703.us.archive.org/35/items/satsang_diksha/sanskrit_${String(trackNum).padStart(3, '0')}.mp3`;
            audioPlayer.playbackRate = currentSpeed;
            audioPlayer.play().catch(err => {
                document.getElementById('currentShlok').textContent = `Failed to play Shlok ${trackNum}.`;
                showToast("Failed to play track. Skipping to next.");
                currentIndex++; // Skip to next track on error
                repeatCounter = 0;
                playCurrent();
            });
        }
        // ----------------------------------------------------------------------------------------------------


        function clearSelection() {
            document.querySelectorAll(".trackBox").forEach(cb => {
                cb.checked = false;
                cb.closest("label").classList.remove("selected");
            });
            document.querySelectorAll(".recent-box, .playlist-box").forEach(cb => {
                cb.checked = false;
                cb.closest("label").classList.remove("selected");
            });
            updateGroupButtonSelection();
            if (countdownInterval) clearInterval(countdownInterval);
            if (autoPlayTimeout) clearTimeout(autoPlayTimeout);
            audioPlayer.pause();
            audioPlayer.src = "";
            document.getElementById('currentShlok').textContent = "Nothing selected.";
            document.getElementById('currentShlokQuiz').textContent = "Start the Quiz to begin.";
            document.getElementById('quizStatus').textContent = "";
            document.getElementById('countdown').textContent = "";
            document.getElementById('playFullBtn').classList.add('hidden');
        }

        // ----------------------------------------------------------------------------------------------------
        // UPDATED showModal: Fix Cross-Site Scripting (XSS) Vulnerability (Security Update #1)
        // ----------------------------------------------------------------------------------------------------
        function showModal(message, onConfirm = null) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');

            // --- Start Security Fix ---
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';

            // Insert close button using insertAdjacentHTML (since it's static HTML)
            modalContent.innerHTML = `<span class="modal-close" onclick="this.closest('.modal').remove()" tabindex="0" role="button" aria-label="Close modal">&times;</span>`;

            // Create a paragraph element for the message and use textContent for safety
            const messageEl = document.createElement('p');
            messageEl.className = 'mb-4';
            messageEl.textContent = message; // SAFELY inserts text only (XSS Fix)
            modalContent.appendChild(messageEl);

            // Add the appropriate buttons based on onConfirm state
            if (onConfirm) {
                modalContent.insertAdjacentHTML('beforeend', `
                    <div class="flex gap-4 justify-center">
                        <button class="px-4 py-3 btn-red text-white btn-rounded" id="modal-cancel">Cancel</button>
                        <button class="px-4 py-3 btn-primary text-white btn-rounded" id="modal-confirm">OK</button>
                    </div>
                `);
            } else {
                modalContent.insertAdjacentHTML('beforeend', `
                    <button onclick="this.closest('.modal').remove()" class="px-4 py-3 btn-primary text-white btn-rounded">OK</button>
                `);
            }
            
            modal.appendChild(modalContent);
            modalContainer.appendChild(modal);
            // --- End Security Fix ---

            if (onConfirm) {
                modal.querySelector('#modal-confirm').addEventListener('click', () => {
                    onConfirm();
                    modal.remove();
                });
                modal.querySelector('#modal-cancel').addEventListener('click', () => modal.remove());
            }
            
            // Focus on a confirmation or close button for accessibility
            const focusTarget = modal.querySelector('#modal-confirm') || modal.querySelector('.modal-close') || modal.querySelector('button');
            if(focusTarget) focusTarget.focus();
        }
        // ----------------------------------------------------------------------------------------------------

        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.setAttribute('role', 'status');
            toast.setAttribute('aria-live', 'polite');
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // --- PLAYLIST & HISTORY MANAGEMENT ---

        function showSavePlaylistModal() {
            if (!localStorageEnabled) {
                showModal("Local storage is not enabled or available in your browser. Cannot save playlists.");
                return;
            }
            const selectedTracks = Array.from(document.querySelectorAll(".trackBox:checked"))
                .map(cb => parseInt(cb.value, 10));
            
            if (selectedTracks.length === 0) {
                showModal("Please select at least one shlok to save as a playlist.");
                return;
            }

            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            // Using template literal for this complex modal's static structure is acceptable, but the input value must be safe.
            modal.innerHTML = `
                <div class="modal-content text-left">
                    <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
                    <h3 class="text-xl font-bold mb-4">Save Playlist</h3>
                    <p class="mb-2">Enter a name for your playlist:</p>
                    <input type="text" id="playlistNameInput" class="w-full mb-4" placeholder="My new playlist">
                    <div id="playlistNameFeedback" class="text-red-400 font-semibold hidden mb-4"></div>
                    <div class="flex gap-4 justify-end">
                        <button class="px-4 py-3 btn-secondary text-white btn-rounded" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="px-4 py-3 btn-green text-white btn-rounded" id="savePlaylistConfirm">Save</button>
                    </div>
                </div>
            `;
            modalContainer.appendChild(modal);
            const inputEl = document.getElementById('playlistNameInput');
            const saveBtnEl = document.getElementById('savePlaylistConfirm');
            const feedbackEl = document.getElementById('playlistNameFeedback');

            function savePlaylist() {
                // Sanitize input name before using it
                const playlistName = inputEl.value.trim().replace(/</g, "&lt;").replace(/>/g, "&gt;"); 
                
                if (playlistName === "") {
                    feedbackEl.textContent = "Playlist name cannot be empty.";
                    feedbackEl.classList.remove('hidden');
                    return;
                }
                let playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
                if (playlists[playlistName]) {
                    feedbackEl.textContent = "A playlist with this name already exists.";
                    feedbackEl.classList.remove('hidden');
                    return;
                }
                playlists[playlistName] = selectedTracks;
                localStorage.setItem("personalPlaylists", JSON.stringify(playlists));
                renderPersonalPlaylists();
                showToast(`Playlist "${playlistName}" saved!`);
                modal.remove();
            }

            saveBtnEl.addEventListener('click', savePlaylist);
            inputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    savePlaylist();
                }
            });
            inputEl.focus();
        }
        
        function confirmDeletePlaylist(name) {
            showModal(`Are you sure you want to delete the playlist "${name}"?`, () => deletePlaylist(name));
        }

        function renderPersonalPlaylists() {
            if (!localStorageEnabled) {
                return;
            }
            const playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
            const playlistList = document.getElementById("playlistList");
            const personalPlaylistsDiv = document.getElementById("personalPlaylists");
            const emptyMessage = document.getElementById("playlist-empty");

            playlistList.innerHTML = "";
            const names = Object.keys(playlists);
            
            if (names.length === 0) {
                personalPlaylistsDiv.classList.remove("hidden");
                emptyMessage.classList.remove("hidden");
            } else {
                personalPlaylistsDiv.classList.remove("hidden");
                emptyMessage.classList.add("hidden");
            }
            
            names.forEach(name => {
                const shlokas = playlists[name];
                const li = document.createElement("li");
                li.className = "space-y-2";
                // Note: The `name` is sanitized via input filter on save, and here in the load/delete functions.
                // Using replace for basic safety in this context.
                const safeName = name.replace(/'/g, "\\'"); 
                li.innerHTML = `
                    <label class="playlist-item block p-3 container-card cursor-pointer flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" class="playlist-box mr-2" data-selection='${JSON.stringify(shlokas)}'>
                            <span class="ml-6 font-semibold">${name}</span>
                            </div>
                        <div class="flex items-center space-x-2 text-sm text-gray-400">
                            <span>(${shlokas.length} shlokas)</span>
                            <button onclick="loadPlaylist('${safeName}')" class="text-xs px-2 py-1 btn-secondary rounded-full" aria-label="Load playlist ${name}">
                                Load
                            </button>
                            <button onclick="confirmDeletePlaylist('${safeName}')" class="text-xs px-2 py-1 btn-red rounded-full" aria-label="Delete playlist ${name}">
                                Delete
                            </button>
                        </div>
                    </label>
                `;
                playlistList.appendChild(li);
            });
        }

        function loadPlaylist(name) {
            if (!localStorageEnabled) return;
            let playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
            const shlokas = playlists[name];
            if (shlokas) {
                // Clear all other selection types
                document.querySelectorAll(".trackBox, .recent-box, .playlist-box").forEach(cb => {
                    cb.checked = false;
                    cb.closest("label").classList.remove("selected");
                });

                // Set the current playlist item as selected
                document.querySelectorAll('.playlist-box').forEach(cb => {
                    if (cb.closest('label').querySelector('.font-semibold').textContent === name) {
                        cb.checked = true;
                        cb.closest('label').classList.add('selected');
                    }
                });

                // Load tracks into individual boxes (for visual feedback)
                shlokas.forEach(trackNum => {
                    const checkbox = document.querySelector(`.trackBox[value="${trackNum}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.closest("label").classList.add("selected");
                    }
                });
                updateGroupButtonSelection();
                showToast(`Playlist "${name}" loaded into your selection!`);
            }
        }

        function deletePlaylist(name) {
            if (!localStorageEnabled) return;
            let playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
            delete playlists[name];
            localStorage.setItem("personalPlaylists", JSON.stringify(playlists));
            renderPersonalPlaylists();
            showToast(`Playlist "${name}" deleted.`);
        }

        function saveSelection(selection) {
            if (!localStorageEnabled || isQuizMode) return;
            let history = [];
            try { history = JSON.parse(localStorage.getItem("recentSelections")) || []; } catch (e) { history = []; }
            const selString = selection.join(",");
            history = [selString, ...history.filter(h => h !== selString)].slice(0, 5);
            localStorage.setItem("recentSelections", JSON.stringify(history));
            renderRecentSelections();
        }

        function clearHistory() {
            if (!localStorageEnabled) return;
            showModal("Are you sure you want to clear your recently played history?", () => {
                localStorage.removeItem("recentSelections");
                renderRecentSelections();
                showToast("Recently played history cleared.");
            });
        }

        function renderRecentSelections() {
            if (!localStorageEnabled) {
                return;
            }
            const history = JSON.parse(localStorage.getItem("recentSelections")) || [];
            const recentDiv = document.getElementById("recentlyPlayed");
            const recentList = document.getElementById("recentList");
            const recentEmpty = document.getElementById("recent-empty");
            recentList.innerHTML = "";
            if (history.length === 0) { 
                recentDiv.classList.add("hidden"); 
                recentEmpty.classList.remove("hidden");
                return; 
            }
            recentDiv.classList.remove("hidden");
            recentEmpty.classList.add("hidden");
            history.forEach((sel) => {
                const numbers = sel.split(",").map(n => parseInt(n.trim()));
                let labelText = numbers.length <= 6 ? "Shlok " + numbers.join(", ") : `Shlok ${numbers[0]}‚Äì${numbers[numbers.length - 1]} (${numbers.length} total)`;
                const li = document.createElement("li");
                li.className = "space-y-2";
                li.innerHTML = `
                    <label class="recent-item block p-3 container-card cursor-pointer">
                        <input type="checkbox" class="recent-box mr-2" data-selection="${sel}">
                        <span class="ml-6">${labelText}</span>
                    </label>
                `;
                recentList.appendChild(li);
            });
        }

        function restoreLastSelection() {
            if (!localStorageEnabled) return;
            let history = [];
            try { history = JSON.parse(localStorage.getItem("recentSelections")) || []; } catch (e) { history = []; }
            if (history.length > 0) {
                const lastSel = history[0].split(",").map(n => parseInt(n.trim()));
                lastSel.forEach(trackNum => {
                    const checkbox = document.querySelector(`.trackBox[value="${trackNum}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.closest("label").classList.add("selected");
                    }
                });
                updateGroupButtonSelection();
            }
        }
        
        function updateGroupButtonSelection() {
            const selectedTracks = new Set(Array.from(document.querySelectorAll(".trackBox:checked")).map(cb => parseInt(cb.value)));
            document.querySelectorAll(".group-btn").forEach(btn => {
                const start = parseInt(btn.dataset.start);
                const end = parseInt(btn.dataset.end);
                
                let isGroupSelected = true;
                for(let i = start; i <= end; i++) {
                    // Check if *all* tracks in the group are selected
                    if (!selectedTracks.has(i)) {
                        isGroupSelected = false;
                        break;
                    }
                }
                
                btn.classList.toggle('selected', isGroupSelected);
                btn.setAttribute('aria-pressed', isGroupSelected);
            });
            // Also update the visibility of the Save Playlist button
            savePlaylistBtnEl.classList.toggle('hidden', selectedTracks.size === 0 || isQuizMode);
        }

        // --- UI GENERATION ---

        function generateGroups() {
            const groupDiv = document.getElementById("groups");
            for (let i = 1; i <= totalTracks; i += 10) {
                const end = Math.min(i + 9, totalTracks);
                const btn = document.createElement("button");
                btn.className = "group-btn";
                btn.setAttribute("tabindex", "0");
                btn.setAttribute("aria-pressed", "false"); 
                btn.dataset.start = i;
                btn.dataset.end = end;
                btn.innerHTML = `${i}‚Äì${end}<span class="checkmark">‚úì</span>`;
                btn.onclick = () => toggleGroup(i, end, btn); 
                groupDiv.appendChild(btn);
            }
        }
        
        function toggleGroup(start, end, btn) {
            // Determine the current state of the button (which should reflect if the group is fully selected)
            const isGroupSelected = btn.classList.contains('selected');

            // Clear other selection types (Recent/Playlists) to prevent conflict
            document.querySelectorAll(".recent-box, .playlist-box").forEach(cb => {
                cb.checked = false;
                cb.closest("label").classList.remove("selected");
            });

            // Toggle the selection state for all tracks in the group
            for (let i = start; i <= end; i++) {
                const checkbox = document.querySelector(`.trackBox[value="${i}"]`);
                if (checkbox) {
                    // If the group was already selected (isGroupSelected is true), we deselect them.
                    // If the group was not fully selected (isGroupSelected is false), we select them.
                    checkbox.checked = !isGroupSelected;
                    checkbox.closest("label").classList.toggle("selected", !isGroupSelected);
                }
            }

            // Update the visual state of the group button itself
            btn.classList.toggle('selected', !isGroupSelected);
            btn.setAttribute('aria-pressed', !isGroupSelected);

            // Update all group buttons and the Save Playlist button status based on the new individual track selection
            updateGroupButtonSelection();
        }


        function generateTracks() {
            for (let i = 1; i <= totalTracks; i++) {
                const li = document.createElement("li");
                li.innerHTML = `
                    <label class="track-item block p-3 text-white">
                        <input type="checkbox" value="${i}" class="trackBox mr-2"> <span class="ml-6">Shlok ${i}</span>
                    </label>`;
                trackListEl.appendChild(li);
            }
        }
        
        // --- INITIALIZATION ---

        document.addEventListener("DOMContentLoaded", function () {
            // Assign global element references
            audioPlayer = document.getElementById("audioPlayer");
            trackListEl = document.getElementById("trackList");
            allShlokasTitleEl = document.getElementById("allShlokasTitle");
            quizControlsEl = document.getElementById("quizControls");
            regularControlsEl = document.getElementById("regularControls");
            savePlaylistBtnEl = document.getElementById("savePlaylistBtn");
            
            const searchInput = document.getElementById("search");
            const trackListContainer = document.getElementById("trackList");
            const clearSearchBtn = document.getElementById("clearSearch");
            const searchFeedbackEl = document.getElementById("search-feedback");

            // Load saved settings
            currentSpeed = parseFloat(localStorage.getItem("playbackSpeed") || 1.0);
            currentQuizTime = parseInt(localStorage.getItem("quizTime") || 10);
            currentQuizDelay = parseInt(localStorage.getItem("quizDelay") || 3);
            repeatEach = parseInt(localStorage.getItem("repeatEach") || 1);
            autoPlay = localStorage.getItem("autoPlay") !== "false"; // Default to true if not set

            // Initialize UI from saved settings
            const speedSlider = document.getElementById("speedSlider");
            const quizTimeSlider = document.getElementById("quizTimeSlider");
            const quizDelaySlider = document.getElementById("quizDelaySlider");
            const repeatEachSlider = document.getElementById("repeatEach");
            const autoPlayToggle = document.getElementById('autoPlayToggle');

            speedSlider.value = currentSpeed;
            document.getElementById("speedValue").textContent = `${currentSpeed}x`;
            audioPlayer.playbackRate = currentSpeed;
            
            quizTimeSlider.value = currentQuizTime;
            document.getElementById("quizTimeValue").textContent = `${currentQuizTime}s`;
            
            quizDelaySlider.value = currentQuizDelay;
            document.getElementById("quizDelayValue").textContent = `${currentQuizDelay}s`;
            
            repeatEachSlider.value = repeatEach;
            document.getElementById("repeatEachValue").textContent = `${repeatEach} time${repeatEach > 1 ? 's' : ''}`;
            
            autoPlayToggle.checked = autoPlay;


            // Bind settings listeners
            speedSlider.addEventListener("input", function() {
                changeSpeed(parseFloat(this.value));
            });
            quizTimeSlider.addEventListener("input", function() {
                changeQuizTime(parseInt(this.value));
            });
            quizDelaySlider.addEventListener("input", function() {
                changeQuizDelay(parseInt(this.value));
            });

            // Search/Filter logic
            clearSearchBtn.addEventListener("click", () => {
                searchInput.value = "";
                searchInput.dispatchEvent(new Event('input'));
            });

            searchInput.addEventListener("input", function () {
                const term = this.value.trim().toLowerCase();
                let found = false;
                document.querySelectorAll("#trackList li").forEach(li => {
                    const trackNumber = li.querySelector(".trackBox").value;
                    if (!term || trackNumber.startsWith(term)) {
                        li.classList.remove("hidden");
                        found = true;
                    } else {
                        li.classList.add("hidden");
                    }
                });
                searchFeedbackEl.classList.toggle("hidden", found);
                clearSearchBtn.classList.toggle("hidden", term === "");
            });

            // Centralized change listener for individual tracks
            trackListContainer.addEventListener("change", function(event) {
                if (event.target.classList.contains("trackBox")) {
                    const label = event.target.closest("label");
                    const isChecked = event.target.checked;
                    label.classList.toggle("selected", isChecked);
                    updateGroupButtonSelection();
                    // Deselect any active playlist/recent items when individual tracks are changed
                    document.querySelectorAll(".recent-box, .playlist-box").forEach(cb => {
                        cb.checked = false;
                        cb.closest("label").classList.remove("selected");
                    });
                }
            });
            
            // Centralized change listener for Recent selections
            document.getElementById("recentList").addEventListener("change", function(event) {
                if (event.target.classList.contains("recent-box")) {
                    // Clear individual track and playlist selections
                    document.querySelectorAll(".track-item.selected, .playlist-item.selected").forEach(item => item.classList.remove("selected"));
                    document.querySelectorAll(".trackBox, .playlist-box").forEach(cb => cb.checked = false);

                    const selectedRecents = Array.from(document.querySelectorAll(".recent-box:checked"));
                    
                    // Update visual state of recent selections
                    document.querySelectorAll(".recent-item").forEach(item => {
                         item.classList.toggle("selected", item.querySelector(".recent-box").checked);
                    });

                    // Update individual tracks for visual feedback
                    const allNumbers = new Set(selectedRecents.flatMap(cb => cb.dataset.selection.split(",").map(Number)));
                    document.querySelectorAll(".trackBox").forEach(cb => {
                        const trackNum = parseInt(cb.value);
                        const isChecked = allNumbers.has(trackNum);
                        cb.checked = isChecked;
                        cb.closest("label").classList.toggle("selected", isChecked);
                    });
                    
                    updateGroupButtonSelection();
                }
            });

            // Centralized change listener for Playlists
            document.getElementById("playlistList").addEventListener("change", function(event) {
                if (event.target.classList.contains("playlist-box")) {
                    // Clear individual track and recent selections
                    document.querySelectorAll(".track-item.selected, .recent-item.selected").forEach(item => item.classList.remove("selected"));
                    document.querySelectorAll(".trackBox, .recent-box").forEach(cb => cb.checked = false);

                    const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked"));
                    
                    // Update visual state of playlists
                    document.querySelectorAll(".playlist-item").forEach(item => {
                         item.classList.toggle("selected", item.querySelector(".playlist-box").checked);
                    });

                    // Update individual tracks for visual feedback
                    const allNumbers = new Set(selectedPlaylists.flatMap(cb => JSON.parse(cb.dataset.selection)));
                    document.querySelectorAll(".trackBox").forEach(cb => {
                        const trackNum = parseInt(cb.value);
                        const isChecked = allNumbers.has(trackNum);
                        cb.checked = isChecked;
                        cb.closest("label").classList.toggle("selected", isChecked);
                    });
                    
                    updateGroupButtonSelection();
                }
            });

            // Audio event listeners
            audioPlayer.addEventListener("error", (e) => {
                showToast("An error occurred while loading the audio.");
            });

            audioPlayer.addEventListener("playing", () => {
                if (isQuizMode && !hasQuizPaused) {
                    document.getElementById('playFullBtn').classList.add('hidden');
                    // Set timeout for the quiz delay before pause
                    autoPlayTimeout = setTimeout(() => {
                        audioPlayer.pause();
                        hasQuizPaused = true;
                        document.getElementById('quizStatus').textContent = "Audio Paused. Your turn to recite!";
                        document.getElementById('playFullBtn').classList.remove('hidden');

                        let countdown = currentQuizTime;
                        const countdownEl = document.getElementById('countdown');
                        countdownEl.textContent = `(${countdown}s)`;
                        
                        if (countdownInterval) {
                            clearInterval(countdownInterval);
                        }
                        
                        document.getElementById('countdownBar').style.width = `${(countdown / currentQuizTime) * 100}%`;

                        // Start countdown timer
                        countdownInterval = setInterval(() => {
                            countdown--;
                            countdownEl.textContent = `(${countdown}s)`;
                            document.getElementById('countdownBar').style.width = `${(countdown / currentQuizTime) * 100}%`;
                            if (countdown <= 0) {
                                clearInterval(countdownInterval);
                                countdownEl.textContent = '';
                                document.getElementById('quizStatus').textContent = 'Time up!';
                                document.getElementById('playFullBtn').classList.add('hidden');
                                if (autoPlay) {
                                    playNextQuizTrack();
                                }
                            }
                        }, 1000);
                    }, currentQuizDelay * 1000); 
                }
            });

            audioPlayer.addEventListener("ended", () => {
                if (!isQuizMode) {
                    // Regular Playback Mode: Handle repeating the current track
                    repeatCounter++;
                    if (repeatCounter >= repeatEach) {
                        repeatCounter = 0;
                        currentIndex++; // Move to the next track
                    }
                    playCurrent();
                } else if (isQuizMode && !hasQuizPaused) {
                    // This case handles when 'playFullAudio' finishes playing the full track.
                    // The auto-advance logic is handled within playFullAudio for immediate cleanup.
                }
            });
            
            // --- FINAL SETUP ---
            generateGroups();
            generateTracks();
            if (localStorageEnabled) {
                restoreLastSelection();
                renderRecentSelections();
                renderPersonalPlaylists();
            } else {
                showToast("Local storage is disabled. Playlists and history will not be saved.");
            }
        });
    </script>
</body>
</html>
