<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mission Rajipo - Apple Music UI</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>
<style>
/* Keep your original styles unchanged */
</style>
</head>
<body class="flex flex-col">

<div class="max-w-xl mx-auto p-4 flex flex-col flex-1 w-full">
<h1 class="text-3xl font-bold text-center mb-6 text-white">Mission Rajipo ðŸŽµ</h1>

<div id="mainControls" class="space-y-3 mb-6 container-card">
  <!-- Search & Range Controls -->
  <div id="search-container" class="relative">
    <input id="search" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Search shlok number..." class="w-full pr-10" aria-label="Search shlok number"/>
    <i id="clearSearch" class="fa-solid fa-xmark absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 cursor-pointer hidden"></i>
  </div>
  <div id="search-feedback" class="text-center text-red-400 font-semibold hidden" aria-live="polite">No matching shlokas found.</div>
  <div class="flex gap-2">
    <input id="rangeStart" type="number" min="1" max="315" placeholder="Start" class="w-1/2"/>
    <input id="rangeEnd" type="number" min="1" max="315" placeholder="End" class="w-1/2"/>
    <button onclick="selectRange()" class="px-4 py-3 bg-gray-500 text-white rounded-lg flex items-center gap-1 btn-secondary">
      <i class="fa-solid fa-list-ol"></i> Range
    </button>
  </div>
</div>

<div id="groups-container" class="mb-6 container-card">
  <button onclick="toggleGroupDisplay()" class="w-full py-3 btn-rounded btn-secondary flex items-center justify-center gap-2 mb-3">
    <i id="group-toggle-icon" class="fa-solid fa-chevron-down"></i> Groups
  </button>
  <div id="groups" class="grid grid-cols-3 gap-2 justify-items-center mb-3 hidden"></div>
</div>

<div class="mb-6 container-card space-y-4">
  <button onclick="toggleMode()" class="w-full py-3 btn-rounded btn-secondary flex items-center justify-center gap-2">
    <i class="fa-solid fa-toggle-off"></i> Toggle to Quiz Mode
  </button>

  <div id="dynamicControlsWrapper" class="relative min-h-[250px]">
    <!-- Quiz controls -->
    <div id="quizControls" class="space-y-4 absolute w-full top-0 left-0 fade-out hidden">
      <h2 class="text-xl font-bold text-center">Quiz Mode ðŸ§ </h2>
      <p id="currentShlokQuiz" class="text-lg font-semibold text-center text-gray-400">Shlok 0</p>
      <div class="countdown-bar-container">
        <div id="countdownBar" class="countdown-bar h-full"></div>
      </div>
      <div class="min-h-[24px] flex justify-between items-center space-x-2">
        <p id="quizStatus" class="font-semibold text-green-400" aria-live="polite"></p>
        <span id="countdown" class="font-semibold text-white"></span>
      </div>
      <div class="flex items-center space-x-4 w-full">
        <span class="text-sm text-gray-400 w-16">Pause:</span>
        <input type="range" id="quizTimeSlider" min="5" max="60" step="5" value="20" class="flex-1"/>
        <span id="quizTimeDisplay" class="font-semibold w-10 text-white">20s</span>
      </div>
      <div class="flex items-center space-x-4 w-full">
        <span class="text-sm text-gray-400 w-16">Play Delay:</span>
        <input type="range" id="quizDelaySlider" min="1" max="10" step="1" value="3" class="flex-1"/>
        <span id="quizDelayDisplay" class="font-semibold w-10 text-white">3s</span>
      </div>
      <div class="flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
        <button id="autoPlayToggle" onclick="toggleAutoPlay()" class="px-4 py-3 btn-secondary text-white btn-rounded flex items-center gap-2">
          <i class="fa-solid fa-toggle-off"></i>Auto-Play: OFF
        </button>
        <button id="playFullBtn" onclick="playFullShloka()" class="px-4 py-3 btn-secondary text-white btn-rounded flex items-center gap-2 hidden">
          <i class="fa-solid fa-redo"></i> Play Full Shloka
        </button>
      </div>
      <button onclick="playNextQuizTrack()" class="w-full py-3 btn-primary text-white btn-rounded">
        <i class="fa-solid fa-forward"></i> Play Next
      </button>
    </div>

    <!-- Regular controls -->
    <div id="regularControls" class="space-y-4 absolute w-full top-0 left-0 fade-in">
      <div class="flex flex-wrap justify-between items-center gap-4 text-sm text-gray-400">
        <label class="flex-1 flex items-center gap-2">
          <span class="text-gray-400">Repeat:</span>
          <input id="repeatCount" type="number" min="1" value="1" class="w-16 p-1 text-center bg-transparent border-b-2 border-gray-600"/>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" id="shuffle" class="h-4 w-4 rounded text-blue-600 bg-gray-800 border-gray-600"/>
          Shuffle
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" id="repeatPlaylist" class="h-4 w-4 rounded text-blue-600 bg-gray-800 border-gray-600"/>
          Repeat
        </label>
      </div>
      <div class="flex items-center space-x-4">
        <span class="text-sm text-gray-400 w-12">Speed:</span>
        <input type="range" id="speedSlider" min="0.5" max="1.5" step="0.1" value="1.0" class="flex-1"/>
        <span id="speedDisplay" class="font-semibold w-8 text-white">1.0</span>x
      </div>
      <div class="flex flex-col gap-2 sm:flex-row">
        <button onclick="playSelected()" class="flex-1 py-3 btn-primary text-white btn-rounded">
          <i class="fa-solid fa-play"></i> Play
        </button>
        <button onclick="confirmClearSelection()" class="flex-1 py-3 btn-red text-white btn-rounded">
          <i class="fa-solid fa-eraser"></i> Clear
        </button>
      </div>
    </div>
  </div>
</div>

<div id="personalPlaylists" class="mt-6 container-card">
  <h2 class="text-lg font-bold mb-3 text-white">My Personal Playlists ðŸ’¾</h2>
  <p id="playlist-empty" class="text-gray-400 text-center mb-3 hidden">No saved playlists yet.</p>
  <ul id="playlistList" class="space-y-3 mb-4"></ul>
  <div id="savePlaylistBtn" class="hidden">
    <button onclick="showSavePlaylistModal()" class="w-full py-3 btn-rounded btn-green text-white flex items-center justify-center gap-2">
      <i class="fa-solid fa-plus-circle"></i> Save as Playlist
    </button>
  </div>
</div>

<div id="recentlyPlayed" class="mt-6 hidden container-card">
  <h2 class="text-lg font-bold mb-3 text-white">Recently Played</h2>
  <ul id="recentList" class="space-y-3"></ul>
  <p id="recent-empty" class="text-gray-400 text-center hidden">Your recently played selections will appear here.</p>
  <button onclick="confirmClearHistory()" class="mt-4 w-full py-3 btn-rounded btn-secondary flex items-center justify-center gap-2">
    <i class="fa-solid fa-trash-can"></i> Clear History
  </button>
</div>

<h2 id="allShlokasTitle" class="text-lg font-bold mt-6 mb-3 text-white">All Shlokas</h2>
<ul id="trackList" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></ul>
</div>

<!-- Audio footer -->
<footer class="fixed bottom-0 left-0 right-0 shadow p-3 z-10 bg-[#1e1e1e]">
  <audio id="audioPlayer" controls class="w-full"></audio>
</footer>

<div id="toast-container" class="toast-container"></div>
<div id="modal-container"></div>

<script>
// Variables
let audioPlayer;
let playlist = [];
let currentIndex = 0;
let repeatEach = 1;
let repeatCounter = 0;
const totalTracks = 315;
let trackListEl, allShlokasTitleEl, quizControlsEl, regularControlsEl, savePlaylistBtnEl;
let currentSpeed = 1.0;
let isQuizMode = false;
let hasQuizPaused = false;
let autoPlay = false;
let autoPlayTimeout = null;
let countdownInterval;
let currentQuizTime = 20;
let currentQuizDelay = 3;

// Check local storage
function isLocalStorageAvailable() {
  try {
    const test = '__localStorageTest__';
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch (e) {
    return false;
  }
}
const localStorageEnabled = isLocalStorageAvailable();

// Helper to play current track
function playCurrent() {
  if (!playlist || playlist.length === 0) {
    showToast("No tracks selected");
    return;
  }
  if (currentIndex >= playlist.length) {
    if (document.getElementById("repeatPlaylist").checked) {
      currentIndex = 0;
    } else {
      // End of playlist
      audioPlayer.pause();
      audioPlayer.src = "";
      return;
    }
  }
  const trackNum = playlist[currentIndex];
  if (trackNum == null || isNaN(trackNum)) {
    showToast("Invalid track");
    return;
  }
  const url = `https://ia601703.us.archive.org/35/items/satsang_diksha/sanskrit_${String(trackNum).padStart(3, '0')}.mp3`;
  audioPlayer.src = url;
  audioPlayer.playbackRate = currentSpeed;
  audioPlayer.play().catch(err => {
    console.error("Play error:", err);
    showToast("Failed to play track. Please check your connection.");
  });
}

// Toggle mode
function toggleMode() {
  isQuizMode = !isQuizMode;
  if (quizControlsEl && regularControlsEl) {
    quizControlsEl.classList.toggle('hidden', !isQuizMode);
    quizControlsEl.classList.toggle('fade-in', isQuizMode);
    quizControlsEl.classList.toggle('fade-out', !isQuizMode);
    regularControlsEl.classList.toggle('hidden', isQuizMode);
    regularControlsEl.classList.toggle('fade-out', isQuizMode);
    regularControlsEl.classList.toggle('fade-in', !isQuizMode);
  }
  // Update button text/icon
  const modeBtn = document.querySelector('button[onclick="toggleMode()"]');
  if (modeBtn) {
    modeBtn.innerHTML = `<i class="fa-solid fa-toggle-${isQuizMode ? 'on' : 'off'}"></i> ${isQuizMode ? 'Exit Quiz Mode' : 'Toggle to Quiz Mode'}`;
  }
  // Reset quiz mode state
  if (isQuizMode) {
    try { audioPlayer.pause(); } catch(e) {}
    try { audioPlayer.src = ''; } catch(e) {}
    playlist = [];
    currentIndex = 0;
    document.getElementById('playFullBtn').classList.add('hidden');
    if (document.getElementById('countdownBar')) document.getElementById('countdownBar').style.width = '100%';
    if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
  } else {
    if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
    if (autoPlayTimeout) { clearTimeout(autoPlayTimeout); autoPlayTimeout = null; }
    document.getElementById('quizStatus').textContent = '';
    document.getElementById('countdown').textContent = '';
    document.getElementById('playFullBtn').classList.add('hidden');
  }
  updateGroupButtonSelection();
}

// Toggle auto-play
function toggleAutoPlay() {
  autoPlay = !autoPlay;
  const btn = document.getElementById("autoPlayToggle");
  btn.innerHTML = `<i class="fa-solid fa-toggle-${autoPlay ? 'on' : 'off'}"></i> Auto-Play: ${autoPlay ? 'ON' : 'OFF'}`;
  btn.classList.toggle('btn-secondary', !autoPlay);
  btn.classList.toggle('btn-green', autoPlay);
}

// Play full shloka
function playFullShloka() {
  if (playlist.length === 0) {
    showToast("No playlist");
    return;
  }
  // Play the last played track, or currentIndex-1 if in middle
  const indexToPlay = (currentIndex > 0 && currentIndex <= playlist.length) ? currentIndex - 1 : 0;
  const trackNum = playlist[indexToPlay];
  if (trackNum == null || isNaN(trackNum)) {
    showToast("Invalid track");
    return;
  }
  const url = `https://ia601703.us.archive.org/35/items/satsang_diksha/sanskrit_${String(trackNum).padStart(3, '0')}.mp3`;
  audioPlayer.src = url;
  audioPlayer.playbackRate = currentSpeed;
  audioPlayer.play().catch(err => {
    console.error("Play error:", err);
    showToast("Failed to play track");
  });
  document.getElementById('playFullBtn').classList.add('hidden');
}

// Change quiz controls
function changeQuizTime(t) {
  currentQuizTime = t;
  document.getElementById("quizTimeDisplay").textContent = `${t}s`;
}
function changeQuizDelay(d) {
  currentQuizDelay = d;
  document.getElementById("quizDelayDisplay").textContent = `${d}s`;
}

// Toggle group display
function toggleGroupDisplay() {
  const groupsDiv = document.getElementById("groups");
  const hidden = groupsDiv.classList.toggle("hidden");
  const icon = document.getElementById("group-toggle-icon");
  icon.classList.toggle("fa-chevron-down", hidden);
  icon.classList.toggle("fa-chevron-up", !hidden);
}

// Clear current selection
function clearSelection() {
  document.querySelectorAll(".track-item.selected, .recent-item.selected, .playlist-item.selected").forEach(el => el.classList.remove("selected"));
  document.querySelectorAll(".trackBox:checked, .recent-box:checked, .playlist-box:checked").forEach(cb => { cb.checked = false; });
  document.querySelectorAll(".group-btn.selected").forEach(btn => btn.classList.remove("selected"));
  playlist = [];
  currentIndex = 0;
  updateGroupButtonSelection();
  showToast("Selection cleared");
}

function confirmClearSelection() {
  showModal("Are you sure you want to clear your current selection?", () => {
    clearSelection();
  });
}

function confirmClearHistory() {
  showModal("Are you sure you want to clear your recently played history? This action cannot be undone.", () => {
    clearHistory();
    showToast("History cleared");
  });
}
function confirmDeletePlaylist(name) {
  showModal(`Are you sure you want to delete the playlist "${name}"?`, () => {
    deletePlaylist(name);
  });
}

// Select range
function selectRange() {
  const start = parseInt(document.getElementById("rangeStart").value);
  const end = parseInt(document.getElementById("rangeEnd").value);
  if (isNaN(start) || isNaN(end) || start < 1 || end > totalTracks || start > end) {
    showModal("Please enter a valid shlok range");
    return;
  }
  document.querySelectorAll(".trackBox").forEach(cb => {
    const val = parseInt(cb.value);
    const checked = val >= start && val <= end;
    cb.checked = checked;
    cb.closest("label").classList.toggle("selected", checked);
  });
  updateGroupButtonSelection();
  showToast(`Shlok ${start}-${end} selected`);
}

// Toggle group button
function toggleGroup(start, end, element) {
  const isSelected = !element.classList.contains('selected');
  element.classList.toggle('selected', isSelected);
  element.setAttribute('aria-pressed', isSelected);
  for (let i = start; i <= end; i++) {
    const cb = document.querySelector(`.trackBox[value="${i}"]`);
    if (cb) {
      cb.checked = isSelected;
      cb.closest("label").classList.toggle("selected", isSelected);
    }
  }
  updateGroupButtonSelection();
}

// Change speed
function changeSpeed(speed) {
  currentSpeed = speed;
  audioPlayer.playbackRate = currentSpeed;
  document.getElementById("speedDisplay").textContent = speed.toFixed(1);
}

// Play selected tracks
function playSelected() {
  const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked")).map(cb => JSON.parse(cb.dataset.selection));
  const selectedTracks = Array.from(document.querySelectorAll(".trackBox:checked")).map(cb => parseInt(cb.value));
  let finalSelection = [];

  if (selectedPlaylists.length > 0) {
    const setShlokas = new Set(selectedPlaylists.flatMap(p => p));
    finalSelection = Array.from(setShlokas);
  } else {
    finalSelection = selectedTracks;
  }

  if (finalSelection.length === 0) {
    showModal("Select at least one shlok or playlist");
    return;
  }

  repeatEach = parseInt(document.getElementById("repeatCount").value) || 1;
  playlist = [...finalSelection];
  if (document.getElementById("shuffle").checked) {
    playlist.sort(() => Math.random() - 0.5);
  }
  currentIndex = 0;
  repeatCounter = 0;

  if (localStorageEnabled) {
    saveSelection(finalSelection);
  }
  playCurrent();
  showToast("Playing");
}

// Play next track in quiz mode
function playNextQuizTrack() {
  let selected = [];
  const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked")).map(cb => JSON.parse(cb.dataset.selection));
  const selectedRecents = Array.from(document.querySelectorAll(".recent-box:checked")).map(cb => cb.dataset.selection.split(",").map(n => parseInt(n.trim())));

  if (selectedPlaylists.length > 0) {
    const setShlokas = new Set(selectedPlaylists.flatMap(p => p));
    selected = Array.from(setShlokas);
  } else if (selectedRecents.length > 0) {
    const setNums = new Set(selectedRecents.flat());
    selected = Array.from(setNums);
  } else {
    selected = Array.from(document.querySelectorAll(".trackBox:checked")).map(cb => parseInt(cb.value));
  }

  if (selected.length === 0) {
    showModal("Select a group of shlokas or playlist for quiz");
    return;
  }

  if (playlist.length === 0 || currentIndex >= playlist.length) {
    playlist = [...selected].sort(() => Math.random() - 0.5);
    currentIndex = 0;
  }

  if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
  if (autoPlayTimeout) { clearTimeout(autoPlayTimeout); autoPlayTimeout = null; }

  document.getElementById('quizStatus').textContent = '';
  document.getElementById('playFullBtn').classList.add('hidden');

  const trackNum = playlist[currentIndex];
  if (trackNum == null || isNaN(trackNum)) {
    showToast("Invalid track");
    return;
  }

  document.getElementById('currentShlokQuiz').textContent = `Now playing: Shlok ${trackNum}`;
  audioPlayer.src = `https://ia601703.us.archive.org/35/items/satsang_diksha/sanskrit_${String(trackNum).padStart(3, '0')}.mp3`;
  audioPlayer.playbackRate = currentSpeed;
  audioPlayer.play().catch(err => {
    console.error("Play error:", err);
    showToast("Failed to play");
  });
  currentIndex++;
}

// Show modal
function showModal(msg, onConfirm = null) {
  const container = document.getElementById('modal-container');
  container.innerHTML = '';
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.setAttribute('role', 'dialog');
  modal.setAttribute('aria-modal', 'true');
  modal.innerHTML = `
    <div class="modal-content">
      <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
      <p class="mb-4">${msg}</p>
      ${onConfirm ? `
        <div class="flex gap-4 justify-center">
          <button class="px-4 py-3 btn-red text-white btn-rounded" id="modal-cancel">Cancel</button>
          <button class="px-4 py-3 btn-primary text-white btn-rounded" id="modal-confirm">OK</button>
        </div>` : `
        <button onclick="this.closest('.modal').remove()" class="px-4 py-3 btn-primary text-white btn-rounded">OK</button>
      `}
    </div>`;
  container.appendChild(modal);
  if (onConfirm) {
    document.getElementById('modal-confirm').addEventListener('click', () => { onConfirm(); modal.remove(); });
    document.getElementById('modal-cancel').addEventListener('click', () => modal.remove());
  }
  modal.querySelector('.modal-close').focus();
}

// Show toast
function showToast(msg) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.setAttribute('role', 'status');
  toast.setAttribute('aria-live', 'polite');
  toast.textContent = msg;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

// Generate groups
function generateGroups() {
  const container = document.getElementById("groups");
  container.innerHTML = "";
  for (let i = 1; i <= totalTracks; i += 10) {
    const end = Math.min(i + 9, totalTracks);
    const btn = document.createElement("button");
    btn.className = "group-btn";
    btn.setAttribute("tabindex", "0");
    btn.setAttribute("aria-pressed", "false");
    btn.dataset.start = i;
    btn.dataset.end = end;
    btn.innerHTML = `${i}â€“${end}<span class="checkmark">âœ“</span>`;
    btn.onclick = () => toggleGroup(i, end, btn);
    container.appendChild(btn);
  }
}

// Generate track list
function generateTracks() {
  const ul = document.getElementById("trackList");
  ul.innerHTML = "";
  for (let i = 1; i <= totalTracks; i++) {
    ul.innerHTML += `
      <li>
        <label class="track-item block p-3 text-white">
          <input type="checkbox" value="${i}" class="trackBox"/>
          <span class="ml-6">Shlok ${i}</span>
        </label>
      </li>`;
  }
}

// Set up event listeners
document.addEventListener("DOMContentLoaded", () => {
  // References
  audioPlayer = document.getElementById("audioPlayer");
  trackListEl = document.getElementById("trackList");
  allShlokasTitleEl = document.getElementById("allShlokasTitle");
  quizControlsEl = document.getElementById("quizControls");
  regularControlsEl = document.getElementById("regularControls");
  savePlaylistBtnEl = document.getElementById("savePlaylistBtn");

  // Generate data
  generateTracks();
  generateGroups();

  if (localStorageEnabled) {
    restoreLastSelection();
    renderRecentSelections();
    renderPersonalPlaylists();
  } else {
    showToast("Local storage is disabled");
  }

  // Search input
  document.getElementById("search").addEventListener("input", e => {
    const term = e.target.value.trim().toLowerCase();
    let found = false;
    document.querySelectorAll("#trackList li").forEach(li => {
      const val = li.querySelector(".trackBox").value;
      if (!term || val.startsWith(term)) {
        li.classList.remove("hidden");
        found = true;
      } else {
        li.classList.add("hidden");
      }
    });
    document.getElementById("search-feedback").classList.toggle("hidden", found);
    document.getElementById("clearSearch").classList.toggle("hidden", term === "");
  });
  document.getElementById("clearSearch").addEventListener("click", () => {
    document.getElementById("search").value = "";
    document.getElementById("search").dispatchEvent(new Event('input'));
  });

  // Checkbox change for tracks
  document.querySelectorAll(".trackBox").forEach(cb => {
    cb.addEventListener("change", () => {
      cb.closest("label").classList.toggle("selected", cb.checked);
      updateGroupButtonSelection();
    });
  });

  // Recent list change
  document.getElementById("recentList").addEventListener("change", e => {
    if (e.target.classList.contains("recent-box")) {
      // Clear all
      document.querySelectorAll(".track-item.selected, .recent-item.selected").forEach(el => el.classList.remove("selected"));
      document.querySelectorAll(".trackBox, .recent-box").forEach(c => { c.checked = false; c.closest("label").classList.remove("selected"); });
      // Apply selection
      const selectedRecents = Array.from(document.querySelectorAll(".recent-box:checked"));
      const allNumbers = new Set(selectedRecents.flatMap(cb => cb.dataset.selection.split(",").map(n => parseInt(n.trim()))));
      document.querySelectorAll(".trackBox").forEach(cb => {
        const trackNum = parseInt(cb.value);
        if (allNumbers.has(trackNum)) {
          cb.checked = true;
          cb.closest("label").classList.add("selected");
        }
      });
      selectedRecents.forEach(cb => cb.closest("label").classList.add("selected"));
      updateGroupButtonSelection();
    }
  });

  // Playlist list change
  document.getElementById("playlistList").addEventListener("change", e => {
    if (e.target.classList.contains("playlist-box")) {
      // Clear previous
      document.querySelectorAll(".track-item.selected, .recent-item.selected").forEach(el => el.classList.remove("selected"));
      document.querySelectorAll(".trackBox, .recent-box").forEach(c => { c.checked = false; c.closest("label").classList.remove("selected"); });
      // Apply
      const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked"));
      const allNumbers = new Set(selectedPlaylists.flatMap(cb => JSON.parse(cb.dataset.selection)));
      document.querySelectorAll(".trackBox").forEach(cb => {
        const trackNum = parseInt(cb.value);
        if (allNumbers.has(trackNum)) {
          cb.checked = true;
          cb.closest("label").classList.add("selected");
        }
      });
      selectedPlaylists.forEach(cb => cb.closest("label").classList.add("selected"));
      updateGroupButtonSelection();
    }
  });

  // Audio events
  audioPlayer.addEventListener("error", () => {
    showToast("Error loading audio");
  });
  audioPlayer.addEventListener("playing", () => {
    if (isQuizMode && !hasQuizPaused) {
      document.getElementById('playFullBtn').classList.add('hidden');
      setTimeout(() => {
        audioPlayer.pause();
        hasQuizPaused = true;
        document.getElementById('quizStatus').textContent = "Audio Paused. Your turn to recite!";
        document.getElementById('playFullBtn').classList.remove('hidden');

        let countdown = currentQuizTime;
        const countdownEl = document.getElementById('countdown');
        countdownEl.textContent = `(${countdown}s)`;
        document.getElementById('countdownBar').style.width = `${(countdown / currentQuizTime) * 100}%`;

        if (countdownInterval) clearInterval(countdownInterval);
        countdownInterval = setInterval(() => {
          countdown--;
          countdownEl.textContent = `(${countdown}s)`;
          document.getElementById('countdownBar').style.width = `${(countdown / currentQuizTime) * 100}%`;
          if (countdown <= 0) {
            clearInterval(countdownInterval);
            countdownInterval = null;
            countdownEl.textContent = '';
            document.getElementById('quizStatus').textContent = '';
            if (autoPlay) {
              playNextQuizTrack();
            }
          }
        }, 1000);
      }, currentQuizDelay * 1000);
    }
  });
  // End of DOMContentLoaded
});

// Functions for UI controls
function toggleGroupDisplay() {
  const groupsDiv = document.getElementById("groups");
  const hidden = groupsDiv.classList.toggle("hidden");
  const icon = document.getElementById("group-toggle-icon");
  icon.classList.toggle("fa-chevron-down", hidden);
  icon.classList.toggle("fa-chevron-up", !hidden);
}

function clearSelection() {
  document.querySelectorAll(".track-item.selected, .recent-item.selected, .playlist-item.selected").forEach(el => el.classList.remove("selected"));
  document.querySelectorAll(".trackBox:checked, .recent-box:checked, .playlist-box:checked").forEach(cb => { cb.checked = false; });
  document.querySelectorAll(".group-btn.selected").forEach(btn => btn.classList.remove("selected"));
  playlist = [];
  currentIndex = 0;
  updateGroupButtonSelection();
  showToast("Selection cleared");
}

function confirmClearSelection() {
  showModal("Are you sure you want to clear your current selection?", () => { clearSelection(); });
}

function confirmClearHistory() {
  showModal("Clear history?", () => { clearHistory(); showToast("History cleared"); });
}
function confirmDeletePlaylist(name) {
  showModal(`Are you sure you want to delete "${name}"?`, () => { deletePlaylist(name); });
}

function selectRange() {
  const start = parseInt(document.getElementById("rangeStart").value);
  const end = parseInt(document.getElementById("rangeEnd").value);
  if (isNaN(start) || isNaN(end) || start < 1 || end > totalTracks || start > end) {
    showModal("Invalid range");
    return;
  }
  document.querySelectorAll(".trackBox").forEach(cb => {
    const val = parseInt(cb.value);
    const checked = val >= start && val <= end;
    cb.checked = checked;
    cb.closest("label").classList.toggle("selected", checked);
  });
  updateGroupButtonSelection();
  showToast(`Shlok ${start}-${end} selected`);
}

function toggleGroup(start, end, element) {
  const isSelected = !element.classList.contains('selected');
  element.classList.toggle('selected', isSelected);
  element.setAttribute('aria-pressed', isSelected);
  for (let i = start; i <= end; i++) {
    const cb = document.querySelector(`.trackBox[value="${i}"]`);
    if (cb) {
      cb.checked = isSelected;
      cb.closest("label").classList.toggle("selected", isSelected);
    }
  }
  updateGroupButtonSelection();
}

function changeSpeed(speed) {
  currentSpeed = speed;
  audioPlayer.playbackRate = currentSpeed;
  document.getElementById("speedDisplay").textContent = speed.toFixed(1);
}

function playSelected() {
  // Collect selected playlists and tracks
  const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked")).map(cb => JSON.parse(cb.dataset.selection));
  const selectedTracks = Array.from(document.querySelectorAll(".trackBox:checked")).map(cb => parseInt(cb.value));
  let finalSelection = [];

  if (selectedPlaylists.length > 0) {
    const setShlokas = new Set(selectedPlaylists.flatMap(p => p));
    finalSelection = Array.from(setShlokas);
  } else {
    finalSelection = selectedTracks;
  }

  if (finalSelection.length === 0) {
    showModal("Select at least one shlok");
    return;
  }

  repeatEach = parseInt(document.getElementById("repeatCount").value) || 1;
  playlist = [...finalSelection];
  if (document.getElementById("shuffle").checked) {
    playlist.sort(() => Math.random() - 0.5);
  }
  currentIndex = 0;
  repeatCounter = 0;
  if (localStorageEnabled) saveSelection(finalSelection);
  playCurrent();
  showToast("Playing");
}

// Play next in quiz mode
function playNextQuizTrack() {
  let selected = [];
  const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked")).map(cb => JSON.parse(cb.dataset.selection));
  const selectedRecents = Array.from(document.querySelectorAll(".recent-box:checked")).map(cb => cb.dataset.selection.split(",").map(n => parseInt(n.trim())));

  if (selectedPlaylists.length > 0) {
    const setShlokas = new Set(selectedPlaylists.flatMap(p => p));
    selected = Array.from(setShlokas);
  } else if (selectedRecents.length > 0) {
    const setNums = new Set(selectedRecents.flat());
    selected = Array.from(setNums);
  } else {
    selected = Array.from(document.querySelectorAll(".trackBox:checked")).map(cb => parseInt(cb.value));
  }

  if (selected.length === 0) {
    showModal("Select a group of shlokas or playlist");
    return;
  }

  if (playlist.length === 0 || currentIndex >= playlist.length) {
    playlist = [...selected].sort(() => Math.random() - 0.5);
    currentIndex = 0;
  }

  if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
  if (autoPlayTimeout) { clearTimeout(autoPlayTimeout); autoPlayTimeout = null; }

  document.getElementById('quizStatus').textContent = '';
  document.getElementById('playFullBtn').classList.add('hidden');

  const trackNum = playlist[currentIndex];
  if (trackNum == null || isNaN(trackNum)) {
    showToast("Invalid track");
    return;
  }

  document.getElementById('currentShlokQuiz').textContent = `Now playing: Shlok ${trackNum}`;
  audioPlayer.src = `https://ia601703.us.archive.org/35/items/satsang_diksha/sanskrit_${String(trackNum).padStart(3, '0')}.mp3`;
  audioPlayer.playbackRate = currentSpeed;
  audioPlayer.play().catch(err => {
    console.error("Play error:", err);
    showToast("Failed to play");
  });
  currentIndex++;
}

// Save playlist modal
function showSavePlaylistModal() {
  if (!localStorageEnabled) {
    showModal("Local storage not available");
    return;
  }
  const selectedTracks = Array.from(document.querySelectorAll(".trackBox:checked")).map(cb => parseInt(cb.value));
  if (selectedTracks.length === 0) {
    showModal("Select at least one shlok");
    return;
  }
  const container = document.getElementById('modal-container');
  container.innerHTML = '';
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
      <h3 class="text-xl font-bold mb-4">Save Playlist</h3>
      <p class="mb-2">Enter a name:</p>
      <input type="text" id="playlistNameInput" class="w-full mb-4" placeholder="My playlist"/>
      <div id="playlistNameFeedback" class="text-red-400 font-semibold hidden mb-4"></div>
      <div class="flex gap-4 justify-end">
        <button class="px-4 py-3 btn-secondary text-white btn-rounded" onclick="this.closest('.modal').remove()">Cancel</button>
        <button class="px-4 py-3 btn-green text-white btn-rounded" id="savePlaylistConfirm">Save</button>
      </div>
    </div>`;
  container.appendChild(modal);
  const inputEl = document.getElementById('playlistNameInput');
  const feedbackEl = document.getElementById('playlistNameFeedback');
  document.getElementById('savePlaylistConfirm').addEventListener('click', () => {
    const name = inputEl.value.trim();
    if (!name) {
      feedbackEl.textContent = "Name cannot be empty";
      feedbackEl.classList.remove('hidden');
      return;
    }
    let playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
    if (playlists[name]) {
      feedbackEl.textContent = "Name exists";
      feedbackEl.classList.remove('hidden');
      return;
    }
    playlists[name] = selectedTracks;
    localStorage.setItem("personalPlaylists", JSON.stringify(playlists));
    renderPersonalPlaylists();
    showToast(`Playlist "${name}" saved`);
    modal.remove();
  });
  inputEl.focus();
}

// Render personal playlists
function renderPersonalPlaylists() {
  if (!localStorageEnabled) return;
  const playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
  const ul = document.getElementById("playlistList");
  ul.innerHTML = "";
  const names = Object.keys(playlists);
  if (names.length === 0) {
    document.getElementById("playlist-empty").classList.remove("hidden");
  } else {
    document.getElementById("playlist-empty").classList.add("hidden");
  }
  names.forEach(name => {
    const shlokas = playlists[name];
    ul.innerHTML += `
      <li>
        <label class="playlist-item block p-3 container-card cursor-pointer flex items-center justify-between">
          <div class="flex items-center">
            <input type="checkbox" class="playlist-box" data-selection='${JSON.stringify(shlokas)}'/>
            <span class="ml-6 font-semibold">${name}</span>
          </div>
          <div class="flex items-center space-x-2 text-sm text-gray-400">
            <span>(${shlokas.length} shlokas)</span>
            <button onclick="loadPlaylist('${name.replace(/'/g, "\\'")}')" class="text-xs px-2 py-1 btn-secondary rounded-full">Load</button>
            <button onclick="confirmDeletePlaylist('${name.replace(/'/g, "\\'")}')" class="text-xs px-2 py-1 btn-red rounded-full">Delete</button>
          </div>
        </label>
      </li>`;
  });
}

function loadPlaylist(name) {
  if (!localStorageEnabled) return;
  const playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
  const shlokas = playlists[name];
  if (shlokas) {
    // Clear previous
    clearSelection();
    shlokas.forEach(trackNum => {
      const checkbox = document.querySelector(`.trackBox[value="${trackNum}"]`);
      if (checkbox) {
        checkbox.checked = true;
        checkbox.closest("label").classList.add("selected");
      }
    });
    updateGroupButtonSelection();
    showToast(`Playlist "${name}" loaded`);
  }
}

function deletePlaylist(name) {
  if (!localStorageEnabled) return;
  let playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
  delete playlists[name];
  localStorage.setItem("personalPlaylists", JSON.stringify(playlists));
  renderPersonalPlaylists();
}

// Save selection to recent
function saveSelection(selection) {
  if (!localStorageEnabled) return;
  let history = [];
  try {
    history = JSON.parse(localStorage.getItem("recentSelections")) || [];
  } catch(e) {}
  const selStr = selection.join(",");
  // Remove duplicates
  history = [selStr, ...history.filter(h => h !== selStr)].slice(0, 5);
  localStorage.setItem("recentSelections", JSON.stringify(history));
  renderRecentSelections();
}

function clearHistory() {
  if (!localStorageEnabled) return;
  localStorage.removeItem("recentSelections");
  renderRecentSelections();
}

function renderRecentSelections() {
  if (!localStorageEnabled) return;
  const history = JSON.parse(localStorage.getItem("recentSelections")) || [];
  const ul = document.getElementById("recentList");
  const recentDiv = document.getElementById("recentlyPlayed");
  const recentEmpty = document.getElementById("recent-empty");
  ul.innerHTML = "";
  if (history.length === 0) {
    recentDiv.classList.add("hidden");
    recentEmpty.classList.remove("hidden");
    return;
  }
  recentDiv.classList.remove("hidden");
  recentEmpty.classList.add("hidden");
  history.forEach(sel => {
    const numbers = sel.split(",").map(n => parseInt(n.trim()));
    let labelText = (numbers.length <= 6) ? "Shlok " + numbers.join(", ") : `Shlok ${numbers[0]}â€“${numbers[numbers.length - 1]} (${numbers.length} total)`;
    ul.innerHTML += `
      <li>
        <label class="recent-item block p-3 container-card cursor-pointer">
          <input type="checkbox" class="recent-box" data-selection="${sel}"/>
          <span class="ml-6">${labelText}</span>
        </label>
      </li>`;
  });
}

// Restore last selection
function restoreLastSelection() {
  if (!localStorageEnabled) return;
  const history = JSON.parse(localStorage.getItem("recentSelections")) || [];
  if (history.length > 0) {
    const lastSel = history[0].split(",").map(n => parseInt(n.trim()));
    // Clear previous
    clearSelection();
    // Apply new
    lastSel.forEach(trackNum => {
      const checkbox = document.querySelector(`.trackBox[value="${trackNum}"]`);
      if (checkbox) {
        checkbox.checked = true;
        checkbox.closest("label").classList.add("selected");
      }
    });
    updateGroupButtonSelection();
  }
}

function updateGroupButtonSelection() {
  const selectedTracks = new Set(Array.from(document.querySelectorAll(".trackBox:checked")).map(cb => parseInt(cb.value)));
  document.querySelectorAll(".group-btn").forEach(btn => {
    const start = parseInt(btn.dataset.start);
    const end = parseInt(btn.dataset.end);
    if (isNaN(start) || isNaN(end)) return;
    let isGroupSelected = true;
    for (let i = start; i <= end; i++) {
      if (!selectedTracks.has(i)) {
        isGroupSelected = false;
        break;
      }
    }
    btn.classList.toggle('selected', isGroupSelected);
    btn.setAttribute('aria-pressed', isGroupSelected);
  });
  // button hide/show
  if (savePlaylistBtnEl) {
    savePlaylistBtnEl.classList.toggle('hidden', selectedTracks.size === 0 || isQuizMode);
  }
}

// Generate group buttons
function generateGroups() {
  const container = document.getElementById("groups");
  container.innerHTML = "";
  for (let i = 1; i <= totalTracks; i += 10) {
    const end = Math.min(i + 9, totalTracks);
    const btn = document.createElement("button");
    btn.className = "group-btn";
    btn.setAttribute("tabindex", "0");
    btn.setAttribute("aria-pressed", "false");
    btn.dataset.start = i;
    btn.dataset.end = end;
    btn.innerHTML = `${i}â€“${end}<span class="checkmark">âœ“</span>`;
    btn.onclick = () => toggleGroup(i, end, btn);
    container.appendChild(btn);
  }
}

// Generate tracks list
function generateTracks() {
  const ul = document.getElementById("trackList");
  ul.innerHTML = "";
  for (let i = 1; i <= totalTracks; i++) {
    ul.innerHTML += `
      <li>
        <label class="track-item block p-3 text-white">
          <input type="checkbox" value="${i}" class="trackBox"/>
          <span class="ml-6">Shlok ${i}</span>
        </label>
      </li>`;
  }
}
</script>
</body>
</html>
