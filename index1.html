<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shloka Audio Player & Quiz Utility</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/20GQR+q1U/G1bYfQYy9kH9hT7p0uE/I8T2OQ+YQ+c2wJpC8XvPqjG6Jg==' crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #1c1c1e; /* Darkest Background */
            --container-bg: #2c2c2e; /* Card/Section Background */
            --card-bg: #2e2e30; /* Lighter Card Background */
            --text-color: #f2f2f7; /* Light Text */
            --secondary-text: #a0a0a0; /* Grey Secondary Text */
            --primary-color: #4CAF50; /* Primary Green */
            --secondary-color: #607D8B; /* Secondary Grey-Blue */
            --red-color: #F44336; /* Red */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* Utility classes specific to the Apple UI look that Tailwind can't handle alone */
        .container-card {
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* The custom selection indicator styling */
        .track-item, .recent-item, .playlist-item {
            position: relative;
            padding: 0.75rem 1rem 0.75rem 3.5rem !important; 
            transition: background-color 0.15s;
        }

        .track-item input[type="checkbox"], 
        .recent-item input[type="checkbox"], 
        .playlist-item input[type="checkbox"] {
            position: absolute; 
            opacity: 0;
            cursor: pointer;
        }
        
        .track-item input[type="checkbox"] + span::before,
        .recent-item input[type="checkbox"] + span::before,
        .playlist-item input[type="checkbox"] + span::before {
            content: '';
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 1px solid var(--secondary-text);
            background-color: transparent;
            border-radius: 50%; 
            transition: all 0.2s;
        }
        
        .track-item input[type="checkbox"]:checked + span::before,
        .recent-item input[type="checkbox"]:checked + span::before,
        .playlist-item input[type="checkbox"]:checked + span::before {
            content: '✓';
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: bold;
            line-height: 18px;
            background-color: var(--primary-color);
            color: var(--text-color);
            text-align: center;
            border-color: var(--primary-color);
        }
        
        .track-item.selected, .recent-item.selected, .playlist-item.selected {
            background-color: var(--card-bg); 
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        
        /* Groups styling */
        .group-btn {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--secondary-text);
            padding: 6px 10px;
            border-radius: 50px;
            font-size: 0.85rem;
            position: relative;
        }

        .group-btn:hover {
            border-color: var(--primary-color);
        }

        .group-btn.selected {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--text-color);
        }
        
        /* Audio Bar Styling */
        #audioControls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(46, 46, 48, 0.95); /* Semi-transparent card-bg */
            backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
        }

        /* Modal Styles */
        #modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 400px;
            position: relative;
        }
        
        /* Quiz Countdown Bar */
        #countdownBarContainer {
            width: 100%;
            background-color: #555;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        #countdownBar {
            height: 8px;
            width: 100%;
            background-color: var(--red-color);
            transition: width 1s linear;
        }
        
        /* Hide default audio controls */
        #audioPlayer {
            width: 100%;
            max-width: 400px;
            margin-right: 1rem;
            display: none; 
        }
    </style>
</head>
<body class="p-0 m-0">

    <div class="max-w-4xl mx-auto p-4 pb-28">
        <div class="text-center pb-4 mb-4 border-b border-gray-700">
            <h1 class="text-3xl font-bold mb-1">Shloka Study Tool</h1>
            <p class="text-secondary-text">Select tracks below to start listening or quizzing.</p>
        </div>

        <div class="flex bg-gray-700 p-1 rounded-lg mb-6">
            <button id="mode-play" class="flex-grow py-2 text-center text-sm font-semibold rounded-lg transition-colors bg-primary-color" onclick="setMode('play')">
                <i class="fas fa-headphones mr-2"></i> Listen Mode
            </button>
            <button id="mode-quiz" class="flex-grow py-2 text-center text-sm font-semibold rounded-lg transition-colors" onclick="setMode('quiz')">
                <i class="fas fa-brain mr-2"></i> Quiz Mode
            </button>
        </div>
        
        <div id="settings" class="container-card p-4 mb-6">
            <h2 class="text-xl font-bold mb-3">Settings</h2>
            
            <div class="space-y-4">
                <label class="block font-medium">Playback Speed: <span id="speedValue" class="text-primary-color ml-2">1.0x</span></label>
                <input type="range" id="speedSlider" min="0.5" max="2" value="1" step="0.25" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">

                <div id="quizSettings" class="space-y-4">
                    <hr class="border-gray-700">
                    <label class="block font-medium">Audio Play Delay (before pause): <span id="quizDelayValue" class="text-primary-color ml-2">3s</span></label>
                    <input type="range" id="quizDelaySlider" min="1" max="10" value="3" step="1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                    
                    <label class="block font-medium">Recite Time (Quiz Pause): <span id="quizTimeValue" class="text-primary-color ml-2">10s</span></label>
                    <input type="range" id="quizTimeSlider" min="5" max="30" value="10" step="5" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                    
                    <label class="block font-medium">Repeat Each Shlok: <span id="repeatEachValue" class="text-primary-color ml-2">1 time</span></label>
                    <input type="range" id="repeatEach" min="1" max="5" value="1" step="1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">

                    <div class="flex items-center pt-2">
                        <input type="checkbox" id="autoPlayToggle" checked class="form-checkbox h-5 w-5 text-primary-color rounded border-gray-500 bg-gray-700">
                        <label for="autoPlayToggle" class="ml-3 text-sm font-medium cursor-pointer">Auto-play next track after quiz time ends</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="personalPlaylists" class="container-card p-4 mb-6 hidden">
            <h2 class="text-xl font-bold mb-3">Your Playlists</h2>
            <p id="playlist-empty" class="text-sm text-secondary-text hidden">No playlists saved yet. Select tracks and click "Save Selection as Playlist".</p>
            <ul id="playlistList" class="divide-y divide-gray-700">
                </ul>
        </div>
        
        <div id="recentlyPlayed" class="container-card p-4 mb-6 hidden">
            <h2 class="text-xl font-bold mb-3 flex items-center justify-between">
                <span>Recently Played (Quick Select)</span>
                <button class="text-xs px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-full font-semibold transition-colors" onclick="clearHistory()">Clear History</button>
            </h2>
            <ul id="recentList" class="divide-y divide-gray-700">
                </ul>
            <p id="recent-empty" class="text-sm mt-2 text-secondary-text hidden">No recent selections saved.</p>
        </div>


        <div class="container-card p-4 mb-6">
            <h2 id="allShlokasTitle" class="text-xl font-bold mb-4">Select Individual Shlokas</h2>
            
            <div class="flex space-x-3 mb-4">
                <button id="clearAllBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg font-semibold transition-colors" onclick="clearSelection()">Clear All Selections</button>
                <button id="savePlaylistBtn" class="px-4 py-2 bg-primary-color hover:bg-green-600 text-white rounded-lg font-semibold transition-colors hidden" onclick="showSavePlaylistModal()">
                    <i class="fas fa-save mr-2"></i> Save Selection as Playlist
                </button>
            </div>
            
            <div id="groups" class="flex flex-wrap gap-2 mt-2 mb-4 justify-start">
                </div>

            <div class="relative mb-4">
                <input type="number" id="search" placeholder="Filter by Shlok number (e.g., 55)" class="w-full p-3 bg-gray-700 text-white rounded-lg focus:ring-2 focus:ring-primary-color focus:outline-none">
                <button id="clearSearch" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white hidden" style="line-height: 1;" onclick="document.getElementById('search').value='';document.getElementById('search').dispatchEvent(new Event('input'))">
                    <i class="fas fa-times-circle text-lg"></i>
                </button>
            </div>
            <p id="search-feedback" class="text-red-400 font-semibold hidden mb-4 text-center">No shlokas found matching the filter.</p>
            
            <ul id="trackList" class="divide-y divide-gray-700">
                </ul>
        </div>
    </div>

    <div id="audioControls">
        
        <div id="regularControls" class="flex items-center justify-between">
            <div class="flex flex-col">
                <span class="text-sm text-secondary-text">Current Track:</span>
                <div id="currentShlok" class="text-lg font-semibold">Nothing selected.</div>
            </div>
            <button class="px-6 py-2 bg-primary-color hover:bg-green-600 text-white rounded-full font-bold transition-colors shadow-lg" onclick="playSelected()">
                <i class="fas fa-play mr-2"></i> Start/Restart Playback
            </button>
        </div>
        
        <div id="quizControls" class="hidden flex items-center w-full space-x-4">
            <div class="flex-grow">
                <div id="currentShlokQuiz" class="text-lg font-semibold">Start the Quiz to begin.</div>
                <div id="quizStatus" class="text-sm text-red-400 font-medium mt-1"></div>
                <div id="countdownBarContainer">
                    <div id="countdownBar"></div>
                </div>
            </div>
            
            <div class="flex items-center space-x-2">
                <span id="countdown" class="text-sm text-secondary-text w-10 text-right"></span>
                <button class="px-4 py-2 bg-primary-color hover:bg-green-600 text-white rounded-lg font-bold transition-colors" onclick="playNextQuizTrack()">
                    <i class="fas fa-forward"></i> Next
                </button>
                <button id="playFullBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg font-bold transition-colors hidden" onclick="playFullAudio()">
                    <i class="fas fa-volume-up"></i> Hint
                </button>
            </div>
        </div>

        <audio id="audioPlayer"></audio>
    </div>

    <div id="modal-container" class="hidden">
        </div>

    <div id="toast-container" class="fixed bottom-24 right-4 z-900 space-y-2">
        </div>

    <script>
        // --- GLOBAL STATE ---
        let audioPlayer;
        let isQuizMode = false;
        let playlist = [];
        let currentIndex = 0;
        let currentSpeed = 1.0;
        let repeatEach = 1;
        let repeatCounter = 0;
        let currentQuizTime = 10;
        let currentQuizDelay = 3;
        let hasQuizPaused = false;
        let countdownInterval = null;
        let autoPlayTimeout = null;
        let autoPlay = true;
        let totalTracks = 315; // The total number of shlokas
        let localStorageEnabled = typeof localStorage !== 'undefined';
        
        // DOM element references (to be assigned in DOMContentLoaded)
        let trackListEl;
        let allShlokasTitleEl;
        let quizControlsEl;
        let regularControlsEl;
        let savePlaylistBtnEl;
        let modalContainerEl;

        // --- CORE LOGIC ---

        function changeSpeed(speed) {
            currentSpeed = speed;
            audioPlayer.playbackRate = currentSpeed;
            document.getElementById("speedValue").textContent = `${speed}x`;
            if (localStorageEnabled) localStorage.setItem("playbackSpeed", speed);
        }

        function changeQuizTime(time) {
            currentQuizTime = time;
            document.getElementById("quizTimeValue").textContent = `${time}s`;
            if (localStorageEnabled) localStorage.setItem("quizTime", time);
        }
        
        function changeQuizDelay(delay) {
            currentQuizDelay = delay;
            document.getElementById("quizDelayValue").textContent = `${delay}s`;
            if (localStorageEnabled) localStorage.setItem("quizDelay", delay);
        }

        function changeRepeatEach(times) {
            repeatEach = times;
            document.getElementById("repeatEachValue").textContent = `${times} time${times > 1 ? 's' : ''}`;
            if (localStorageEnabled) localStorage.setItem("repeatEach", times);
        }
        
        document.getElementById('autoPlayToggle').addEventListener('change', (e) => {
            autoPlay = e.target.checked;
            if (localStorageEnabled) localStorage.setItem("autoPlay", autoPlay);
        });
        
        document.getElementById('repeatEach').addEventListener('input', function() {
            changeRepeatEach(parseInt(this.value));
        });
        
        function setMode(mode) {
            const isQuiz = mode === 'quiz';
            isQuizMode = isQuiz;
            document.getElementById('mode-play').classList.toggle('bg-primary-color', !isQuiz);
            document.getElementById('mode-play').classList.toggle('text-white', !isQuiz);
            document.getElementById('mode-quiz').classList.toggle('bg-primary-color', isQuiz);
            document.getElementById('mode-quiz').classList.toggle('text-white', isQuiz);
            document.getElementById('mode-play').classList.toggle('bg-transparent', isQuiz);
            document.getElementById('mode-quiz').classList.toggle('bg-transparent', !isQuiz);
            document.getElementById('mode-play').classList.toggle('text-secondary-text', isQuiz);
            document.getElementById('mode-quiz').classList.toggle('text-secondary-text', !isQuiz);
            
            allShlokasTitleEl.textContent = isQuiz ? "Select Shlokas for Quiz Source" : "Select Individual Shlokas";
            quizControlsEl.classList.toggle('hidden', !isQuiz);
            regularControlsEl.classList.toggle('hidden', isQuiz);
            document.getElementById('quizSettings').classList.toggle('hidden', !isQuiz);
            document.getElementById('clearAllBtn').textContent = isQuiz ? "Clear Quiz Selection" : "Clear All Selections";
            
            // Re-evaluate save button visibility
            const selectedTracks = Array.from(document.querySelectorAll(".trackBox:checked"));
            savePlaylistBtnEl.classList.toggle('hidden', selectedTracks.length === 0 || isQuiz);
            
            // Clear any active playback/quiz state
            if (countdownInterval) clearInterval(countdownInterval);
            if (autoPlayTimeout) clearTimeout(autoPlayTimeout);
            audioPlayer.pause();
            audioPlayer.src = "";
            document.getElementById('currentShlok').textContent = "Nothing selected.";
            document.getElementById('currentShlokQuiz').textContent = "Start the Quiz to begin.";
            document.getElementById('quizStatus').textContent = "";
            document.getElementById('countdown').textContent = "";
            document.getElementById('playFullBtn').classList.add('hidden');
            document.getElementById('countdownBar').style.width = '100%';
            modalContainerEl.classList.add('hidden');

            // Reset playlist state
            playlist = [];
            currentIndex = 0;
            repeatCounter = 0;
        }

        function playFullAudio() {
            if (countdownInterval) clearInterval(countdownInterval);
            document.getElementById('countdown').textContent = '';
            document.getElementById('quizStatus').textContent = 'Playing full shlok...';
            document.getElementById('playFullBtn').classList.add('hidden');
            
            // Play the track from the start
            audioPlayer.currentTime = 0;
            audioPlayer.play();

            // Set a flag to prevent the short-play logic from running on the full playback
            hasQuizPaused = false;
            
            // Listen for 'ended' event to automatically proceed
            function onEnded() {
                audioPlayer.removeEventListener('ended', onEnded);
                document.getElementById('quizStatus').textContent = '';
                if (autoPlay) {
                    playNextQuizTrack();
                }
            }
            audioPlayer.addEventListener('ended', onEnded);
        }

        // NEW UTILITY FUNCTION: Consolidate Track Selection Logic (Robustness Update #2)
        function getSelectedTracks(includeRecents = false) {
            // 1. Check for selected Playlists (highest priority)
            const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked"))
                .flatMap(cb => JSON.parse(cb.dataset.selection));

            if (selectedPlaylists.length > 0) {
                return Array.from(new Set(selectedPlaylists));
            }
            
            // 2. Check for selected Recent Selections (if flag is true)
            if (includeRecents) {
                const selectedRecents = Array.from(document.querySelectorAll(".recent-box:checked"))
                    .flatMap(cb => cb.dataset.selection.split(",").map(n => parseInt(n.trim())));
                    
                if (selectedRecents.length > 0) {
                    return Array.from(new Set(selectedRecents));
                }
            }
            
            // 3. Fall back to individual track selections
            return Array.from(document.querySelectorAll(".trackBox:checked"))
                .map(cb => parseInt(cb.value, 10));
        }

        // UPDATED playNextQuizTrack: Using getSelectedTracks(true) (Robustness Update #2)
        function playNextQuizTrack() {
            const selected = getSelectedTracks(true); // Refactored to use new utility function
            
            if (selected.length === 0) {
                showModal("Please select a group of shlokas or a playlist to quiz yourself on first!");
                return;
            }

            // Shuffle/Reload playlist if exhausted or uninitialized
            if (playlist.length === 0 || currentIndex >= playlist.length) {
                // Save this selection to history for quick recall (only save when starting a new full cycle)
                saveSelection(selected); 
                playlist = [...selected].sort(() => Math.random() - 0.5);
                currentIndex = 0;
                showToast(`Starting new quiz session with ${playlist.length} unique shlokas!`);
            }

            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            clearTimeout(autoPlayTimeout);
            document.getElementById('quizStatus').textContent = '';
            document.getElementById('playFullBtn').classList.add('hidden');
            document.getElementById('countdown').textContent = '';

            const trackNum = playlist[currentIndex];
            document.getElementById('currentShlokQuiz').textContent = `Now playing hint for: Shlok ${trackNum}`;
            
            // Prepare audio
            audioPlayer.src = `https://ia601703.us.archive.org/35/items/satsang_diksha/sanskrit_${String(trackNum).padStart(3, '0')}.mp3`;
            audioPlayer.playbackRate = currentSpeed;
            
            hasQuizPaused = false;
            document.getElementById('countdownBar').style.width = '100%';
            audioPlayer.play().catch(err => {
                showToast("Failed to play track. Please check your connection or try again.");
                console.log("Play error:", err);
            });

            currentIndex++;
        }

        // Regular Playback Mode
        function playSelected() {
            if (isQuizMode) {
                playNextQuizTrack(); // Delegate to quiz function if mode is mistakenly left on
                return;
            }

            // Use getSelectedTracks(false) for regular play, prioritizing playlists > individual tracks
            const finalSelection = getSelectedTracks(false); 

            if (finalSelection.length === 0) {
                showModal("Please select at least one shloka, a group, or a playlist to start playback.");
                return;
            }
            
            // Save the selection to history
            saveSelection(finalSelection);

            // Re-initialize playlist for linear playback
            playlist = [...finalSelection].sort((a, b) => a - b);
            currentIndex = 0;
            repeatCounter = 0;
            
            playCurrent();
        }

        function playCurrent() {
            if (playlist.length === 0) {
                audioPlayer.pause();
                document.getElementById('currentShlok').textContent = "Playlist finished or empty.";
                showToast("Playlist finished.");
                return;
            }

            if (currentIndex >= playlist.length) {
                showToast("Playlist ended! Restarting from the beginning.");
                currentIndex = 0;
            }
            
            const trackNum = playlist[currentIndex];
            const currentRepeat = repeatCounter + 1;

            document.getElementById('currentShlok').textContent = `Shlok ${trackNum} (Repeat ${currentRepeat}/${repeatEach})`;
            
            audioPlayer.src = `https://ia601703.us.archive.org/35/items/satsang_diksha/sanskrit_${String(trackNum).padStart(3, '0')}.mp3`;
            audioPlayer.playbackRate = currentSpeed;
            audioPlayer.play().catch(err => {
                document.getElementById('currentShlok').textContent = `Failed to play Shlok ${trackNum}.`;
                showToast("Failed to play track. Skipping to next.");
                currentIndex++; // Skip to next track on error
                repeatCounter = 0;
                playCurrent();
            });
        }


        function clearSelection() {
            document.querySelectorAll(".trackBox").forEach(cb => {
                cb.checked = false;
                cb.closest("label").classList.remove("selected");
            });
            document.querySelectorAll(".recent-box, .playlist-box").forEach(cb => {
                cb.checked = false;
                cb.closest("label").classList.remove("selected");
            });
            updateGroupButtonSelection();
            if (countdownInterval) clearInterval(countdownInterval);
            if (autoPlayTimeout) clearTimeout(autoPlayTimeout);
            audioPlayer.pause();
            audioPlayer.src = "";
            document.getElementById('currentShlok').textContent = "Nothing selected.";
            document.getElementById('currentShlokQuiz').textContent = "Start the Quiz to begin.";
            document.getElementById('quizStatus').textContent = "";
            document.getElementById('countdown').textContent = "";
            document.getElementById('playFullBtn').classList.add('hidden');
            modalContainerEl.classList.add('hidden');
        }

        // UPDATED showModal: Fix Cross-Site Scripting (XSS) Vulnerability (Security Update #1)
        function showModal(message, onConfirm = null) {
            modalContainerEl.innerHTML = '';
            modalContainerEl.classList.remove('hidden');
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');

            // --- Start Security Fix ---
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';

            // Insert close button using insertAdjacentHTML (since it's static HTML)
            modalContent.innerHTML = `<span class="modal-close" onclick="this.closest('#modal-container').classList.add('hidden'); this.closest('.modal').remove()" tabindex="0" role="button" aria-label="Close modal" style="position: absolute; top: 10px; right: 20px; font-size: 24px; font-weight: bold; color: var(--secondary-text); cursor: pointer;">&times;</span>`;

            // Create a paragraph element for the message and use textContent for safety
            const messageEl = document.createElement('p');
            messageEl.className = 'mb-6 text-lg text-center';
            messageEl.textContent = message; // SAFELY inserts text only (XSS Fix)
            modalContent.appendChild(messageEl);

            // Add the appropriate buttons based on onConfirm state
            if (onConfirm) {
                modalContent.insertAdjacentHTML('beforeend', `
                    <div class="flex gap-4 justify-center pt-2">
                        <button class="px-6 py-3 bg-gray-600 hover:bg-gray-500 text-white rounded-lg font-semibold transition-colors" id="modal-cancel">Cancel</button>
                        <button class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors" id="modal-confirm">Confirm</button>
                    </div>
                `);
            } else {
                modalContent.insertAdjacentHTML('beforeend', `
                    <div class="text-center">
                        <button onclick="this.closest('#modal-container').classList.add('hidden')" class="px-6 py-3 bg-primary-color hover:bg-green-600 text-white rounded-lg font-semibold transition-colors">OK</button>
                    </div>
                `);
            }
            
            modal.appendChild(modalContent);
            modalContainerEl.appendChild(modal);
            // --- End Security Fix ---

            if (onConfirm) {
                modal.querySelector('#modal-confirm').addEventListener('click', () => {
                    onConfirm();
                    modalContainerEl.classList.add('hidden');
                    modal.remove();
                });
                modal.querySelector('#modal-cancel').addEventListener('click', () => modalContainerEl.classList.add('hidden'));
            }
            
            // Focus on a confirmation or close button for accessibility
            const focusTarget = modal.querySelector('#modal-confirm') || modal.querySelector('.modal-close') || modal.querySelector('button');
            if(focusTarget) focusTarget.focus();
        }

        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast px-4 py-2 bg-primary-color text-white rounded-full shadow-lg text-sm font-medium opacity-95';
            toast.setAttribute('role', 'status');
            toast.setAttribute('aria-live', 'polite');
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // --- PLAYLIST & HISTORY MANAGEMENT ---

        function showSavePlaylistModal() {
            if (!localStorageEnabled) {
                showModal("Local storage is not enabled or available in your browser. Cannot save playlists.");
                return;
            }
            const selectedTracks = Array.from(document.querySelectorAll(".trackBox:checked"))
                .map(cb => parseInt(cb.value, 10));
            
            if (selectedTracks.length === 0) {
                showModal("Please select at least one shlok to save as a playlist.");
                return;
            }

            modalContainerEl.innerHTML = '';
            modalContainerEl.classList.remove('hidden');
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');

            // Use string concatenation for complex, static HTML here (not accepting user input directly)
            modal.innerHTML = `
                <div class="modal-content text-left">
                    <span class="modal-close" onclick="this.closest('#modal-container').classList.add('hidden'); this.closest('.modal').remove()" tabindex="0" role="button" aria-label="Close modal" style="position: absolute; top: 10px; right: 20px; font-size: 24px; font-weight: bold; color: var(--secondary-text); cursor: pointer;">&times;</span>
                    <h3 class="text-xl font-bold mb-4 text-center">Save Playlist</h3>
                    <p class="mb-2 text-sm text-secondary-text">Enter a name for your playlist:</p>
                    <input type="text" id="playlistNameInput" class="w-full p-3 bg-gray-700 text-white rounded-lg focus:ring-2 focus:ring-primary-color focus:outline-none" placeholder="My new playlist">
                    <div id="playlistNameFeedback" class="text-red-400 font-semibold hidden mt-2 mb-4"></div>
                    <div class="flex gap-4 justify-end mt-4">
                        <button class="px-6 py-3 bg-gray-600 hover:bg-gray-500 text-white rounded-lg font-semibold transition-colors" onclick="this.closest('#modal-container').classList.add('hidden')">Cancel</button>
                        <button class="px-6 py-3 bg-primary-color hover:bg-green-600 text-white rounded-lg font-semibold transition-colors" id="savePlaylistConfirm">Save</button>
                    </div>
                </div>
            `;
            modalContainerEl.appendChild(modal);
            const inputEl = document.getElementById('playlistNameInput');
            const saveBtnEl = document.getElementById('savePlaylistConfirm');
            const feedbackEl = document.getElementById('playlistNameFeedback');

            function savePlaylist() {
                // Sanitize input name before using it
                const playlistName = inputEl.value.trim().replace(/</g, "&lt;").replace(/>/g, "&gt;"); 
                
                if (playlistName === "") {
                    feedbackEl.textContent = "Playlist name cannot be empty.";
                    feedbackEl.classList.remove('hidden');
                    return;
                }
                let playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
                if (playlists[playlistName]) {
                    feedbackEl.textContent = "A playlist with this name already exists.";
                    feedbackEl.classList.remove('hidden');
                    return;
                }
                playlists[playlistName] = selectedTracks;
                localStorage.setItem("personalPlaylists", JSON.stringify(playlists));
                renderPersonalPlaylists();
                showToast(`Playlist "${playlistName}" saved!`);
                modalContainerEl.classList.add('hidden');
                modal.remove();
            }

            saveBtnEl.addEventListener('click', savePlaylist);
            inputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    savePlaylist();
                }
            });
            inputEl.focus();
        }
        
        function confirmDeletePlaylist(name) {
            showModal(`Are you sure you want to delete the playlist "${name}"? This cannot be undone.`, () => deletePlaylist(name));
        }

        function renderPersonalPlaylists() {
            if (!localStorageEnabled) return;
            const playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
            const playlistList = document.getElementById("playlistList");
            const personalPlaylistsDiv = document.getElementById("personalPlaylists");
            const emptyMessage = document.getElementById("playlist-empty");

            playlistList.innerHTML = "";
            const names = Object.keys(playlists);
            
            if (names.length === 0) {
                personalPlaylistsDiv.classList.add("hidden");
            } else {
                personalPlaylistsDiv.classList.remove("hidden");
                emptyMessage.classList.add("hidden");
            }
            
            names.forEach(name => {
                const shlokas = playlists[name];
                const li = document.createElement("li");
                li.className = "py-2";
                const safeName = name.replace(/'/g, "\\'"); 
                li.innerHTML = `
                    <label class="playlist-item block cursor-pointer flex items-center justify-between transition-colors rounded-lg">
                        <div class="flex items-center">
                            <input type="checkbox" class="playlist-box mr-2" data-selection='${JSON.stringify(shlokas)}'>
                            <span class="ml-8 font-semibold">${name}</span>
                            </div>
                        <div class="flex items-center space-x-3 text-sm text-secondary-text">
                            <span class="text-gray-400">(${shlokas.length} shlokas)</span>
                            <button onclick="loadPlaylist('${safeName}')" class="text-xs px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded-full font-semibold transition-colors" aria-label="Load playlist ${name}">
                                Load
                            </button>
                            <button onclick="confirmDeletePlaylist('${safeName}')" class="text-xs px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-full font-semibold transition-colors" aria-label="Delete playlist ${name}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </label>
                `;
                playlistList.appendChild(li);
            });
            if (names.length === 0 && !personalPlaylistsDiv.classList.contains("hidden")) {
                emptyMessage.classList.remove("hidden");
            }
        }

        function loadPlaylist(name) {
            if (!localStorageEnabled) return;
            let playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
            const shlokas = playlists[name];
            if (shlokas) {
                // Clear all other selection types
                document.querySelectorAll(".trackBox, .recent-box, .playlist-box").forEach(cb => {
                    cb.checked = false;
                    cb.closest("label").classList.remove("selected");
                });

                // Set the current playlist item as selected
                document.querySelectorAll('.playlist-box').forEach(cb => {
                    if (cb.closest('label').querySelector('.font-semibold').textContent === name) {
                        cb.checked = true;
                        cb.closest('label').classList.add('selected');
                    }
                });

                // Load tracks into individual boxes (for visual feedback)
                shlokas.forEach(trackNum => {
                    const checkbox = document.querySelector(`.trackBox[value="${trackNum}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.closest("label").classList.add("selected");
                    }
                });
                updateGroupButtonSelection();
                showToast(`Playlist "${name}" loaded into your selection!`);
            }
        }

        function deletePlaylist(name) {
            if (!localStorageEnabled) return;
            let playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
            delete playlists[name];
            localStorage.setItem("personalPlaylists", JSON.stringify(playlists));
            renderPersonalPlaylists();
            showToast(`Playlist "${name}" deleted.`);
        }

        function saveSelection(selection) {
            if (!localStorageEnabled || isQuizMode) return;
            let history = [];
            try { history = JSON.parse(localStorage.getItem("recentSelections")) || []; } catch (e) { history = []; }
            const selString = selection.join(",");
            history = [selString, ...history.filter(h => h !== selString)].slice(0, 5);
            localStorage.setItem("recentSelections", JSON.stringify(history));
            renderRecentSelections();
        }

        function clearHistory() {
            if (!localStorageEnabled) return;
            showModal("Are you sure you want to clear your recently played history?", () => {
                localStorage.removeItem("recentSelections");
                renderRecentSelections();
                showToast("Recently played history cleared.");
            });
        }

        function renderRecentSelections() {
            if (!localStorageEnabled) return;
            const history = JSON.parse(localStorage.getItem("recentSelections")) || [];
            const recentDiv = document.getElementById("recentlyPlayed");
            const recentList = document.getElementById("recentList");
            const recentEmpty = document.getElementById("recent-empty");
            recentList.innerHTML = "";
            if (history.length === 0) { 
                recentDiv.classList.add("hidden"); 
                return; 
            }
            recentDiv.classList.remove("hidden");
            recentEmpty.classList.add("hidden");
            history.forEach((sel) => {
                const numbers = sel.split(",").map(n => parseInt(n.trim()));
                let labelText = numbers.length <= 6 ? "Shlok " + numbers.join(", ") : `Shlok ${numbers[0]}–${numbers[numbers.length - 1]} (${numbers.length} total)`;
                const li = document.createElement("li");
                li.className = "py-2";
                li.innerHTML = `
                    <label class="recent-item block cursor-pointer transition-colors rounded-lg">
                        <input type="checkbox" class="recent-box mr-2" data-selection="${sel}">
                        <span class="ml-8">${labelText}</span>
                    </label>
                `;
                recentList.appendChild(li);
            });
        }

        function restoreLastSelection() {
            if (!localStorageEnabled) return;
            let history = [];
            try { history = JSON.parse(localStorage.getItem("recentSelections")) || []; } catch (e) { history = []; }
            if (history.length > 0) {
                const lastSel = history[0].split(",").map(n => parseInt(n.trim()));
                lastSel.forEach(trackNum => {
                    const checkbox = document.querySelector(`.trackBox[value="${trackNum}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.closest("label").classList.add("selected");
                    }
                });
                updateGroupButtonSelection();
            }
        }
        
        function updateGroupButtonSelection() {
            const selectedTracks = new Set(Array.from(document.querySelectorAll(".trackBox:checked")).map(cb => parseInt(cb.value)));
            document.querySelectorAll(".group-btn").forEach(btn => {
                const start = parseInt(btn.dataset.start);
                const end = parseInt(btn.dataset.end);
                
                let isGroupSelected = true;
                for(let i = start; i <= end; i++) {
                    // Check if *all* tracks in the group are selected
                    if (!selectedTracks.has(i)) {
                        isGroupSelected = false;
                        break;
                    }
                }
                
                btn.classList.toggle('selected', isGroupSelected);
                btn.setAttribute('aria-pressed', isGroupSelected);
            });
            // Also update the visibility of the Save Playlist button
            savePlaylistBtnEl.classList.toggle('hidden', selectedTracks.size === 0 || isQuizMode);
        }

        // --- UI GENERATION ---

        function generateGroups() {
            const groupDiv = document.getElementById("groups");
            for (let i = 1; i <= totalTracks; i += 10) {
                const end = Math.min(i + 9, totalTracks);
                const btn = document.createElement("button");
                btn.className = "group-btn hover:shadow-lg focus:outline-none";
                btn.setAttribute("tabindex", "0");
                btn.setAttribute("aria-pressed", "false"); 
                btn.dataset.start = i;
                btn.dataset.end = end;
                btn.textContent = `${i}–${end}`;
                btn.onclick = () => toggleGroup(i, end, btn); 
                groupDiv.appendChild(btn);
            }
        }
        
        function toggleGroup(start, end, btn) {
            const isGroupSelected = btn.classList.contains('selected');

            // Clear other selection types (Recent/Playlists) to prevent conflict
            document.querySelectorAll(".recent-box, .playlist-box").forEach(cb => {
                cb.checked = false;
                cb.closest("label").classList.remove("selected");
            });

            // Toggle the selection state for all tracks in the group
            for (let i = start; i <= end; i++) {
                const checkbox = document.querySelector(`.trackBox[value="${i}"]`);
                if (checkbox) {
                    checkbox.checked = !isGroupSelected;
                    checkbox.closest("label").classList.toggle("selected", !isGroupSelected);
                }
            }

            // Update the visual state of the group button itself
            btn.classList.toggle('selected', !isGroupSelected);
            btn.setAttribute('aria-pressed', !isGroupSelected);

            // Update all group buttons and the Save Playlist button status based on the new individual track selection
            updateGroupButtonSelection();
        }


        function generateTracks() {
            for (let i = 1; i <= totalTracks; i++) {
                const li = document.createElement("li");
                li.className = "py-2";
                li.innerHTML = `
                    <label class="track-item block cursor-pointer transition-colors rounded-lg">
                        <input type="checkbox" value="${i}" class="trackBox mr-2"> <span class="ml-8">Shlok ${i}</span>
                    </label>`;
                trackListEl.appendChild(li);
            }
        }
        
        // --- INITIALIZATION ---

        document.addEventListener("DOMContentLoaded", function () {
            // Assign global element references
            audioPlayer = document.getElementById("audioPlayer");
            trackListEl = document.getElementById("trackList");
            allShlokasTitleEl = document.getElementById("allShlokasTitle");
            quizControlsEl = document.getElementById("quizControls");
            regularControlsEl = document.getElementById("regularControls");
            savePlaylistBtnEl = document.getElementById("savePlaylistBtn");
            modalContainerEl = document.getElementById("modal-container");
            
            const searchInput = document.getElementById("search");
            const trackListContainer = document.getElementById("trackList");
            const clearSearchBtn = document.getElementById("clearSearch");
            const searchFeedbackEl = document.getElementById("search-feedback");

            // Load saved settings
            currentSpeed = parseFloat(localStorage.getItem("playbackSpeed") || 1.0);
            currentQuizTime = parseInt(localStorage.getItem("quizTime") || 10);
            currentQuizDelay = parseInt(localStorage.getItem("quizDelay") || 3);
            repeatEach = parseInt(localStorage.getItem("repeatEach") || 1);
            autoPlay = localStorage.getItem("autoPlay") !== "false"; // Default to true if not set

            // Initialize UI from saved settings
            const speedSlider = document.getElementById("speedSlider");
            const quizTimeSlider = document.getElementById("quizTimeSlider");
            const quizDelaySlider = document.getElementById("quizDelaySlider");
            const repeatEachSlider = document.getElementById("repeatEach");
            const autoPlayToggle = document.getElementById('autoPlayToggle');

            speedSlider.value = currentSpeed;
            document.getElementById("speedValue").textContent = `${currentSpeed}x`;
            audioPlayer.playbackRate = currentSpeed;
            
            quizTimeSlider.value = currentQuizTime;
            document.getElementById("quizTimeValue").textContent = `${currentQuizTime}s`;
            
            quizDelaySlider.value = currentQuizDelay;
            document.getElementById("quizDelayValue").textContent = `${currentQuizDelay}s`;
            
            repeatEachSlider.value = repeatEach;
            document.getElementById("repeatEachValue").textContent = `${repeatEach} time${repeatEach > 1 ? 's' : ''}`;
            
            autoPlayToggle.checked = autoPlay;


            // Bind settings listeners
            speedSlider.addEventListener("input", function() {
                changeSpeed(parseFloat(this.value));
            });
            quizTimeSlider.addEventListener("input", function() {
                changeQuizTime(parseInt(this.value));
            });
            quizDelaySlider.addEventListener("input", function() {
                changeQuizDelay(parseInt(this.value));
            });

            // Search/Filter logic
            searchInput.addEventListener("input", function () {
                const term = this.value.trim().toLowerCase();
                let found = false;
                document.querySelectorAll("#trackList li").forEach(li => {
                    const trackNumber = li.querySelector(".trackBox").value;
                    if (!term || trackNumber.startsWith(term)) {
                        li.classList.remove("hidden");
                        found = true;
                    } else {
                        li.classList.add("hidden");
                    }
                });
                searchFeedbackEl.classList.toggle("hidden", found);
                clearSearchBtn.classList.toggle("hidden", term === "");
            });

            // Centralized change listener for individual tracks
            trackListContainer.addEventListener("change", function(event) {
                if (event.target.classList.contains("trackBox")) {
                    const label = event.target.closest("label");
                    const isChecked = event.target.checked;
                    label.classList.toggle("selected", isChecked);
                    updateGroupButtonSelection();
                    // Deselect any active playlist/recent items when individual tracks are changed
                    document.querySelectorAll(".recent-box, .playlist-box").forEach(cb => {
                        cb.checked = false;
                        cb.closest("label").classList.remove("selected");
                    });
                }
            });
            
            // Centralized change listener for Recent selections
            document.getElementById("recentList").addEventListener("change", function(event) {
                if (event.target.classList.contains("recent-box")) {
                    // Clear individual track and playlist selections
                    document.querySelectorAll(".track-item.selected, .playlist-item.selected").forEach(item => item.classList.remove("selected"));
                    document.querySelectorAll(".trackBox, .playlist-box").forEach(cb => cb.checked = false);

                    const selectedRecents = Array.from(document.querySelectorAll(".recent-box:checked"));
                    
                    // Update visual state of recent selections
                    document.querySelectorAll(".recent-item").forEach(item => {
                         item.classList.toggle("selected", item.querySelector(".recent-box").checked);
                    });

                    // Update individual tracks for visual feedback
                    const allNumbers = new Set(selectedRecents.flatMap(cb => cb.dataset.selection.split(",").map(Number)));
                    document.querySelectorAll(".trackBox").forEach(cb => {
                        const trackNum = parseInt(cb.value);
                        const isChecked = allNumbers.has(trackNum);
                        cb.checked = isChecked;
                        cb.closest("label").classList.toggle("selected", isChecked);
                    });
                    
                    updateGroupButtonSelection();
                }
            });

            // Centralized change listener for Playlists
            document.getElementById("playlistList").addEventListener("change", function(event) {
                if (event.target.classList.contains("playlist-box")) {
                    // Clear individual track and recent selections
                    document.querySelectorAll(".track-item.selected, .recent-item.selected").forEach(item => item.classList.remove("selected"));
                    document.querySelectorAll(".trackBox, .recent-box").forEach(cb => cb.checked = false);

                    const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked"));
                    
                    // Update visual state of playlists
                    document.querySelectorAll(".playlist-item").forEach(item => {
                         item.classList.toggle("selected", item.querySelector(".playlist-box").checked);
                    });

                    // Update individual tracks for visual feedback
                    const allNumbers = new Set(selectedPlaylists.flatMap(cb => JSON.parse(cb.dataset.selection)));
                    document.querySelectorAll(".trackBox").forEach(cb => {
                        const trackNum = parseInt(cb.value);
                        const isChecked = allNumbers.has(trackNum);
                        cb.checked = isChecked;
                        cb.closest("label").classList.toggle("selected", isChecked);
                    });
                    
                    updateGroupButtonSelection();
                }
            });

            // Audio event listeners
            audioPlayer.addEventListener("error", (e) => {
                showToast("An error occurred while loading the audio.");
            });

            audioPlayer.addEventListener("playing", () => {
                if (isQuizMode && !hasQuizPaused) {
                    document.getElementById('playFullBtn').classList.add('hidden');
                    // Set timeout for the quiz delay before pause
                    autoPlayTimeout = setTimeout(() => {
                        audioPlayer.pause();
                        hasQuizPaused = true;
                        document.getElementById('quizStatus').textContent = "Audio Paused. Your turn to recite!";
                        document.getElementById('playFullBtn').classList.remove('hidden');

                        let countdown = currentQuizTime;
                        const countdownEl = document.getElementById('countdown');
                        countdownEl.textContent = `(${countdown}s)`;
                        
                        if (countdownInterval) {
                            clearInterval(countdownInterval);
                        }
                        
                        document.getElementById('countdownBar').style.width = `${(countdown / currentQuizTime) * 100}%`;

                        // Start countdown timer
                        countdownInterval = setInterval(() => {
                            countdown--;
                            countdownEl.textContent = `(${countdown}s)`;
                            document.getElementById('countdownBar').style.width = `${(countdown / currentQuizTime) * 100}%`;
                            if (countdown <= 0) {
                                clearInterval(countdownInterval);
                                countdownEl.textContent = '';
                                document.getElementById('quizStatus').textContent = 'Time up!';
                                document.getElementById('playFullBtn').classList.add('hidden');
                                if (autoPlay) {
                                    playNextQuizTrack();
                                }
                            }
                        }, 1000);
                    }, currentQuizDelay * 1000); 
                }
            });

            audioPlayer.addEventListener("ended", () => {
                if (!isQuizMode) {
                    // Regular Playback Mode: Handle repeating the current track
                    repeatCounter++;
                    if (repeatCounter >= repeatEach) {
                        repeatCounter = 0;
                        currentIndex++; // Move to the next track
                    }
                    playCurrent();
                } else if (isQuizMode && !hasQuizPaused) {
                    // This case handles when 'playFullAudio' finishes playing the full track.
                    // The auto-advance logic is handled within playFullAudio for immediate cleanup.
                }
            });
            
            // --- FINAL SETUP ---
            generateGroups();
            generateTracks();
            if (localStorageEnabled) {
                restoreLastSelection();
                renderRecentSelections();
                renderPersonalPlaylists();
            } else {
                showToast("Local storage is disabled. Playlists and history will not be saved.");
            }
        });
    </script>
</body>
</html>
