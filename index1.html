<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satsang Diksha Audio Player</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
            color: #1a202c; /* Dark text */
        }
        .container-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
        }
        /* Custom Button Styles */
        .btn-primary { background-color: #4c51bf; color: white; transition: background-color 0.15s; }
        .btn-primary:hover { background-color: #3f45a8; }
        .btn-green { background-color: #38a169; color: white; transition: background-color 0.15s; }
        .btn-green:hover { background-color: #2f855a; }
        .btn-red { background-color: #e53e3e; color: white; transition: background-color 0.15s; }
        .btn-red:hover { background-color: #c53030; }
        .btn-secondary { background-color: #718096; color: white; transition: background-color 0.15s; }
        .btn-secondary:hover { background-color: #5d687b; }
        .btn-rounded { border-radius: 9999px; }

        /* Group Button Styling */
        .group-btn {
            @apply px-3 py-1 text-sm font-semibold rounded-full bg-gray-200 text-gray-700 transition duration-150 ease-in-out border border-transparent;
            min-width: 65px;
            margin: 4px;
            position: relative;
        }
        .group-btn:hover {
            @apply bg-gray-300;
        }
        .group-btn.selected {
            @apply bg-indigo-500 text-white border-indigo-700;
        }
        .group-btn .checkmark {
            display: none;
            position: absolute;
            top: 0;
            right: 4px;
            font-size: 10px;
        }
        .group-btn.selected .checkmark {
            display: block;
        }
        /* Track/Item Selection Styles */
        .track-item, .recent-item, .playlist-item {
            @apply transition duration-100 ease-in-out border-2 border-transparent;
        }
        .track-item:hover, .recent-item:hover, .playlist-item:hover {
            @apply bg-gray-50;
        }
        .track-item.selected, .recent-item.selected, .playlist-item.selected {
            @apply border-indigo-500 bg-indigo-50;
        }
        /* Modal Styles */
        #modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #4a5568;
        }
        /* Toast Styles */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
        }
        .toast {
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 10px;
            opacity: 0;
            animation: fadeIn 0.5s forwards, fadeOut 0.5s 3.5s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto space-y-6">

        <!-- Header and Controls -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-indigo-700">Satsang Diksha Audio Player</h1>
            <p class="text-gray-600">Select Shlokas to Play or Quiz Yourself</p>
            <audio id="audioPlayer" controls class="w-full mt-4 rounded-lg shadow-lg"></audio>
        </header>

        <!-- Main Mode Toggle -->
        <div class="flex justify-center mb-6">
            <button id="modeToggle" class="px-6 py-3 text-lg font-bold btn-primary btn-rounded shadow-md hover:shadow-lg transition duration-200">
                <i class="fa-solid fa-graduation-cap"></i> Start Quiz Mode
            </button>
        </div>
        
        <!-- Controls Section -->
        <div id="controls" class="space-y-6">

            <!-- Regular Play Controls -->
            <div id="regularControls" class="container-card space-y-4">
                <h2 class="text-xl font-bold border-b pb-2 mb-4">Playback Settings</h2>
                
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex-grow">
                        <label for="repeatCount" class="block text-sm font-medium text-gray-700">Repeat Each Shlok:</label>
                        <input type="number" id="repeatCount" value="1" min="1" max="10" class="w-full md:w-20 p-2 border rounded-lg mt-1">
                    </div>
                    
                    <div class="flex-grow">
                        <label for="speedSlider" class="block text-sm font-medium text-gray-700">Playback Speed: <span id="speedDisplay">1.0</span>x</label>
                        <input type="range" id="speedSlider" min="0.5" max="2.0" value="1.0" step="0.1" class="w-full mt-1">
                    </div>

                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="shuffle" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="shuffle" class="ml-2 text-sm text-gray-700">Shuffle</label>
                        </div>
                        <button id="autoPlayToggle" class="px-4 py-2 btn-secondary btn-rounded text-sm" onclick="toggleAutoPlay()">
                            <i class="fa-solid fa-toggle-off"></i> Auto-Play: OFF
                        </button>
                    </div>
                </div>

                <div class="pt-4 border-t">
                    <button class="px-6 py-3 btn-green btn-rounded text-lg font-semibold w-full md:w-auto shadow-lg" onclick="playSelected()">
                        <i class="fa-solid fa-play"></i> Play Selected
                    </button>
                </div>
            </div>

            <!-- Quiz Controls (Hidden by default) -->
            <div id="quizControls" class="container-card space-y-4 hidden">
                <h2 class="text-xl font-bold border-b pb-2 mb-4">Quiz Settings</h2>
                <div id="quizStatus" class="text-lg font-semibold text-center text-indigo-600 mb-2">Quiz Mode Active</div>
                <div class="flex justify-center mb-4">
                    <div id="countdownBarContainer" class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="countdownBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 100%"></div>
                    </div>
                </div>
                <p id="currentShlokQuiz" class="text-center font-bold text-gray-800">Ready to start</p>
                <div id="countdown" class="text-3xl font-extrabold text-red-500 text-center"></div>

                <div class="flex flex-wrap items-center justify-center gap-6 pt-4 border-t">
                    <div>
                        <label for="quizTimeSlider" class="block text-sm font-medium text-gray-700 text-center">Answer Time: <span id="quizTimeDisplay">10s</span></label>
                        <input type="range" id="quizTimeSlider" min="5" max="30" value="10" step="5" class="w-full mt-1" oninput="changeQuizTime(parseInt(this.value))">
                    </div>
                    <div>
                        <label for="quizDelaySlider" class="block text-sm font-medium text-gray-700 text-center">Next Delay: <span id="quizDelayDisplay">5s</span></label>
                        <input type="range" id="quizDelaySlider" min="2" max="15" value="5" step="1" class="w-full mt-1" oninput="changeQuizDelay(parseInt(this.value))">
                    </div>
                </div>

                <div class="flex flex-wrap gap-4 justify-center pt-4">
                    <button class="px-6 py-3 btn-green btn-rounded font-semibold shadow-lg" onclick="playNextQuizTrack()">
                        <i class="fa-solid fa-forward"></i> Next Shlok
                    </button>
                    <button id="pauseQuizBtn" class="px-6 py-3 btn-secondary btn-rounded font-semibold shadow-lg" onclick="pauseQuiz()">
                        <i class="fa-solid fa-pause"></i> Pause Quiz
                    </button>
                    <button id="playFullBtn" class="px-6 py-3 btn-primary btn-rounded font-semibold shadow-lg hidden" onclick="playFullShloka()">
                        <i class="fa-solid fa-volume-up"></i> Play Full Shlok
                    </button>
                </div>
            </div>

        </div>

        <!-- Selection Area -->
        <div id="selectionArea" class="container-card">
            <!-- FIX 1: Added span with ID for robust title updating -->
            <h2 id="allShlokasTitle" class="text-xl font-bold border-b pb-2 flex justify-between items-center">
                <span id="shlokas-label">All Shlokas (1–170)</span>
                <button onclick="toggleGroupDisplay()" class="text-sm px-3 py-1 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 transition">
                    Groups <i id="group-toggle-icon" class="fa-solid fa-chevron-down ml-1"></i>
                </button>
            </h2>

            <!-- Groups -->
            <div id="groups" class="flex flex-wrap justify-center py-4 border-b mb-4 hidden">
                <!-- Group buttons generated here -->
            </div>

            <!-- Range Selection -->
            <div class="flex flex-wrap items-center gap-4 mb-4 border-b pb-4">
                <input type="number" id="rangeStart" placeholder="Start" min="1" max="170" class="w-20 p-2 border rounded-lg">
                <span class="font-bold">-</span>
                <input type="number" id="rangeEnd" placeholder="End" min="1" max="170" class="w-20 p-2 border rounded-lg">
                <button class="px-4 py-2 btn-primary btn-rounded text-sm" onclick="selectRange()">Select Range</button>
                <button class="px-4 py-2 btn-red btn-rounded text-sm" onclick="confirmClearSelection()">Clear Selection</button>
            </div>

            <!-- Shloka List -->
            <div class="max-h-96 overflow-y-auto">
                <input type="text" id="search" placeholder="Search by Shlok number..." class="w-full p-2 border rounded-lg mb-4 sticky top-0 bg-white z-10">
                <button id="clearSearch" class="px-3 py-1 btn-secondary btn-rounded text-xs hidden absolute right-3 top-2.5">Clear</button>
                <div id="search-feedback" class="text-red-500 font-semibold text-center hidden mb-4">No shlokas found matching your search.</div>

                <ul id="trackList" class="space-y-1">
                    <!-- Tracks generated here -->
                </ul>
            </div>
        </div>
        
        <!-- Saved Playlists and History -->
        <div id="extraFeatures" class="flex flex-col md:flex-row gap-6">

            <!-- Playlists -->
            <div id="personalPlaylists" class="container-card flex-1 hidden">
                <h3 class="text-xl font-bold border-b pb-2 mb-4 flex justify-between items-center">
                    Saved Playlists
                    <button id="savePlaylistBtn" class="px-3 py-1 btn-green btn-rounded text-sm hidden" onclick="showSavePlaylistModal()">
                        <i class="fa-solid fa-save"></i> Save Current
                    </button>
                </h3>
                <p id="playlist-empty" class="text-gray-500 text-center py-4">No playlists saved yet.</p>
                <ul id="playlistList" class="space-y-2">
                    <!-- Playlists rendered here -->
                </ul>
            </div>

            <!-- Recently Played -->
            <div id="recentlyPlayed" class="container-card flex-1 hidden">
                <h3 class="text-xl font-bold border-b pb-2 mb-4 flex justify-between items-center">
                    Recently Played
                    <button class="px-3 py-1 btn-red btn-rounded text-sm" onclick="confirmClearHistory()">
                        <i class="fa-solid fa-trash"></i> Clear History
                    </button>
                </h3>
                <p id="recent-empty" class="text-gray-500 text-center py-4">No history recorded yet.</p>
                <ul id="recentList" class="space-y-2">
                    <!-- Recent selections rendered here -->
                </ul>
                <div class="mt-4 border-t pt-4">
                    <button class="px-4 py-2 btn-secondary btn-rounded text-sm w-full" onclick="restoreLastSelection()">
                        Restore Last Selection
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Modals and Toasts Containers -->
    <div id="modal-container"></div>
    <div id="toast-container"></div>
    
    <!-- JavaScript Logic -->
    <script>
        // Global State Variables (Required for all functions to work)
        let autoPlay = false;
        let playlist = [];
        let currentIndex = 0;
        let repeatEach = 1;
        let repeatCounter = 0;
        let currentSpeed = 1.0;
        let currentQuizTime = 10; 
        let currentQuizDelay = 5; 
        let isQuizMode = false;
        let hasQuizPaused = false;
        let countdownInterval = null;
        let autoPlayTimeout = null;
        const totalTracks = 170; // Total number of shlokas
        const audioBaseUrl = "https://ia601703.us.archive.org/35/items/satsang_diksha/";

        // Element References (Initialized in DOMContentLoaded)
        let audioPlayer, trackListEl, quizControlsEl, regularControlsEl, savePlaylistBtnEl;
        
        const localStorageEnabled = typeof localStorage !== 'undefined';
        
        // Helper function to format track number for URL
        function getTrackUrl(trackNum) {
            return `${audioBaseUrl}sanskrit_${String(trackNum).padStart(3, '0')}.mp3`;
        }

        // --- Core Playback Logic (Preserved) ---
        function playCurrent() {
            if (currentIndex >= playlist.length) {
                // End of playlist
                if (autoPlay) {
                    showToast("Playlist finished. Repeating all tracks.");
                    currentIndex = 0;
                } else {
                    showToast("Playlist finished.");
                    return;
                }
            }

            const trackNum = playlist[currentIndex];
            audioPlayer.src = getTrackUrl(trackNum);
            audioPlayer.playbackRate = currentSpeed;
            
            // Highlight the currently playing track
            document.querySelectorAll(".track-item").forEach(el => el.classList.remove("playing"));
            const currentLabel = document.querySelector(`.trackBox[value="${trackNum}"]`)?.closest("label");
            if(currentLabel) currentLabel.classList.add("playing");

            audioPlayer.play().catch(err => {
                showToast("Playback blocked by browser autoplay policy. Please interact with the page.");
                console.log("Play error:", err);
            });
            
            // This is the main play loop logic
            audioPlayer.onended = () => {
                repeatCounter++;
                if (repeatCounter < repeatEach) {
                    // Repeat the current track
                    audioPlayer.play();
                } else {
                    // Move to the next track
                    currentIndex++;
                    repeatCounter = 0;
                    playCurrent();
                }
            };
        }
        
        function toggleAutoPlay() {
            autoPlay = !autoPlay;
            const button = document.getElementById("autoPlayToggle");
            button.innerHTML = `<i class="fa-solid fa-toggle-${autoPlay ? 'on' : 'off'}"></i> Auto-Play: ${autoPlay ? 'ON' : 'OFF'}`;
            button.classList.toggle('btn-secondary', !autoPlay);
            button.classList.toggle('btn-green', autoPlay);
        }

        // --- Quiz Mode Logic (Preserved) ---

        function toggleQuizMode() {
            isQuizMode = !isQuizMode;
            const modeToggleBtn = document.getElementById("modeToggle");
            const shlokasLabel = document.getElementById('shlokas-label'); // Get the specific label element

            if (isQuizMode) {
                // Enter Quiz Mode
                modeToggleBtn.innerHTML = '<i class="fa-solid fa-volume-up"></i> Exit Quiz Mode';
                modeToggleBtn.classList.remove('btn-primary');
                modeToggleBtn.classList.add('btn-red');
                regularControlsEl.classList.add('hidden');
                quizControlsEl.classList.remove('hidden');
                savePlaylistBtnEl.classList.add('hidden'); // Cannot save during quiz
                
                // FIX 2: Correctly target the dedicated span element
                if (shlokasLabel) shlokasLabel.textContent = "Quiz Selection"; 

                showToast("Quiz Mode Activated. Select Shlokas/Playlists to begin.");
                
                audioPlayer.pause();
                playlist = []; // Reset playlist for quiz
                currentIndex = 0;

                // Set up onended for quiz mode
                audioPlayer.onended = () => {
                    if (isQuizMode) {
                        startCountdown();
                    } else {
                        // Re-attach standard onended logic if quiz mode is false
                        playCurrent();
                    }
                };

            } else {
                // Exit Quiz Mode
                modeToggleBtn.innerHTML = '<i class="fa-solid fa-graduation-cap"></i> Start Quiz Mode';
                modeToggleBtn.classList.remove('btn-red');
                modeToggleBtn.classList.add('btn-primary');
                regularControlsEl.classList.remove('hidden');
                quizControlsEl.classList.add('hidden');
                savePlaylistBtnEl.classList.remove('hidden'); // Show save button again
                
                // FIX 2: Correctly target the dedicated span element
                if (shlokasLabel) shlokasLabel.textContent = "All Shlokas (1–170)";

                if (countdownInterval) clearInterval(countdownInterval);
                clearTimeout(autoPlayTimeout);
                document.getElementById('countdown').textContent = '';
                document.getElementById('quizStatus').textContent = '';
                document.getElementById('playFullBtn').classList.add('hidden');

                audioPlayer.onended = playCurrent; // Restore standard handler
            }
        }
        
        function startCountdown() {
            if (!isQuizMode || hasQuizPaused) return;

            document.getElementById('quizStatus').textContent = 'Time to guess the shlok...';
            document.getElementById('playFullBtn').classList.remove('hidden');

            let timeRemaining = currentQuizTime;
            const countdownEl = document.getElementById('countdown');
            const countdownBar = document.getElementById('countdownBar');
            
            countdownEl.textContent = timeRemaining;
            countdownBar.style.transition = `width ${currentQuizTime}s linear`;
            countdownBar.style.width = '0%';

            countdownInterval = setInterval(() => {
                timeRemaining--;
                countdownEl.textContent = timeRemaining;

                if (timeRemaining <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('quizStatus').textContent = 'Time\'s up!';
                    
                    // Start next shlok after delay
                    autoPlayTimeout = setTimeout(() => {
                        playNextQuizTrack();
                    }, currentQuizDelay * 1000);
                }
            }, 1000);
        }
        
        function pauseQuiz() {
            hasQuizPaused = !hasQuizPaused;
            const pauseBtn = document.getElementById('pauseQuizBtn');
            if (hasQuizPaused) {
                if (countdownInterval) clearInterval(countdownInterval);
                clearTimeout(autoPlayTimeout);
                audioPlayer.pause();
                pauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> Resume Quiz';
                pauseBtn.classList.remove('btn-secondary');
                pauseBtn.classList.add('btn-primary');
                document.getElementById('quizStatus').textContent = 'Quiz Paused';
            } else {
                audioPlayer.play();
                pauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause Quiz';
                pauseBtn.classList.remove('btn-primary');
                pauseBtn.classList.add('btn-secondary');
                document.getElementById('quizStatus').textContent = 'Resuming...';
                
                // If it was paused during countdown, restart countdown
                if (parseInt(document.getElementById('countdown').textContent) > 0) {
                     startCountdown();
                } else {
                    // If it was paused after time's up, jump to next track
                    playNextQuizTrack();
                }
            }
        }

        function playFullShloka() {
            const trackNum = playlist[currentIndex > 0 ? currentIndex - 1 : 0]; // Play the last track that was paused
            audioPlayer.src = getTrackUrl(trackNum);
            audioPlayer.playbackRate = currentSpeed;
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            clearTimeout(autoPlayTimeout);
            document.getElementById('quizStatus').textContent = 'Playing full shlok...';
            document.getElementById('countdown').textContent = '';
            document.getElementById('playFullBtn').classList.add('hidden');

            audioPlayer.play().catch(err => {
                showToast("Failed to play track. Please check your connection.");
                console.log("Play error:", err);
            });
            
            // After playing full shlok, resume quiz flow after it finishes
            audioPlayer.onended = () => {
                if (isQuizMode) {
                    // Wait for delay before starting next track
                    document.getElementById('quizStatus').textContent = 'Waiting for next shlok...';
                    autoPlayTimeout = setTimeout(() => {
                        playNextQuizTrack();
                    }, currentQuizDelay * 1000);
                }
            }
        }
        
        function changeQuizTime(time) {
            currentQuizTime = time;
            document.getElementById("quizTimeDisplay").textContent = `${currentQuizTime}s`;
        }

        function changeQuizDelay(delay) {
            currentQuizDelay = delay;
            document.getElementById("quizDelayDisplay").textContent = `${currentQuizDelay}s`;
        }
        
        // --- UI/Utility Functions (Preserved) ---
        
        function toggleGroupDisplay() {
            const groupsDiv = document.getElementById("groups");
            const isHidden = groupsDiv.classList.toggle("hidden");
            const groupToggleIcon = document.getElementById("group-toggle-icon");
            groupToggleIcon.classList.toggle("fa-chevron-down", isHidden);
            groupToggleIcon.classList.toggle("fa-chevron-up", !isHidden);
        }

        function clearSelection() {
            document.querySelectorAll(".track-item.selected, .recent-item.selected, .playlist-item.selected").forEach(item => item.classList.remove("selected"));
            document.querySelectorAll(".trackBox:checked, .recent-box:checked, .playlist-box:checked").forEach(cb => cb.checked = false);
            document.querySelectorAll(".group-btn.selected").forEach(btn => btn.classList.remove("selected"));
            playlist = [];
            currentIndex = 0;
            updateGroupButtonSelection();
            showToast("Selection cleared.");
        }

        function confirmClearSelection() {
            showModal("Are you sure you want to clear your current selection?", () => {
                clearSelection();
            });
        }

        function confirmClearHistory() {
            showModal("Are you sure you want to clear your recently played history? This action cannot be undone.", () => {
                clearHistory();
            });
        }
        
        function confirmDeletePlaylist(playlistName) {
            showModal(`Are you sure you want to delete the playlist "${playlistName}"? This action cannot be undone.`, () => {
                deletePlaylist(playlistName);
            });
        }
        
        function selectRange() {
            const start = parseInt(document.getElementById("rangeStart").value, 10);
            const end = parseInt(document.getElementById("rangeEnd").value, 10);
            if (!isNaN(start) && !isNaN(end) && start >= 1 && end <= totalTracks && start <= end) {
                document.querySelectorAll(".trackBox").forEach(cb => {
                    const val = parseInt(cb.value, 10);
                    const isChecked = val >= start && val <= end;
                    cb.checked = isChecked;
                    cb.closest("label").classList.toggle("selected", isChecked);
                });
                updateGroupButtonSelection();
                showToast(`Shlokas ${start}–${end} selected.`);
            } else {
                showModal("Please enter a valid shlok range (e.g., 1-170).");
            }
        }

        function toggleGroup(start, end, element) {
            const isSelected = !element.classList.contains('selected');
            element.classList.toggle('selected', isSelected);
            element.setAttribute('aria-pressed', isSelected.toString());
            for (let i = start; i <= end; i++) {
                const checkbox = document.querySelector(`.trackBox[value="${i}"]`);
                if (checkbox) {
                    checkbox.checked = isSelected;
                    checkbox.closest("label").classList.toggle("selected", isSelected);
                }
            }
            updateGroupButtonSelection();
        }
        
        function changeSpeed(speed) {
            currentSpeed = speed;
            audioPlayer.playbackRate = currentSpeed;
            document.getElementById("speedDisplay").textContent = currentSpeed.toFixed(1);
        }

        // --- Core Utility: Get Selected Tracks (Robustness Refactor) ---
        function getSelectedTracks(includeRecents = false) {
            // 1. Check for selected Playlists
            const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked"))
                .flatMap(cb => {
                    try {
                        return JSON.parse(cb.dataset.selection);
                    } catch (e) {
                        console.error("Error parsing playlist selection data:", e);
                        return [];
                    }
                });

            if (selectedPlaylists.length > 0) {
                // Return unique tracks from selected playlists
                return Array.from(new Set(selectedPlaylists));
            }
            
            // 2. Check for selected Recents (only if requested, e.g., in Quiz Mode)
            if (includeRecents) {
                const selectedRecents = Array.from(document.querySelectorAll(".recent-box:checked"))
                    .flatMap(cb => cb.dataset.selection.split(",").map(n => parseInt(n.trim(), 10)));
                    
                if (selectedRecents.length > 0) {
                    // Return unique tracks from selected recents
                    return Array.from(new Set(selectedRecents));
                }
            }
            
            // 3. Fall back to individual track selections
            return Array.from(document.querySelectorAll(".trackBox:checked"))
                .map(cb => parseInt(cb.value, 10));
        }

        function playSelected() {
            // Logic updated to use the new utility function (false = do not check recents)
            let finalSelection = getSelectedTracks(false);

            if (finalSelection.length === 0) {
                showModal("Please select at least one shlok or a playlist to play.");
                return;
            }

            repeatEach = parseInt(document.getElementById("repeatCount").value, 10) || 1;
            playlist = [...finalSelection];
            if (document.getElementById("shuffle").checked) {
                playlist = playlist.sort(() => Math.random() - 0.5);
            }
            currentIndex = 0;
            repeatCounter = 0;
            
            if (localStorageEnabled) {
                saveSelection(finalSelection);
            }
            
            // Ensure audio handler is back to standard
            audioPlayer.onended = playCurrent;

            playCurrent();
            showToast("Playback started.");
        }

        function playNextQuizTrack() {
            // Logic updated to use the new utility function (true = check recents if no playlist is selected)
            let selected = getSelectedTracks(true);
            
            if (selected.length === 0) {
                showModal("Please select a group of shlokas or a playlist to quiz yourself on first!");
                return;
            }

            // If the current quiz playlist is empty or exhausted, refill and shuffle it
            if (playlist.length === 0 || currentIndex >= playlist.length) {
                playlist = [...selected].sort(() => Math.random() - 0.5);
                currentIndex = 0;
            }

            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            clearTimeout(autoPlayTimeout);
            document.getElementById('quizStatus').textContent = 'Playing fragment...';
            document.getElementById('playFullBtn').classList.add('hidden');
            document.getElementById('countdown').textContent = '';

            const trackNum = playlist[currentIndex];
            document.getElementById('currentShlokQuiz').textContent = `Now playing: Shlok ${trackNum}`;
            audioPlayer.src = getTrackUrl(trackNum);
            audioPlayer.playbackRate = currentSpeed;
            
            hasQuizPaused = false;
            document.getElementById('countdownBar').style.transition = 'none';
            document.getElementById('countdownBar').style.width = '100%';
            
            audioPlayer.play().catch(err => {
                showToast("Failed to play track. Please check your connection.");
                console.log("Play error:", err);
            });

            currentIndex++;
        }

        // --- Local Storage Functions (Preserved) ---

        function showSavePlaylistModal() {
            if (!localStorageEnabled) {
                showModal("Local storage is not enabled or available in your browser. Cannot save playlists.");
                return;
            }
            const selectedTracks = Array.from(document.querySelectorAll(".trackBox:checked"))
                .map(cb => parseInt(cb.value, 10));
            
            if (selectedTracks.length === 0) {
                showModal("Please select at least one shlok to save as a playlist.");
                return;
            }

            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content text-left';
            
            // Static content structure
            modalContent.innerHTML = `
                <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
                <h3 class="text-xl font-bold mb-4">Save Playlist</h3>
                <p class="mb-2">Enter a name for your playlist:</p>
                <input type="text" id="playlistNameInput" class="w-full mb-4 p-2 border rounded-lg" placeholder="My new playlist">
                <div id="playlistNameFeedback" class="text-red-500 font-semibold hidden mb-4"></div>
                <div class="flex gap-4 justify-end">
                    <button class="px-4 py-3 btn-secondary text-white btn-rounded" onclick="this.closest('.modal').remove()">Cancel</button>
                    <button class="px-4 py-3 btn-green text-white btn-rounded" id="savePlaylistConfirm">Save</button>
                </div>
            `;

            modal.appendChild(modalContent);
            modalContainer.appendChild(modal);

            const inputEl = document.getElementById('playlistNameInput');
            const saveBtnEl = document.getElementById('savePlaylistConfirm');
            const feedbackEl = document.getElementById('playlistNameFeedback');

            function savePlaylist() {
                const playlistName = inputEl.value.trim();
                if (playlistName === "") {
                    feedbackEl.textContent = "Playlist name cannot be empty.";
                    feedbackEl.classList.remove('hidden');
                    return;
                }
                let playlists = {};
                try {
                    playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
                } catch (e) {
                    console.error("Error loading playlists from localStorage:", e);
                }

                if (playlists[playlistName]) {
                    feedbackEl.textContent = "A playlist with this name already exists.";
                    feedbackEl.classList.remove('hidden');
                    return;
                }
                playlists[playlistName] = selectedTracks;
                localStorage.setItem("personalPlaylists", JSON.stringify(playlists));
                renderPersonalPlaylists();
                showToast(`Playlist "${playlistName}" saved!`);
                modal.remove();
            }

            saveBtnEl.addEventListener('click', savePlaylist);
            inputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    savePlaylist();
                }
            });
            inputEl.focus();
        }

        function renderPersonalPlaylists() {
            if (!localStorageEnabled) return;
            let playlists = {};
            try { playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {}; } catch (e) { playlists = {}; }
            
            const playlistList = document.getElementById("playlistList");
            const personalPlaylistsDiv = document.getElementById("personalPlaylists");
            const emptyMessage = document.getElementById("playlist-empty");

            playlistList.innerHTML = "";
            const names = Object.keys(playlists);
            
            personalPlaylistsDiv.classList.remove("hidden");
            if (names.length === 0) {
                emptyMessage.classList.remove("hidden");
            } else {
                emptyMessage.classList.add("hidden");
            }
            
            names.forEach(name => {
                const shlokas = playlists[name];
                const li = document.createElement("li");
                li.className = "space-y-2";
                li.innerHTML = `
                    <label class="playlist-item block p-3 container-card cursor-pointer flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" class="playlist-box mr-2" data-selection='${JSON.stringify(shlokas)}'>
                            <span class="ml-6 font-semibold">${name}</span>
                        </div>
                        <div class="flex items-center space-x-2 text-sm text-gray-400">
                            <span>(${shlokas.length} shlokas)</span>
                            <button onclick="loadPlaylist('${name.replace(/'/g, "\\'")}')" class="text-xs px-2 py-1 btn-secondary rounded-full">
                                Load
                            </button>
                            <button onclick="confirmDeletePlaylist('${name.replace(/'/g, "\\'")}')" class="text-xs px-2 py-1 btn-red rounded-full">
                                Delete
                            </button>
                        </div>
                    </label>
                `;
                playlistList.appendChild(li);
            });
        }

        function loadPlaylist(name) {
            if (!localStorageEnabled) return;
            let playlists = {};
            try { playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {}; } catch (e) { return; }
            
            const shlokas = playlists[name];
            if (shlokas) {
                clearSelection();
                shlokas.forEach(trackNum => {
                    const checkbox = document.querySelector(`.trackBox[value="${trackNum}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.closest("label").classList.add("selected");
                    }
                });
                updateGroupButtonSelection();
                showToast(`Playlist "${name}" loaded into your selection!`);
            }
        }

        function deletePlaylist(name) {
            if (!localStorageEnabled) return;
            let playlists = {};
            try { playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {}; } catch (e) { return; }
            
            delete playlists[name];
            localStorage.setItem("personalPlaylists", JSON.stringify(playlists));
            renderPersonalPlaylists();
        }

        function saveSelection(selection) {
            if (!localStorageEnabled) return;
            let history = [];
            try { history = JSON.parse(localStorage.getItem("recentSelections")) || []; } catch (e) { history = []; }
            const selString = selection.join(",");
            history = [selString, ...history.filter(h => h !== selString)].slice(0, 5);
            localStorage.setItem("recentSelections", JSON.stringify(history));
            renderRecentSelections();
        }

        function clearHistory() {
            if (!localStorageEnabled) return;
            localStorage.removeItem("recentSelections");
            renderRecentSelections();
        }

        function renderRecentSelections() {
            if (!localStorageEnabled) return;
            let history = [];
            try { history = JSON.parse(localStorage.getItem("recentSelections")) || []; } catch (e) { history = []; }
            
            const recentDiv = document.getElementById("recentlyPlayed");
            const recentList = document.getElementById("recentList");
            const recentEmpty = document.getElementById("recent-empty");
            recentList.innerHTML = "";
            
            recentDiv.classList.remove("hidden");
            if (history.length === 0) { 
                recentEmpty.classList.remove("hidden");
                return; 
            }
            recentEmpty.classList.add("hidden");
            
            history.forEach((sel) => {
                const numbers = sel.split(",").map(n => parseInt(n.trim(), 10));
                let labelText = numbers.length <= 6 ? "Shlok " + numbers.join(", ") : `Shlok ${numbers[0]}–${numbers[numbers.length - 1]} (${numbers.length} total)`;
                const li = document.createElement("li");
                li.className = "space-y-2";
                li.innerHTML = `
                    <label class="recent-item block p-3 container-card cursor-pointer">
                        <input type="checkbox" class="recent-box mr-2" data-selection="${sel}">
                        <span class="ml-6">${labelText}</span>
                    </label>
                `;
                recentList.appendChild(li);
            });
        }

        function restoreLastSelection() {
            if (!localStorageEnabled) return;
            let history = [];
            try { history = JSON.parse(localStorage.getItem("recentSelections")) || []; } catch (e) { history = []; }
            if (history.length > 0) {
                const lastSel = history[0].split(",").map(n => parseInt(n.trim(), 10));
                document.querySelectorAll(".trackBox").forEach(cb => {
                    const isChecked = lastSel.includes(parseInt(cb.value, 10));
                    cb.checked = isChecked;
                    cb.closest("label").classList.toggle("selected", isChecked);
                });
                updateGroupButtonSelection();
                showToast("Last selection restored.");
            } else {
                showToast("No selection history found.");
            }
        }
        
        function updateGroupButtonSelection() {
            const selectedTracks = new Set(Array.from(document.querySelectorAll(".trackBox:checked")).map(cb => parseInt(cb.value, 10)));
            document.querySelectorAll(".group-btn").forEach(btn => {
                const start = parseInt(btn.dataset.start, 10);
                const end = parseInt(btn.dataset.end, 10);
                if (isNaN(start) || isNaN(end)) {
                    return;
                }
                let isGroupSelected = true;
                for(let i = start; i <= end; i++) {
                    if (!selectedTracks.has(i)) {
                        isGroupSelected = false;
                        break;
                    }
                }
                btn.classList.toggle('selected', isGroupSelected);
                btn.setAttribute('aria-pressed', isGroupSelected);
            });
            savePlaylistBtnEl.classList.toggle('hidden', selectedTracks.size === 0 || isQuizMode);
        }

        function generateGroups() {
            const groupDiv = document.getElementById("groups");
            for (let i = 1; i <= totalTracks; i += 10) {
                const end = Math.min(i + 9, totalTracks);
                const btn = document.createElement("button");
                btn.className = "group-btn";
                btn.setAttribute("tabindex", "0");
                btn.setAttribute("aria-pressed", "false");
                btn.dataset.start = i;
                btn.dataset.end = end;
                btn.innerHTML = `${i}–${end}<span class="checkmark">✓</span>`;
                btn.onclick = () => toggleGroup(i, end, btn);
                groupDiv.appendChild(btn);
            }
        }

        function generateTracks() {
            for (let i = 1; i <= totalTracks; i++) {
                const li = document.createElement("li");
                li.innerHTML = `
                    <label class="track-item block p-3">
                        <input type="checkbox" value="${i}" class="trackBox mr-2 h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 align-middle"> 
                        <span class="ml-6 align-middle">Shlok ${i}</span>
                    </label>`;
                trackListEl.appendChild(li);
            }
        }

        // --- Core Utility: Show Modal (Security Fix) ---
        function showModal(message, onConfirm = null) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';

            // 1. Add Close Button (using innerHTML as it's hardcoded static HTML)
            modalContent.innerHTML = `<span class="modal-close" onclick="this.closest('.modal').remove()" tabindex="0">&times;</span>`;
            
            // 2. Add Message (SAFELY using textContent)
            const messageEl = document.createElement('p');
            messageEl.className = 'mb-4 text-gray-700';
            messageEl.textContent = message; 
            modalContent.appendChild(messageEl);

            // 3. Add Buttons (using insertAdjacentHTML for the button block)
            if (onConfirm) {
                modalContent.insertAdjacentHTML('beforeend', `
                    <div class="flex gap-4 justify-center">
                        <button class="px-4 py-3 btn-red text-white btn-rounded" id="modal-cancel">Cancel</button>
                        <button class="px-4 py-3 btn-primary text-white btn-rounded" id="modal-confirm">OK</button>
                    </div>
                `);
            } else {
                modalContent.insertAdjacentHTML('beforeend', `
                    <button onclick="this.closest('.modal').remove()" class="px-4 py-3 btn-primary text-white btn-rounded">
                        OK
                    </button>
                `);
            }
            
            modal.appendChild(modalContent);
            modalContainer.appendChild(modal);

            if (onConfirm) {
                modal.querySelector('#modal-confirm').addEventListener('click', () => {
                    onConfirm();
                    modal.remove();
                });
                modal.querySelector('#modal-cancel').addEventListener('click', () => modal.remove());
                // Focus on the confirm button for primary action
                modal.querySelector('#modal-confirm').focus(); 
            } else {
                // Focus on the OK button
                modal.querySelector('button.btn-primary').focus();
            }
        }

        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.setAttribute('role', 'status');
            toast.setAttribute('aria-live', 'polite');
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // --- Event Listeners and Initialization ---

        document.addEventListener("DOMContentLoaded", function () {
            audioPlayer = document.getElementById("audioPlayer");
            const searchInput = document.getElementById("search");
            
            // Assign global element references
            trackListEl = document.getElementById("trackList");
            quizControlsEl = document.getElementById("quizControls");
            regularControlsEl = document.getElementById("regularControls");
            savePlaylistBtnEl = document.getElementById("savePlaylistBtn");
            // allShlokasTitleEl assignment removed as its function is now handled by the dedicated span ID.

            const clearSearchBtn = document.getElementById("clearSearch");
            const searchFeedbackEl = document.getElementById("search-feedback");

            // Initial generation of tracks and groups
            generateGroups();
            generateTracks();
            renderPersonalPlaylists();
            renderRecentSelections();
            
            // Initialize event listeners
            document.getElementById("modeToggle").addEventListener("click", toggleQuizMode);

            // Speed slider
            document.getElementById("speedSlider").addEventListener("input", function() {
                changeSpeed(parseFloat(this.value));
            });
            
            // Quiz sliders (already have inline oninput, but adding change listeners for consistency)
            document.getElementById("quizTimeSlider").addEventListener("change", function() {
                changeQuizTime(parseInt(this.value));
            });
            document.getElementById("quizDelaySlider").addEventListener("change", function() {
                changeQuizDelay(parseInt(this.value));
            });
            
            // Search functionality
            clearSearchBtn.addEventListener("click", () => {
                searchInput.value = "";
                searchInput.dispatchEvent(new Event('input'));
            });

            searchInput.addEventListener("input", function () {
                const term = this.value.trim().toLowerCase();
                let found = false;
                document.querySelectorAll("#trackList li").forEach(li => {
                    const trackNumber = li.querySelector(".trackBox").value;
                    // Check if it's the start of the number or an exact match
                    if (!term || trackNumber.startsWith(term)) { 
                        li.classList.remove("hidden");
                        found = true;
                    } else {
                        li.classList.add("hidden");
                    }
                });
                searchFeedbackEl.classList.toggle("hidden", found);
                clearSearchBtn.classList.toggle("hidden", term === "");
            });
            
            // Track selection change listener (for styling and unchecking other lists)
            trackListEl.addEventListener("change", function(event) {
                if (event.target.classList.contains("trackBox")) {
                    const label = event.target.closest("label");
                    const isChecked = event.target.checked;
                    label.classList.toggle("selected", isChecked);
                    updateGroupButtonSelection();
                    
                    // Uncheck other selection sources when a track is manually checked
                    document.querySelectorAll(".recent-box, .playlist-box").forEach(cb => {
                        cb.checked = false;
                        cb.closest("label").classList.remove("selected");
                    });
                }
            });
            
            // Recent/Playlist list change listeners (uncheck tracks/other lists)
            document.getElementById("recentList").addEventListener("change", function(event) {
                if (event.target.classList.contains("recent-box")) {
                    document.querySelectorAll(".track-item.selected, .playlist-item.selected").forEach(item => item.classList.remove("selected"));
                    document.querySelectorAll(".trackBox, .playlist-box").forEach(cb => cb.checked = false);

                    // Ensure only one recent item can be selected at a time if that was the intended behavior
                    // If multiple selection is intended, remove this part:
                    document.querySelectorAll(".recent-box").forEach(cb => {
                        if (cb !== event.target) cb.checked = false;
                    });
                }
            });
            
            document.getElementById("playlistList").addEventListener("change", function(event) {
                if (event.target.classList.contains("playlist-box")) {
                    document.querySelectorAll(".track-item.selected, .recent-item.selected").forEach(item => item.classList.remove("selected"));
                    document.querySelectorAll(".trackBox, .recent-box").forEach(cb => cb.checked = false);

                    // Ensure only one playlist can be selected at a time if that was the intended behavior
                    // If multiple selection is intended, remove this part:
                    document.querySelectorAll(".playlist-box").forEach(cb => {
                        if (cb !== event.target) cb.checked = false;
                    });
                }
            });

            // Restore initial onended handler for standard play
            audioPlayer.onended = playCurrent;

            // Update save playlist button state on load
            updateGroupButtonSelection();
            
            // Show status
            showToast("Player loaded successfully!");
        });
    </script>
</body>
</html>
