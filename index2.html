<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Rajipo - Apple Music UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2GQR+q1U/G1bYfQYy9kH9hT7p0uE/I8T2OQ+YQ+c2wJpC8XvPqjG6Jg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://ia601703.us.archive.org">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1c1c1e;
            --container-bg: #2c2c2e;
            --card-bg: #2e2e30;
            --text-color: #f2f2f7;
            --secondary-text: #a0a0a0;
            --accent-blue: #0a84ff;
            --accent-green: #30d158;
            --accent-red: #ff453a;
            --border-color: #38383a;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
            padding-bottom: 120px;
        }
        
        .container-card {
            background-color: var(--container-bg);
            border-radius: 14px;
            padding: 16px;
        }
        .track-item, .playlist-item, .recent-item {
            background-color: var(--card-bg);
            transition: transform 0.2s ease, background-color 0.2s ease;
            cursor: pointer;
            border-radius: 10px;
            border: 1px solid transparent;
        }
        .track-item:hover, .playlist-item:hover, .recent-item:hover {
            transform: scale(1.02);
            background-color: #3b3b3d;
        }
        .track-item.selected, .playlist-item.selected, .recent-item.selected {
            background-color: var(--accent-blue);
            color: white;
            transform: scale(1.02);
        }

        input[type="text"], input[type="number"] {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 10px;
            padding: 12px;
            box-shadow: none;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        input[type="text"]::placeholder, input[type="number"]::placeholder {
            color: var(--secondary-text);
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: var(--border-color);
            outline: none;
            border-radius: 9999px;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--accent-blue);
            cursor: pointer;
            border-radius: 50%;
            border: 4px solid var(--container-bg);
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: var(--accent-blue);
            cursor: pointer;
            border-radius: 50%;
            border: 4px solid var(--container-bg);
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
        }

        .btn-primary {
            background-color: var(--accent-blue);
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #2b91ff;
            transform: scale(1.01);
        }
        .btn-secondary {
            background-color: #48484a;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-secondary:hover {
            background-color: #5d5d5f;
            transform: scale(1.01);
        }
        .btn-green {
            background-color: var(--accent-green);
        }
        .btn-green:hover {
            background-color: #40c666;
        }
        .btn-red {
            background-color: var(--accent-red);
        }
        .btn-red:hover {
            background-color: #ff574d;
        }
        .btn-rounded {
            border-radius: 10px;
            padding: 12px 20px;
            font-weight: 600;
        }
        
        .trackBox, .recent-box, .playlist-box {
            display: none;
        }
        .track-item, .recent-item, .playlist-item {
            position: relative;
            user-select: none;
            min-height: 48px;
            display: flex;
            align-items: center;
        }
        .track-item::before, .recent-item::before, .playlist-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 12px;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid var(--secondary-text);
            transition: all 0.2s;
        }
        .track-item.selected::before, .recent-item.selected::before, .playlist-item.selected::before {
            border-color: var(--accent-blue);
            background-color: var(--accent-blue);
        }
        .track-item.selected::after, .recent-item.selected::after, .playlist-item.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 14px;
            transform: translateY(-50%);
            color: white;
            font-size: 10px;
        }
        .group-btn {
            position: relative;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 0.875rem;
            transition: background-color 0.2s, transform 0.1s, border-color 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 48px;
        }
        .group-btn:hover {
            background-color: #3b3b3d;
            transform: scale(1.02);
        }
        .group-btn.selected {
            background-color: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        .checkmark {
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 1.25rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .group-btn.selected .checkmark {
            opacity: 1;
        }

        #quizControls {
            min-height: 250px;
        }
        .countdown-bar {
            height: 6px;
            background: linear-gradient(90deg, #ff453a, #ff9f0a, #30d158);
            transition: width 0.5s ease-out;
            border-radius: 9999px;
        }
        .countdown-bar-container {
            height: 8px; 
            background-color: var(--border-color);
            border-radius: 9999px;
            margin-bottom: 8px;
        }

        footer {
            background-color: #1e1e1e;
            border-top: 1px solid #333;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: var(--container-bg);
            border-radius: 14px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            color: var(--text-color);
            text-align: center;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
        }

        .toast-container {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 60;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 90%;
            max-width: 400px;
        }

        .toast {
            background-color: rgba(48, 48, 48, 0.9);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            opacity: 0;
            animation: fadeInOut 4s ease-in-out forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .fade-in { animation: fadeIn 200ms ease-in forwards; opacity: 0; }
        .fade-out { animation: fadeOut 200ms ease-out forwards; opacity: 1; }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; } }
    </style>
</head>
<body class="flex flex-col">

    <div class="max-w-xl mx-auto p-4 flex flex-col flex-1 w-full">
        <h1 class="text-3xl font-bold text-center mb-6 text-white">Mission Rajipo ðŸŽµ</h1>
        
        <div id="mainControls" class="space-y-3 mb-6 container-card">
            <div id="search-container" class="relative">
                <input id="search" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Search shlok number..." class="w-full pr-10" aria-label="Search shlok number">
                <i id="clearSearch" class="fa-solid fa-xmark absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 cursor-pointer hidden"></i>
            </div>
            <div id="search-feedback" class="text-center text-red-400 font-semibold hidden" aria-live="polite">No matching shlokas found.</div>
            <div class="flex gap-2">
                <input id="rangeStart" type="number" min="1" max="315" placeholder="Start" class="w-1/2">
                <input id="rangeEnd" type="number" min="1" max="315" placeholder="End" class="w-1/2">
                <button onclick="selectRange()" class="px-4 py-3 bg-gray-500 text-white rounded-lg flex items-center gap-1 btn-secondary">
                    <i class="fa-solid fa-list-ol"></i> Range
                </button>
            </div>
        </div>

        <div id="groups-container" class="mb-6 container-card">
            <button onclick="toggleGroupDisplay()" class="w-full py-3 btn-rounded btn-secondary flex items-center justify-center gap-2 mb-3">
                <i id="group-toggle-icon" class="fa-solid fa-chevron-down"></i> Groups
            </button>
            <div id="groups" class="grid grid-cols-3 gap-2 justify-items-center mb-3 hidden"></div>
        </div>
        
        <div class="mb-6 container-card space-y-4">
            <button onclick="toggleMode()" class="w-full py-3 btn-rounded btn-secondary flex items-center justify-center gap-2">
                <i class="fa-solid fa-toggle-off"></i> Toggle to Quiz Mode
            </button>
        
            <div id="dynamicControlsWrapper" class="relative min-h-[250px]">
                <div id="quizControls" class="space-y-4 absolute w-full top-0 left-0 fade-out hidden">
                    <h2 class="text-xl font-bold text-center">Quiz Mode ðŸ§ </h2>
                    <p id="currentShlokQuiz" class="text-lg font-semibold text-center text-gray-400">Shlok 0</p>
                    <div class="countdown-bar-container">
                        <div id="countdownBar" class="countdown-bar h-full"></div>
                    </div>
                    
                    <div class="min-h-[24px] flex justify-between items-center space-x-2">
                        <p id="quizStatus" class="font-semibold text-green-400" aria-live="polite"></p>
                        <span id="countdown" class="font-semibold text-white"></span>
                    </div>

                    <div class="flex items-center space-x-4 w-full">
                        <span class="text-sm text-gray-400 w-16">Pause:</span>
                        <input type="range" id="quizTimeSlider" min="5" max="60" step="5" value="20" class="flex-1">
                        <span id="quizTimeDisplay" class="font-semibold w-10 text-white">20s</span>
                    </div>
                    <div class="flex items-center space-x-4 w-full">
                        <span class="text-sm text-gray-400 w-16">Play Delay:</span>
                        <input type="range" id="quizDelaySlider" min="1" max="10" step="1" value="3" class="flex-1">
                        <span id="quizDelayDisplay" class="font-semibold w-10 text-white">3s</span>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <button id="autoPlayToggle" onclick="toggleAutoPlay()" class="px-4 py-3 btn-secondary text-white btn-rounded flex items-center gap-2">
                            <i class="fa-solid fa-toggle-off"></i>Auto-Play: OFF
                        </button>
                        <button id="playFullBtn" onclick="playFullShloka()" class="px-4 py-3 btn-secondary text-white btn-rounded flex items-center gap-2 hidden">
                            <i class="fa-solid fa-redo"></i> Play Full Shloka
                        </button>
                    </div>
                    <button onclick="playNextQuizTrack()" class="w-full py-3 btn-primary text-white btn-rounded">
                        <i class="fa-solid fa-forward"></i> Play Next
                    </button>
                </div>
                
                <div id="regularControls" class="space-y-4 absolute w-full top-0 left-0 fade-in">
                    <div class="flex flex-wrap justify-between items-center gap-4 text-sm text-gray-400">
                        <label class="flex-1 flex items-center gap-2">
                            <span class="text-gray-400">Repeat:</span> 
                            <input id="repeatCount" type="number" min="1" value="1" class="w-16 p-1 text-center bg-transparent border-b-2 border-gray-600">
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="shuffle" class="h-4 w-4 rounded text-blue-600 bg-gray-800 border-gray-600">
                            Shuffle
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="repeatPlaylist" class="h-4 w-4 rounded text-blue-600 bg-gray-800 border-gray-600">
                            Repeat
                        </label>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-400 w-12">Speed:</span>
                        <input type="range" id="speedSlider" min="0.5" max="1.5" step="0.1" value="1.0" class="flex-1">
                        <span id="speedDisplay" class="font-semibold w-8 text-white">1.0</span>x
                    </div>
                    
                    <div class="flex flex-col gap-2 sm:flex-row">
                        <button onclick="playSelected()" class="flex-1 py-3 btn-primary text-white btn-rounded">
                            <i class="fa-solid fa-play"></i> Play
                        </button>
                        <button onclick="confirmClearSelection()" class="flex-1 py-3 btn-red text-white btn-rounded">
                            <i class="fa-solid fa-eraser"></i> Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="personalPlaylists" class="mt-6 container-card">
            <h2 class="text-lg font-bold mb-3 text-white">My Personal Playlists ðŸ’¾</h2>
            <p id="playlist-empty" class="text-gray-400 text-center mb-3 hidden">No saved playlists yet.</p>
            <ul id="playlistList" class="space-y-3 mb-4"></ul>
            <div id="savePlaylistBtn" class="hidden">
                 <button onclick="showSavePlaylistModal()" class="w-full py-3 btn-rounded btn-green text-white flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus-circle"></i> Save as Playlist
                </button>
            </div>
        </div>

        <div id="recentlyPlayed" class="mt-6 hidden container-card">
            <h2 class="text-lg font-bold mb-3 text-white">Recently Played</h2>
            <ul id="recentList" class="space-y-3"></ul>
            <p id="recent-empty" class="text-gray-400 text-center hidden">Your recently played selections will appear here.</p>
            <button onclick="confirmClearHistory()" class="mt-4 w-full py-3 btn-rounded btn-secondary flex items-center justify-center gap-2">
                <i class="fa-solid fa-trash-can"></i> Clear History
            </button>
        </div>

        <h2 id="allShlokasTitle" class="text-lg font-bold mt-6 mb-3 text-white">All Shlokas</h2>
        <ul id="trackList" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></ul>
    </div>

    <footer class="fixed bottom-0 left-0 right-0 shadow p-3 z-10 bg-[#1e1e1e]">
        <audio id="audioPlayer" controls class="w-full"></audio>
    </footer>

    <div id="toast-container" class="toast-container"></div>
    <div id="modal-container"></div>

    <script>
        const TOTAL_TRACKS = 315;
        const AUDIO_BASE_URL = 'https://ia601703.us.archive.org/35/items/satsang_diksha';
        const MAX_RECENT_ITEMS = 5;

        let audioPlayer;
        let playlist = [];
        let currentIndex = 0;
        let repeatEach = 1;
        let repeatCounter = 0;
        let currentSpeed = 1.0;
        let isQuizMode = false;
        let hasQuizPaused = false;
        let autoPlay = false;
        let autoPlayTimeout = null;
        let countdownInterval = null;
        let currentQuizTime = 20;
        let currentQuizDelay = 3;
        let quizTimeUpdateListener = null;
        let searchTimeout = null;

        function isLocalStorageAvailable() {
            try {
                const test = '__localStorageTest__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }
        const localStorageEnabled = isLocalStorageAvailable();

        function clearAllTimers() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            if (autoPlayTimeout) {
                clearTimeout(autoPlayTimeout);
                autoPlayTimeout = null;
            }
            if (quizTimeUpdateListener) {
                audioPlayer.removeEventListener('timeupdate', quizTimeUpdateListener);
                quizTimeUpdateListener = null;
            }
        }

        function getAudioUrl(trackNum) {
            return `${AUDIO_BASE_URL}/sanskrit_${String(trackNum).padStart(3, '0')}.mp3`;
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function createElementWithText(tag, text, className = '') {
            const el = document.createElement(tag);
            if (className) el.className = className;
            el.textContent = text;
            return el;
        }

        function handleAudioError(err, trackNum) {
            console.error("Play error:", err);
            
            if (!navigator.onLine) {
                showToast("No internet connection detected.");
            } else if (err.name === 'NotSupportedError') {
                showToast("Audio format not supported in your browser.");
            } else if (err.name === 'NotAllowedError') {
                showToast("Playback not allowed. Please interact with the page first.");
            } else {
                showToast(`Failed to load Shlok ${trackNum}. File may be unavailable.`);
            }
        }

        function playCurrent() {
            if (currentIndex < playlist.length) {
                const trackNum = playlist[currentIndex];
                audioPlayer.src = getAudioUrl(trackNum);
                audioPlayer.playbackRate = currentSpeed;
                audioPlayer.play().catch(err => {
                    handleAudioError(err, trackNum);
                });
            } else if (document.getElementById("repeatPlaylist").checked) {
                currentIndex = 0;
                playCurrent();
            } else {
                audioPlayer.pause();
                audioPlayer.src = "";
            }
        }

        function toggleMode() {
            isQuizMode = !isQuizMode;

            const quizControlsEl = document.getElementById('quizControls');
            const regularControlsEl = document.getElementById('regularControls');
            
            if (quizControlsEl) {
                quizControlsEl.classList.toggle('hidden', !isQuizMode);
                quizControlsEl.classList.toggle('fade-in', isQuizMode);
                quizControlsEl.classList.toggle('fade-out', !isQuizMode);
            }
            if (regularControlsEl) {
                regularControlsEl.classList.toggle('hidden', isQuizMode);
                regularControlsEl.classList.toggle('fade-out', isQuizMode);
                regularControlsEl.classList.toggle('fade-in', !isQuizMode);
            }

            const modeButton = document.querySelector('button[onclick="toggleMode()"]');
            if (modeButton) {
                modeButton.innerHTML = `<i class="fa-solid fa-toggle-${isQuizMode ? 'on' : 'off'}"></i> ${isQuizMode ? 'Exit Quiz Mode' : 'Toggle to Quiz Mode'}`;
            }

            if (isQuizMode) {
                try { 
                    audioPlayer.pause(); 
                    audioPlayer.src = ''; 
                } catch(e) {}
                playlist = [];
                currentIndex = 0;
                document.getElementById('playFullBtn').classList.add('hidden');
                const countdownBar = document.getElementById('countdownBar');
                if (countdownBar) countdownBar.style.width = '100%';
                clearAllTimers();
            } else {
                clearAllTimers();
                const quizStatus = document.getElementById('quizStatus');
                const countdown = document.getElementById('countdown');
                if (quizStatus) quizStatus.textContent = '';
                if (countdown) countdown.textContent = '';
                document.getElementById('playFullBtn').classList.add('hidden');
            }
            updateGroupButtonSelection();
        }
        
        function changeSpeed(speed) {
            currentSpeed = speed;
            audioPlayer.playbackRate = currentSpeed;
            document.getElementById("speedDisplay").textContent = currentSpeed.toFixed(1);
        }

        function playSelected() {
            const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked"))
                .map(cb => JSON.parse(cb.dataset.selection));
            const selectedTracks = Array.from(document.querySelectorAll(".trackBox:checked"))
                .map(cb => parseInt(cb.value, 10));

            let finalSelection = [];
            if (selectedPlaylists.length > 0) {
                const playlistShlokas = new Set(selectedPlaylists.flatMap(p => p));
                finalSelection = Array.from(playlistShlokas);
            } else {
                finalSelection = selectedTracks;
            }

            if (finalSelection.length === 0) {
                showModal("Please select at least one shlok or a playlist to play.");
                return;
            }

            repeatEach = parseInt(document.getElementById("repeatCount").value) || 1;
            playlist = [...finalSelection];
            if (document.getElementById("shuffle").checked) {
                playlist = playlist.sort(() => Math.random() - 0.5);
            }
            currentIndex = 0;
            repeatCounter = 0;
            if (localStorageEnabled) {
                saveSelection(finalSelection);
            }
            playCurrent();
            showToast("Playback started.");
        }

        function playNextQuizTrack() {
            let selected = [];
            
            const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked"))
                .map(cb => JSON.parse(cb.dataset.selection));
            const selectedRecents = Array.from(document.querySelectorAll(".recent-box:checked"))
                .map(cb => cb.dataset.selection.split(",").map(n => parseInt(n.trim())));
            
            if (selectedPlaylists.length > 0) {
                 const playlistShlokas = new Set(selectedPlaylists.flatMap(p => p));
                 selected = Array.from(playlistShlokas);
            } else if (selectedRecents.length > 0) {
                const allNumbers = new Set(selectedRecents.flat());
                selected = Array.from(allNumbers);
            } else {
                selected = Array.from(document.querySelectorAll(".trackBox:checked"))
                    .map(cb => parseInt(cb.value, 10));
            }

            if (selected.length === 0) {
                showModal("Please select a group of shlokas or a playlist to quiz yourself on first!");
                return;
            }

            if (playlist.length === 0 || currentIndex >= playlist.length) {
                playlist = [...selected].sort(() => Math.random() - 0.5);
                currentIndex = 0;
            }

            clearAllTimers();
            document.getElementById('quizStatus').textContent = '';
            document.getElementById('playFullBtn').classList.add('hidden');
            document.getElementById('countdownBar').style.width = '100%';

            const trackNum = playlist[currentIndex];
            document.getElementById('currentShlokQuiz').textContent = `Now playing: Shlok ${trackNum}`;
            audioPlayer.src = getAudioUrl(trackNum);
            audioPlayer.playbackRate = currentSpeed;
            
            hasQuizPaused = false;
            
            audioPlayer.play().catch(err => {
                handleAudioError(err, trackNum);
            });

            currentIndex++;
        }

        function setupQuizPauseListener() {
            if (quizTimeUpdateListener) {
                audioPlayer.removeEventListener('timeupdate', quizTimeUpdateListener);
            }
            
            quizTimeUpdateListener = function() {
                if (audioPlayer.currentTime >= currentQuizDelay && !hasQuizPaused) {
                    audioPlayer.pause();
                    hasQuizPaused = true;
                    audioPlayer.removeEventListener('timeupdate', quizTimeUpdateListener);
                    quizTimeUpdateListener = null;
                    
                    document.getElementById('quizStatus').textContent = "Audio Paused. Your turn to recite!";
                    document.getElementById('playFullBtn').classList.remove('hidden');

                    let countdown = currentQuizTime;
                    const countdownEl = document.getElementById('countdown');
                    countdownEl.textContent = `(${countdown}s)`;
                    
                    document.getElementById('countdownBar').style.width = `${(countdown / currentQuizTime) * 100}%`;

                    countdownInterval = setInterval(() => {
                        countdown--;
                        countdownEl.textContent = `(${countdown}s)`;
                        document.getElementById('countdownBar').style.width = `${(countdown / currentQuizTime) * 100}%`;
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            countdownInterval = null;
                            countdownEl.textContent = '';
                            document.getElementById('quizStatus').textContent = '';
                            if (autoPlay) {
                                playNextQuizTrack();
                            }
                        }
                    }, 1000);
                }
            };
            
            audioPlayer.addEventListener('timeupdate', quizTimeUpdateListener);
        }

        function showSavePlaylistModal() {
            if (!localStorageEnabled) {
                showModal("Local storage is not enabled or available in your browser. Cannot save playlists.");
                return;
            }
            const selectedTracks = Array.from(document.querySelectorAll(".trackBox:checked"))
                .map(cb => parseInt(cb.value, 10));
            
            if (selectedTracks.length === 0) {
                showModal("Please select at least one shlok to save as a playlist.");
                return;
            }

            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content text-left';
            
            const closeBtn = document.createElement('span');
            closeBtn.className = 'modal-close';
            closeBtn.setAttribute('tabindex', '0');
            closeBtn.setAttribute('role', 'button');
            closeBtn.setAttribute('aria-label', 'Close');
            closeBtn.innerHTML = '&times;';
            
            const title = createElementWithText('h3', 'Save Playlist', 'text-xl font-bold mb-4');
            const description = createElementWithText('p', 'Enter a name for your playlist:', 'mb-2');
            
            const input = document.createElement('input');
            input.type = 'text';
            input.id = 'playlistNameInput';
            input.className = 'w-full mb-4';
            input.placeholder = 'My new playlist';
            input.maxLength = 50;
            
            const feedback = document.createElement('div');
            feedback.id = 'playlistNameFeedback';
            feedback.className = 'text-red-400 font-semibold hidden mb-4';
            feedback.setAttribute('role', 'alert');
            
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'flex gap-4 justify-end';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'px-4 py-3 btn-secondary text-white btn-rounded';
            cancelBtn.textContent = 'Cancel';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'px-4 py-3 btn-green text-white btn-rounded';
            saveBtn.textContent = 'Save';
            
            buttonDiv.appendChild(cancelBtn);
            buttonDiv.appendChild(saveBtn);
            
            modalContent.appendChild(closeBtn);
            modalContent.appendChild(title);
            modalContent.appendChild(description);
            modalContent.appendChild(input);
            modalContent.appendChild(feedback);
            modalContent.appendChild(buttonDiv);
            modal.appendChild(modalContent);

            function closeModal() {
                modal.remove();
            }

            function savePlaylist() {
                const playlistName = input.value.trim();
                if (playlistName === "") {
                    feedback.textContent = "Playlist name cannot be empty.";
                    feedback.classList.remove('hidden');
                    return;
                }
                let playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
                if (playlists[playlistName]) {
                    feedback.textContent = "A playlist with this name already exists.";
                    feedback.classList.remove('hidden');
                    return;
                }
                playlists[playlistName] = selectedTracks;
                localStorage.setItem("personalPlaylists", JSON.stringify(playlists));
                renderPersonalPlaylists();
                showToast(`Playlist "${escapeHTML(playlistName)}" saved!`);
                closeModal();
            }

            const focusableElements = [closeBtn, input, cancelBtn, saveBtn];
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                } else if (e.key === 'Tab') {
                    if (e.shiftKey && document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    } else if (!e.shiftKey && document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            });

            saveBtn.addEventListener('click', savePlaylist);
            cancelBtn.addEventListener('click', closeModal);
            closeBtn.addEventListener('click', closeModal);
            closeBtn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    closeModal();
                }
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    savePlaylist();
                }
            });
            
            modalContainer.appendChild(modal);
            input.focus();
        }

        function renderPersonalPlaylists() {
            if (!localStorageEnabled) return;
            
            const playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
            const playlistList = document.getElementById("playlistList");
            const personalPlaylistsDiv = document.getElementById("personalPlaylists");
            const emptyMessage = document.getElementById("playlist-empty");

            playlistList.innerHTML = "";
            const names = Object.keys(playlists);
            
            if (names.length === 0) {
                personalPlaylistsDiv.classList.remove("hidden");
                emptyMessage.classList.remove("hidden");
            } else {
                personalPlaylistsDiv.classList.remove("hidden");
                emptyMessage.classList.add("hidden");
            }
            
            names.forEach(name => {
                const shlokas = playlists[name];
                const li = document.createElement("li");
                li.className = "space-y-2";
                
                const label = document.createElement('label');
                label.className = "playlist-item block p-3 container-card cursor-pointer flex items-center justify-between";
                
                const leftDiv = document.createElement('div');
                leftDiv.className = "flex items-center";
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'playlist-box mr-2';
                checkbox.dataset.selection = JSON.stringify(shlokas);
                
                const nameSpan = createElementWithText('span', name, 'ml-6 font-semibold');
                
                leftDiv.appendChild(checkbox);
                leftDiv.appendChild(nameSpan);
                
                const rightDiv = document.createElement('div');
                rightDiv.className = "flex items-center space-x-2 text-sm text-gray-400";
                
                const countSpan = createElementWithText('span', `(${shlokas.length} shlokas)`);
                
                const loadBtn = document.createElement('button');
                loadBtn.className = "text-xs px-2 py-1 btn-secondary rounded-full";
                loadBtn.textContent = 'Load';
                loadBtn.onclick = (e) => {
                    e.stopPropagation();
                    loadPlaylist(name);
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = "text-xs px-2 py-1 btn-red rounded-full";
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    confirmDeletePlaylist(name);
                };
                
                rightDiv.appendChild(countSpan);
                rightDiv.appendChild(loadBtn);
                rightDiv.appendChild(deleteBtn);
                
                label.appendChild(leftDiv);
                label.appendChild(rightDiv);
                li.appendChild(label);
                playlistList.appendChild(li);
            });
        }

        function loadPlaylist(name) {
            if (!localStorageEnabled) return;
            let playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
            const shlokas = playlists[name];
            if (shlokas) {
                clearSelection();
                shlokas.forEach(trackNum => {
                    const checkbox = document.querySelector(`.trackBox[value="${trackNum}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.closest("label").classList.add("selected");
                    }
                });
                updateGroupButtonSelection();
                showToast(`Playlist "${escapeHTML(name)}" loaded into your selection!`);
            }
        }

        function deletePlaylist(name) {
            if (!localStorageEnabled) return;
            let playlists = JSON.parse(localStorage.getItem("personalPlaylists")) || {};
            delete playlists[name];
            localStorage.setItem("personalPlaylists", JSON.stringify(playlists));
            renderPersonalPlaylists();
        }

        function saveSelection(selection) {
            if (!localStorageEnabled) return;
            let history = [];
            try { 
                history = JSON.parse(localStorage.getItem("recentSelections")) || []; 
            } catch (e) { 
                history = []; 
            }
            const selString = selection.join(",");
            history = [selString, ...history.filter(h => h !== selString)].slice(0, MAX_RECENT_ITEMS);
            localStorage.setItem("recentSelections", JSON.stringify(history));
            renderRecentSelections();
        }

        function clearHistory() {
            if (!localStorageEnabled) return;
            localStorage.removeItem("recentSelections");
            renderRecentSelections();
        }

        function renderRecentSelections() {
            if (!localStorageEnabled) return;
            
            const history = JSON.parse(localStorage.getItem("recentSelections")) || [];
            const recentDiv = document.getElementById("recentlyPlayed");
            const recentList = document.getElementById("recentList");
            const recentEmpty = document.getElementById("recent-empty");
            recentList.innerHTML = "";
            
            if (history.length === 0) { 
                recentDiv.classList.add("hidden"); 
                recentEmpty.classList.remove("hidden");
                return; 
            }
            
            recentDiv.classList.remove("hidden");
            recentEmpty.classList.add("hidden");
            
            history.forEach((sel) => {
                const numbers = sel.split(",").map(n => parseInt(n.trim()));
                let labelText = numbers.length <= 6 ? "Shlok " + numbers.join(", ") : `Shlok ${numbers[0]}â€“${numbers[numbers.length - 1]} (${numbers.length} total)`;
                
                const li = document.createElement("li");
                li.className = "space-y-2";
                
                const label = document.createElement('label');
                label.className = "recent-item block p-3 container-card cursor-pointer";
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'recent-box mr-2';
                checkbox.dataset.selection = sel;
                
                const textSpan = createElementWithText('span', labelText, 'ml-6');
                
                label.appendChild(checkbox);
                label.appendChild(textSpan);
                li.appendChild(label);
                recentList.appendChild(li);
            });
        }

        function restoreLastSelection() {
            if (!localStorageEnabled) return;
            let history = [];
            try { 
                history = JSON.parse(localStorage.getItem("recentSelections")) || []; 
            } catch (e) { 
                history = []; 
            }
            if (history.length > 0) {
                const lastSel = history[0].split(",").map(n => parseInt(n.trim()));
                document.querySelectorAll(".trackBox").forEach(cb => {
                    const isChecked = lastSel.includes(parseInt(cb.value, 10));
                    cb.checked = isChecked;
                    cb.closest("label").classList.toggle("selected", isChecked);
                });
                updateGroupButtonSelection();
            }
        }
        
        function updateGroupButtonSelection() {
            const selectedTracks = new Set(Array.from(document.querySelectorAll(".trackBox:checked")).map(cb => parseInt(cb.value)));
            document.querySelectorAll(".group-btn").forEach(btn => {
                const start = parseInt(btn.dataset.start);
                const end = parseInt(btn.dataset.end);
                if (isNaN(start) || isNaN(end)) return;
                
                let isGroupSelected = true;
                for(let i = start; i <= end; i++) {
                    if (!selectedTracks.has(i)) {
                        isGroupSelected = false;
                        break;
                    }
                }
                btn.classList.toggle('selected', isGroupSelected);
                btn.setAttribute('aria-pressed', isGroupSelected.toString());
            });
            
            const savePlaylistBtn = document.getElementById('savePlaylistBtn');
            if (savePlaylistBtn) {
                savePlaylistBtn.classList.toggle('hidden', selectedTracks.size === 0 || isQuizMode);
            }
        }

        function generateGroups() {
            const groupDiv = document.getElementById("groups");
            for (let i = 1; i <= TOTAL_TRACKS; i += 10) {
                const end = Math.min(i + 9, TOTAL_TRACKS);
                const btn = document.createElement("button");
                btn.className = "group-btn";
                btn.setAttribute("tabindex", "0");
                btn.setAttribute("aria-pressed", "false");
                btn.dataset.start = i;
                btn.dataset.end = end;
                
                const textNode = document.createTextNode(`${i}â€“${end}`);
                const checkmark = document.createElement('span');
                checkmark.className = 'checkmark';
                checkmark.textContent = 'âœ“';
                
                btn.appendChild(textNode);
                btn.appendChild(checkmark);
                btn.onclick = () => toggleGroup(i, end, btn);
                groupDiv.appendChild(btn);
            }
        }

        function generateTracks() {
            const trackListEl = document.getElementById("trackList");
            for (let i = 1; i <= TOTAL_TRACKS; i++) {
                const li = document.createElement("li");
                
                const label = document.createElement('label');
                label.className = "track-item block p-3 text-white";
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = i;
                checkbox.className = 'trackBox mr-2';
                
                const textSpan = createElementWithText('span', `Shlok ${i}`, 'ml-6');
                
                label.appendChild(checkbox);
                label.appendChild(textSpan);
                li.appendChild(label);
                trackListEl.appendChild(li);
            }
        }

        function showModal(message, onConfirm = null) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            const closeBtn = document.createElement('span');
            closeBtn.className = 'modal-close';
            closeBtn.setAttribute('tabindex', '0');
            closeBtn.setAttribute('role', 'button');
            closeBtn.setAttribute('aria-label', 'Close');
            closeBtn.innerHTML = '&times;';
            
            const messagePara = document.createElement('p');
            messagePara.className = 'mb-4';
            messagePara.innerHTML = message;
            
            modalContent.appendChild(closeBtn);
            modalContent.appendChild(messagePara);
            
            function closeModal() {
                modal.remove();
            }
            
            if (onConfirm) {
                const buttonDiv = document.createElement('div');
                buttonDiv.className = 'flex gap-4 justify-center';
                
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'px-4 py-3 btn-red text-white btn-rounded';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = closeModal;
                
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'px-4 py-3 btn-primary text-white btn-rounded';
                confirmBtn.textContent = 'OK';
                confirmBtn.onclick = () => {
                    onConfirm();
                    closeModal();
                };
                
                buttonDiv.appendChild(cancelBtn);
                buttonDiv.appendChild(confirmBtn);
                modalContent.appendChild(buttonDiv);
                
                const focusableElements = [closeBtn, cancelBtn, confirmBtn];
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                    } else if (e.key === 'Tab') {
                        if (e.shiftKey && document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        } else if (!e.shiftKey && document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                });
            } else {
                const okBtn = document.createElement('button');
                okBtn.className = 'px-4 py-3 btn-primary text-white btn-rounded';
                okBtn.textContent = 'OK';
                okBtn.onclick = closeModal;
                modalContent.appendChild(okBtn);
                
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' || e.key === 'Enter') {
                        closeModal();
                    }
                });
            }
            
            closeBtn.onclick = closeModal;
            closeBtn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    closeModal();
                }
            });
            
            modal.appendChild(modalContent);
            modalContainer.appendChild(modal);
            closeBtn.focus();
        }

        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.setAttribute('role', 'status');
            toast.setAttribute('aria-live', 'polite');
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        document.addEventListener("DOMContentLoaded", function () {
            audioPlayer = document.getElementById("audioPlayer");
            const searchInput = document.getElementById("search");
            const clearSearchBtn = document.getElementById("clearSearch");
            const searchFeedbackEl = document.getElementById("search-feedback");

            const speedSlider = document.getElementById("speedSlider");
            speedSlider.addEventListener("input", function() {
                changeSpeed(parseFloat(this.value));
            });

            const quizTimeSlider = document.getElementById("quizTimeSlider");
            quizTimeSlider.addEventListener("input", function() {
                changeQuizTime(parseInt(this.value));
            });

            const quizDelaySlider = document.getElementById("quizDelaySlider");
            quizDelaySlider.addEventListener("input", function() {
                changeQuizDelay(parseInt(this.value));
            });
            
            clearSearchBtn.addEventListener("click", () => {
                searchInput.value = "";
                searchInput.dispatchEvent(new Event('input'));
            });

            searchInput.addEventListener("input", function () {
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                const term = this.value.trim().toLowerCase();
                
                searchTimeout = setTimeout(() => {
                    let found = false;
                    document.querySelectorAll("#trackList li").forEach(li => {
                        const trackNumber = li.querySelector(".trackBox").value;
                        if (!term || trackNumber.startsWith(term)) {
                            li.classList.remove("hidden");
                            found = true;
                        } else {
                            li.classList.add("hidden");
                        }
                    });
                    searchFeedbackEl.classList.toggle("hidden", found);
                }, 150);
                
                clearSearchBtn.classList.toggle("hidden", term === "");
            });

            document.getElementById("trackList").addEventListener("change", function(event) {
                if (event.target.classList.contains("trackBox")) {
                    const label = event.target.closest("label");
                    const isChecked = event.target.checked;
                    label.classList.toggle("selected", isChecked);
                    updateGroupButtonSelection();
                    document.querySelectorAll(".recent-box, .playlist-box").forEach(cb => {
                        cb.checked = false;
                        cb.closest("label").classList.remove("selected");
                    });
                }
            });
            
            document.getElementById("recentList").addEventListener("change", function(event) {
                if (event.target.classList.contains("recent-box")) {
                    document.querySelectorAll(".track-item.selected, .playlist-item.selected").forEach(item => item.classList.remove("selected"));
                    document.querySelectorAll(".trackBox, .playlist-box").forEach(cb => cb.checked = false);

                    const selectedRecents = Array.from(document.querySelectorAll(".recent-box:checked"));
                    const allNumbers = new Set(selectedRecents.flatMap(cb => cb.dataset.selection.split(",").map(Number)));
                    
                    document.querySelectorAll(".trackBox").forEach(cb => {
                        const trackNum = parseInt(cb.value);
                        if (allNumbers.has(trackNum)) {
                            cb.checked = true;
                            cb.closest("label").classList.add("selected");
                        }
                    });
                    selectedRecents.forEach(cb => cb.closest("label").classList.add("selected"));
                    updateGroupButtonSelection();
                }
            });

            document.getElementById("playlistList").addEventListener("change", function(event) {
                if (event.target.classList.contains("playlist-box")) {
                    document.querySelectorAll(".track-item.selected, .recent-item.selected").forEach(item => item.classList.remove("selected"));
                    document.querySelectorAll(".trackBox, .recent-box").forEach(cb => cb.checked = false);

                    const selectedPlaylists = Array.from(document.querySelectorAll(".playlist-box:checked"));
                    const allNumbers = new Set(selectedPlaylists.flatMap(cb => JSON.parse(cb.dataset.selection)));
                    
                    document.querySelectorAll(".trackBox").forEach(cb => {
                        const trackNum = parseInt(cb.value);
                        if (allNumbers.has(trackNum)) {
                            cb.checked = true;
                            cb.closest("label").classList.add("selected");
                        }
                    });
                    selectedPlaylists.forEach(cb => cb.closest("label").classList.add("selected"));
                    updateGroupButtonSelection();
                }
            });

            audioPlayer.addEventListener("error", (e) => {
                const trackNum = playlist[currentIndex > 0 ? currentIndex - 1 : 0];
                if (e.target.error) {
                    switch(e.target.error.code) {
                        case e.target.error.MEDIA_ERR_NETWORK:
                            showToast(`Network error loading Shlok ${trackNum}. Check your connection.`);
                            break;
                        case e.target.error.MEDIA_ERR_DECODE:
                            showToast(`Error decoding Shlok ${trackNum}. File may be corrupted.`);
                            break;
                        case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            showToast(`Shlok ${trackNum} format not supported.`);
                            break;
                        default:
                            showToast(`Error loading Shlok ${trackNum}.`);
                    }
                } else {
                    showToast("An error occurred while loading the audio.");
                }
            });

            audioPlayer.addEventListener("playing", () => {
                if (isQuizMode && !hasQuizPaused) {
                    document.getElementById('playFullBtn').classList.add('hidden');
                    setupQuizPauseListener();
                }
            });

            audioPlayer.addEventListener("ended", () => {
                if (!isQuizMode) {
                    repeatCounter++;
                    if (repeatCounter >= repeatEach) {
                        repeatCounter = 0;
                        currentIndex++;
                    }
                    playCurrent();
                }
            });

            window.addEventListener('beforeunload', clearAllTimers);

            generateGroups();
            generateTracks();
            
            if (localStorageEnabled) {
                restoreLastSelection();
                renderRecentSelections();
                renderPersonalPlaylists();
            } else {
                showToast("Local storage is disabled. Playlists and history will not be saved.");
            }
        });
    </script>
</body>
</html>Selection();
        }

        function toggleAutoPlay() {
            autoPlay = !autoPlay;
            const button = document.getElementById("autoPlayToggle");
            button.innerHTML = `<i class="fa-solid fa-toggle-${autoPlay ? 'on' : 'off'}"></i> Auto-Play: ${autoPlay ? 'ON' : 'OFF'}`;
            button.classList.toggle('btn-secondary', !autoPlay);
            button.classList.toggle('btn-green', autoPlay);
        }

        function playFullShloka() {
            const trackNum = playlist[currentIndex > 0 ? currentIndex - 1 : 0];
            audioPlayer.src = getAudioUrl(trackNum);
            audioPlayer.playbackRate = currentSpeed;
            
            clearAllTimers();
            document.getElementById('quizStatus').textContent = '';
            document.getElementById('countdown').textContent = '';
            document.getElementById('playFullBtn').classList.add('hidden');

            audioPlayer.play().catch(err => {
                handleAudioError(err, trackNum);
            });
        }
        
        function changeQuizTime(time) {
            currentQuizTime = time;
            document.getElementById("quizTimeDisplay").textContent = `${currentQuizTime}s`;
        }

        function changeQuizDelay(delay) {
            currentQuizDelay = delay;
            document.getElementById("quizDelayDisplay").textContent = `${currentQuizDelay}s`;
        }
        
        function toggleGroupDisplay() {
            const groupsDiv = document.getElementById("groups");
            const isHidden = groupsDiv.classList.toggle("hidden");
            const groupToggleIcon = document.getElementById("group-toggle-icon");
            groupToggleIcon.classList.toggle("fa-chevron-down", isHidden);
            groupToggleIcon.classList.toggle("fa-chevron-up", !isHidden);
        }

        function clearSelection() {
            document.querySelectorAll(".track-item.selected, .recent-item.selected, .playlist-item.selected").forEach(item => item.classList.remove("selected"));
            document.querySelectorAll(".trackBox:checked, .recent-box:checked, .playlist-box:checked").forEach(cb => cb.checked = false);
            document.querySelectorAll(".group-btn.selected").forEach(btn => btn.classList.remove("selected"));
            playlist = [];
            currentIndex = 0;
            updateGroupButtonSelection();
            showToast("Selection cleared.");
        }

        function confirmClearSelection() {
            showModal("Are you sure you want to clear your current selection?", () => {
                clearSelection();
            });
        }

        function confirmClearHistory() {
            showModal("Are you sure you want to clear your recently played history? This action cannot be undone.", () => {
                clearHistory();
                showToast("Recently played history cleared.");
            });
        }
        
        function confirmDeletePlaylist(playlistName) {
             showModal(`Are you sure you want to delete the playlist "${escapeHTML(playlistName)}"? This action cannot be undone.`, () => {
                deletePlaylist(playlistName);
                showToast(`Playlist "${escapeHTML(playlistName)}" deleted.`);
            });
        }
        
        function selectRange() {
            const start = parseInt(document.getElementById("rangeStart").value);
            const end = parseInt(document.getElementById("rangeEnd").value);
            
            if (isNaN(start) || isNaN(end)) {
                showModal("Please enter valid numbers for both start and end.");
                return;
            }
            
            if (start < 1 || end > TOTAL_TRACKS || start > end) {
                showModal(`Please enter a valid shlok range between 1 and ${TOTAL_TRACKS}.`);
                return;
            }
            
            document.querySelectorAll(".trackBox").forEach(cb => {
                const val = parseInt(cb.value, 10);
                const isChecked = val >= start && val <= end;
                cb.checked = isChecked;
                cb.closest("label").classList.toggle("selected", isChecked);
            });
            updateGroupButtonSelection();
            showToast(`Shlokas ${start}-${end} selected.`);
        }

        function toggleGroup(start, end, element) {
            const isSelected = !element.classList.contains('selected');
            element.classList.toggle('selected', isSelected);
            element.setAttribute('aria-pressed', isSelected.toString());
            for (let i = start; i <= end; i++) {
                const checkbox = document.querySelector(`.trackBox[value="${i}"]`);
                if (checkbox) {
                    checkbox.checked = isSelected;
                    checkbox.closest("label").classList.toggle("selected", isSelected);
                }
            }
            updateGroupButton
